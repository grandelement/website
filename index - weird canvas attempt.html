<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Grand Element • GE Studios</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="description" content="Grand Element • GE Studios • immersive music universe, interactive albums, and Grand Element Radio.">
<link rel="icon" type="image/png" href="https://grandelement.github.io/website/images/ge-favicon-planet.png">
<style>
:root{
  --starfield: url('https://grandelement.github.io/website/images/GE%20stars.jpg');
  --img-base: 'https://grandelement.github.io/website/images/';
  --font-body: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

  /* Layout */
  --padding-page: clamp(10px, 2vw, 20px);
  --z-bg: 0;
  --z-fx: 1;
  --z-planets: 3;
  --z-ui: 4;
  --z-about: 10;

  /* Planets */
  --planet-size: clamp(42px, 5vw, 64px);
  --planet-glow: 18px;

  /* Sun + Moon */
  --sun-size: 200px;
  --moon-size: 120px;
  --orbit-seconds: 60;
  --orbit-gap-moons: 2.2;
  --orbit-radius: calc((var(--sun-size) * 0.5) + (var(--moon-size) * var(--orbit-gap-moons)));

  /* FX */
  --comet-max: 3;

  /* Brand blues */
  --blue-sun: #6fb8ff;
  --blue-sun-text: #06121f;
}

/* “Mini” layout — roughly half-width */
@media (max-width: 780px){
  :root{
    --sun-size: 180px;
    --moon-size: 100px;
    --planet-size: 44px;
  }
}

*, *::before, *::after{ box-sizing:border-box; }

html, body{
  margin:0; padding:0;
  width:100%; height:100%;
}

body{
  font-family:var(--font-body);
  color:#eaf3ff;
  background:
    radial-gradient(circle at 50% 20%, rgba(110,184,255,0.16) 0%, rgba(0,0,0,0) 52%),
    #020615;
  background-image: var(--starfield), radial-gradient(circle at 50% 20%, rgba(110,184,255,0.16) 0%, rgba(0,0,0,0) 52%), url("data:image/svg+xml,%3Csvg viewBox='0 0 4 4' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='1' height='1' fill='%23091020'/%3E%3C/svg%3E");
  background-size:cover, auto, 3px 3px;
  background-attachment:fixed, scroll, scroll;
  background-position:center center, top center, 0 0;
  overflow:hidden;
}

/* FX canvas behind everything */
#fx{
  position:fixed;
  inset:0;
  z-index:var(--z-fx);
  pointer-events:auto;
}

/* Hidden text layer (phrases) */
.layer-hiddentext{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:var(--z-planets);
  mix-blend-mode:screen;
  font-size:11px;
  letter-spacing:.18em;
  text-transform:uppercase;
}
.layer-hiddentext .phrase{
  position:absolute;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(140,190,255,.6);
  background:radial-gradient(circle at 0 0, rgba(120,190,255,.35), rgba(6,16,35,.9));
  opacity:0;
  transform:translate(-50%,-50%) scale(.85);
  transition:opacity .4s ease, transform .4s ease;
  white-space:nowrap;
  pointer-events:auto;
  cursor:pointer;
}
.layer-hiddentext .phrase.show{
  opacity:1;
  transform:translate(-50%,-50%) scale(1);
}
.layer-hiddentext .phrase.pinned{
  border-color:rgba(255,255,255,.85);
  box-shadow:0 0 12px rgba(200,230,255,.8);
}

/* Top-right hud */
.hud{
  position:fixed;
  right:var(--padding-page);
  top:var(--padding-page);
  z-index:var(--z-ui);
  display:flex;
  gap:12px;
  align-items:center;
  font-size:13px;
}
.hud .pill{
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(140,190,255,.5);
  background:rgba(5,12,25,.8);
  text-transform:uppercase;
  letter-spacing:.16em;
  cursor:pointer;
}
.hud .pill span{
  opacity:.7;
}
.hud .pill strong{
  opacity:1;
}

/* Sun + moon block */
.sunWrap{
  position:absolute;
  left:18vw;
  top:64vh;
  transform:translate(-50%,-50%);
  width:var(--sun-size);
  height:var(--sun-size);
  pointer-events:auto;
  z-index:5;
  cursor:grab;
}
.sunWrap.dragging{ cursor:grabbing; }

.sun{
  position:absolute;
  inset:0;
  border-radius:50%;
  background:center/cover no-repeat url('https://grandelement.github.io/website/images/ge-logo-2.jpg');
  box-shadow:inset 0 0 60px rgba(255,255,255,.12);
  z-index:3;
  pointer-events:auto;
}

/* ABOUT at top of sun */
.sunOverlayTop{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap:8px;
  pointer-events:none;
  text-align:center;
  padding-top:8%;
}
.sunAbout{
  pointer-events:auto;
  font-weight:900;
  letter-spacing:.22em;
  font-size:13px;
  opacity:.95;
  text-shadow:0 0 14px rgba(150,190,255,.55);
  cursor:pointer;
}

/* Music HUD near bottom of the sun */
.sunHUD{
  position:absolute;
  left:50%;
  bottom:5%;
  transform:translate(-50%,0);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  pointer-events:none;
}
#nowPlaying{
  display:none !important;
}
.toggle{
  pointer-events:auto;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid rgba(220,240,255,.35);
  background:rgba(12,24,40,.6);
  cursor:pointer;
}
.toggle.active{
  background:rgba(40,140,255,.45);
}

/* Now Playing ticker (scroll inside pill when needed) */
.npTicker{ position:relative; display:block; white-space:nowrap; }
.npRun{ display:inline-block; padding-right:32px; }
.npAnim{ animation:np-marq 12s linear infinite; }
@keyframes np-marq{
  from{ transform:translateX(0); }
  to{ transform:translateX(-50%); }
}

/* Moon orbit container */
.orbit{
  position:absolute;
  inset:0;
  transform-origin:50% 50%;
  z-index:6;
  pointer-events:none;
}
.carrier{
  position:absolute;
  left:50%;
  top:50%;
  width:0;
  height:0;
}
.moon{
  position:absolute;
  left:0;
  top:0;
  transform:translate(var(--orbit-radius), -50%);
  width:var(--moon-size);
  height:var(--moon-size);
  border-radius:50%;
  pointer-events:none;
  display:grid;
  place-items:center;
}
.moon img{
  opacity:0;
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:50%;
  box-shadow:0 0 10px 4px rgba(140,200,255,.35);
  border:1px solid rgba(160,210,255,.55);
  background:radial-gradient(circle, rgba(160,210,255,.55) 0%, rgba(160,210,255,.25) 60%, rgba(160,210,255,0) 70%);
}

.overlay{
  position:fixed;
  inset:0;
  display:none;
  place-items:center;
  z-index:10;
}
.overlay.show{
  display:grid;
}
.overlay .panel{
  background:radial-gradient(circle at 0 0, rgba(120,190,255,.22), rgba(3,8,22,.98));
  border-radius:26px;
  padding:18px 18px 16px;
  max-width:min(630px, 92vw);
  max-height:90vh;
  border:1px solid rgba(180,210,255,.6);
  box-shadow:0 20px 80px rgba(0,0,0,.9);
  font-size:13px;
  line-height:1.5;
  position:relative;
}
.overlay h2{
  margin:0 0 8px;
  font-size:16px;
  letter-spacing:.16em;
  text-transform:uppercase;
}
.overlay p{
  margin:4px 0;
}
.overlay ul{
  margin:8px 0 0 18px;
  padding:0;
}
.overlay li{
  margin:2px 0;
}
.aboutClose{
  position:absolute;
  right:10px;
  top:10px;
  width:24px;
  height:24px;
  border-radius:50%;
  border:none;
  background:rgba(6,12,22,.6);
  color:#dbe7ff;
  cursor:pointer;
}
.aboutClose:hover{
  background:rgba(20,40,70,.9);
}
.aboutSection{
  margin-top:10px;
  padding-top:10px;
  border-top:1px solid rgba(120,160,220,.45);
}
.aboutSection h3{
  margin:0 0 4px;
  font-size:12px;
  letter-spacing:.18em;
  text-transform:uppercase;
}
.aboutSection .pill{
  display:inline-block;
  margin-top:4px;
  padding:2px 10px;
  border-radius:999px;
  border:1px solid rgba(150,190,255,.7);
  font-size:11px;
}
.aboutSection .sub{
  font-size:11px;
  opacity:.8;
}

/* Planets container */
.planets{
  position:fixed;
  inset:0;
  pointer-events:auto;
  z-index:var(--z-planets);
}
.planet{
  position:absolute;
  width:var(--planet-size);
  height:var(--planet-size);
  border-radius:50%;
  background-size:cover;
  background-position:center center;
  box-shadow:
    0 0 0 1px rgba(140,180,240,.65),
    0 0 var(--planet-glow) rgba(120,180,255,.5);
  cursor:pointer;
  transform:translate(-50%,-50%);
  display:flex;
  align-items:flex-end;
  justify-content:center;
  overflow:visible;
}
.planet .label{
  position:absolute;
  bottom:-18px;
  left:50%;
  transform:translateX(-50%);
  font-size:11px;
  white-space:nowrap;
  text-shadow:0 0 7px #000;
}
.planet--activeAlbum{
  box-shadow:
    0 0 0 1px rgba(220,240,255,.95),
    0 0 22px rgba(220,240,255,.98);
}
.planet.touchZoom{
  transform:translate(-50%,-50%) scale(1.2);
  z-index:9;
}

/* ABOUT: background controls pill */
#bgHelp{
  display:none;
  margin-top:4px;
  padding:6px 10px;
  border-radius:10px;
  background:rgba(2,8,22,.9);
  font-size:11px;
  border:1px solid rgba(120,160,220,.65);
}

/* MUSIC mini panel */
#mini{
  position:absolute;
  left:50%;
  bottom:16%;
  transform:translateX(-50%);
  padding:8px 10px 10px;
  border-radius:16px;
  background:rgba(4,8,20,.9);
  border:1px solid rgba(160,200,255,.6);
  box-shadow:0 10px 22px rgba(0,0,0,.92);
  width:min(380px, 82vw);
  color:#eaf3ff;
  font-size:12px;
  display:none;
}
#mini.show{ display:block; }
#mini .row{
  display:flex;
  align-items:center;
  gap:6px;
}
#mini .row + .row{
  margin-top:6px;
}
#mini .label{
  font-size:11px;
  opacity:.8;
}
#mini input[type=range]{
  flex:1;
}
#mini button{
  background:rgba(10,22,46,.96);
  border-radius:999px;
  border:1px solid rgba(150,190,255,.7);
  padding:4px 8px;
  font-size:11px;
  color:#eaf3ff;
  cursor:pointer;
}
#mini button.active{
  background:rgba(40,140,255,.6);
}
.miniPlayer > .row:first-of-type,
.miniPlayer > .controls:last-of-type{
  display:none !important;
}

/* Basic inputs */
input[type=range]{
  -webkit-appearance:none;
  appearance:none;
  height:4px;
  border-radius:999px;
  background:rgba(30,60,100,.9);
  outline:none;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  appearance:none;
  width:12px;
  height:12px;
  border-radius:50%;
  background:#cfe2ff;
  border:1px solid #7fb4ff;
  cursor:pointer;
}
input[type=range]::-moz-range-thumb{
  width:12px;
  height:12px;
  border-radius:50%;
  background:#cfe2ff;
  border:1px solid #7fb4ff;
  cursor:pointer;
}

/* Footer note */
.footerNote{
  position:fixed;
  left:var(--padding-page);
  bottom:var(--padding-page);
  font-size:11px;
  opacity:.8;
  z-index:var(--z-ui);
}

/* Mobile tweaks */
@media (max-width:600px){
  .sunWrap{
    left:50vw;
    top:58vh;
  }
  .footerNote{
    display:none;
  }
}
</style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="layer-hiddentext" id="phrases"></div>

  <!-- Sun + Moon -->
  <div class="sunWrap" id="sunWrap">
    <div class="sun" id="sun" title="ABOUT">
      <div class="sunOverlayTop">
        <div class="sunAbout" id="aboutBtn">ABOUT</div>
      </div>

      <!-- HUD near bottom of the sun -->
      <div class="sunHUD">
        <div id="nowPlaying">—</div>
        <div class="toggle" id="btnMusic">Music</div>
      </div>

      <!-- Mini music panel -->
      <div id="mini">
        <div class="miniPlayer">
          <div class="row">
            <span class="label" id="timeCur">0:00</span>
            <input type="range" id="seek" min="0" max="100" value="0">
            <span class="label" id="timeMax">0:00</span>
          </div>
          <div class="row controls">
            <button id="prev">Prev</button>
            <button id="play">Play</button>
            <button id="next">Next</button>
            <label style="display:flex; align-items:center; gap:4px;">
              <span class="label">Vol</span>
              <input type="range" id="vol" min="0" max="1" step="0.01" value="0.7">
            </label>
            <button id="mode">Album</button>
          </div>
          <div class="row">
            <span class="label">Mode:</span>
            <button id="btnShuffle" class="active">Shuffle</button>
            <button id="btnAlbum">Album Order</button>
          </div>
        </div>
        <audio id="gePlayer" preload="none"></audio>
      </div>
    </div>

    <!-- Orbiting moon (visual moved to canvas; this is now just structural) -->
    <div class="orbit" id="orbit">
      <div class="carrier">
        <div class="moon" id="moon" title="Grand Element Radio">
          <img alt="Grand Element Radio" src="https://grandelement.github.io/website/images/ge-radio-logo.png">
        </div>
      </div>
    </div>
  </div>

  <!-- Planets -->
  <div class="planets" id="planets"></div>

  <!-- ABOUT -->
  <div class="overlay" id="about">
    <button class="aboutClose" id="aboutClose" aria-label="Close">×</button>
    <div class="panel">
      <h2>Grand Element • GE Studios</h2>
      <p>Interactive album universe. Ships, comets, planets, and a radio moon all wired to the actual music.</p>

      <div class="aboutSection">
        <h3>How to interact</h3>
        <ul>
          <li><b>Sun</b>: Drag to reposition. Click “ABOUT” on the sun for this panel.</li>
          <li><b>Radio Moon</b>: Click the orbiting moon (near the sun) to open <em>Grand Element Radio</em> in a new tab.</li>
          <li><b>Music Pill</b>: Click “MUSIC” on the sun to open the mini player (this site music pauses when radio opens).</li>
          <li><b>Planets</b>: Click (no drag) → Bandcamp. Drag/throw → pool-ball physics.</li>
          <li><b>Ships</b>: Big ships will sometimes grab and beam comets toward the center.</li>
          <li><b>Hidden Text</b>: Click faint text when it appears to pin (proximity reveal + click to pin; Starfield dblclick = reveal-all moment).</li>
        </ul>
      </div>

      <div class="aboutSection">
        <h3>Backgrounds</h3>
        <p class="sub">Tap the sun to trigger the ripple and cycle through deep-space backgrounds.</p>
        <div class="pill"><span>Background Teleport</span></div>
        <div id="bgHelp">
          <p>Starfield is locked as a fixed background to avoid tearing on mobile. Ripple teleports only swap the deep-space layer.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="pill" id="hudStatus"><span>Status:</span> <strong>GE Universe Online</strong></div>
  </div>

  <!-- Footer note -->
  <div class="footerNote">
    Grand Element • GE Studios • interactive canvas • use headphones.
  </div>

<script>
/* =========== helpers ============== */
const IMG = getComputedStyle(document.documentElement).getPropertyValue('--img-base').trim() || 'https://grandelement.github.io/website/images/';
function normAlbumName(name){
  let s = String(name||'').replace(/\u00A0/g,' ').toLowerCase();
  s = s.replace(/grand\s*element\s*-\s*\d{4}\s*-\s*/, '');
  s = s.replace(/grand\s*element\s*-\s*/, '');
  return s.replace(/\s+/g,' ').trim();
}
function rand(min,max){ return Math.random()*(max-min)+min; }
function choice(a){ return a[(Math.random()*a.length)|0]; }
const MOBILE = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

/* Albums (planets) */
const ALBUMS = [
  { title:"Grand Element",       cover: IMG+"GE cover GRAND ELEMENT.jpg",       link:"https://grandelement.bandcamp.com/album/grand-element" },
  { title:"Supernova",          cover: IMG+"GE cover SUPERNOVA.jpg",          link:"https://grandelement.bandcamp.com/album/supernova" },
  { title:"Sessions I",         cover: IMG+"GE cover SESSIONS I.jpg",         link:"https://grandelement.bandcamp.com/album/sessions-i" },
  { title:"Sessions II",        cover: IMG+"GE cover SESSIONS II.jpg",        link:"https://grandelement.bandcamp.com/album/sessions-ii" },
  { title:"The Deepening",      cover: IMG+"GE cover THE DEEPENING.jpg",      link:"https://grandelement.bandcamp.com/album/the-deepening" },
  { title:"The 4th Phase",      cover: IMG+"GE cover THE 4th PHASE.jpg",      link:"https://grandelement.bandcamp.com/album/the-4th-phase" },
  { title:"Skyline",            cover: IMG+"GE cover SKYLINE.jpg",            link:"https://grandelement.bandcamp.com/album/skyline" },
  { title:"Aurora",             cover: IMG+"GE cover AURORA.jpg",             link:"https://grandelement.bandcamp.com/album/aurora" },
  { title:"Echoes of the Core", cover: IMG+"GE cover ECHOES OF THE CORE.jpg", link:"https://grandelement.bandcamp.com/album/echoes-of-the-core" },
  { title:"Live Elements",      cover: IMG+"GE cover LIVE ELEMENTS.jpg",      link:"https://grandelement.bandcamp.com/album/live-elements" }
];

/* ========= HIDDEN TEXT LAYER ========= */
(function(){
  const layer = document.getElementById('phrases');
  const URL_TXT = 'https://grandelement.github.io/website/data/hidden.txt';
  let PHRASES=[];
  fetch(URL_TXT).then(r=>r.ok?r.text():'').then(t=>{
    PHRASES = t.split(/[,\r?\n]/).map(s=>s.trim()).filter(Boolean);
    if(!PHRASES.length) PHRASES = [
      'you are the grand element','energy in motion','silence between notes',
      'frequency is the vehicle','listen inward','breathe the rhythm','love is the key',
      'soul remembers','spirit moves','fire awakens'
    ];
    scatter();
  });
  function scatter(){
    layer.innerHTML='';
    const w = innerWidth, h = innerHeight;
    const count = Math.min(PHRASES.length, 16);
    const used = new Set();
    for(let i=0;i<count;i++){
      let idx;
      do{ idx = (Math.random()*PHRASES.length)|0; }while(used.has(idx));
      used.add(idx);
      const text = PHRASES[idx];
      const el = document.createElement('div');
      el.className='phrase';
      el.textContent=text;
      const x = rand(10, w-10), y = rand(10, h-10);
      el.style.left = x+'px';
      el.style.top  = y+'px';
      el.addEventListener('click', e=>{
        e.stopPropagation();
        el.classList.toggle('pinned');
      });
      layer.appendChild(el);
    }
  }
  let revealTimer=null;
  document.getElementById('fx').addEventListener('pointermove', (e)=>{
    if(revealTimer) clearTimeout(revealTimer);
    const px=e.clientX, py=e.clientY;
    const r = Math.max(120, Math.min(260, Math.hypot(innerWidth,innerHeight)*0.08));
    revealTimer = setTimeout(()=>{
      const nodes=[...layer.children];
      if(!nodes.length) return;
      [...layer.children].forEach(el=>{
        if(el.classList.contains('pinned')){ el.classList.add('show'); return; }
        const rect=el.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
        const d=Math.hypot(px-cx,py-cy);
        if(d<r) el.classList.add('show'); else el.classList.remove('show');
      });
    }, 100);
  }, {passive:true});
  addEventListener('resize', ()=>requestAnimationFrame(scatter), {passive:true});

  // Double-click the canvas to reveal all temporarily
  const fx = document.getElementById('fx');
  fx.addEventListener('dblclick', ()=>{
    const nodes=[...layer.children];
    nodes.forEach(el=>el.classList.add('show'));
    setTimeout(()=>nodes.forEach(el=>{ if(!el.classList.contains('pinned')) el.classList.remove('show'); }), 4000);
  }, {passive:true});
})();

/* ========= ABOUT ========= */
document.getElementById('aboutBtn').addEventListener('click', ()=> document.getElementById('about').classList.add('show'));
document.getElementById('about').addEventListener('click', (e)=>{ if(e.target.id==='about') e.currentTarget.classList.remove('show'); });
addEventListener('keydown', (e)=>{ if(e.key==='Escape') document.getElementById('about').classList.remove('show'); });
document.getElementById('aboutClose').addEventListener('click', ()=> document.getElementById('about').classList.remove('show'));

// ABOUT: Background Controls toggle
(function(){
  const pill = document.querySelector('.aboutSection .pill');
  const panel = document.getElementById('bgHelp');
  if(pill && panel){
    pill.style.cursor='pointer';
    pill.addEventListener('click', ()=> panel.style.display = (panel.style.display==='none'||panel.style.display==='')?'block':'none');
  }
})();

/* ========= RADIO MOON — 60s orbit; pause site audio on click ========= */
const orbit = document.getElementById('orbit');
const moon  = document.getElementById('moon');
const ORBIT_SEC = 60, PHASE0 = -Math.PI/2;
const BASE_R = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--orbit-radius')) || 260;
const OSC_PX = 30, OSC_SEC = 90;
const MOON_SIZE = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--moon-size')) || 120;
const worldMoon = { x: innerWidth*0.5, y: innerHeight*0.3, r: MOON_SIZE/2 };

moon.addEventListener('click', ()=>{
  try{ document.getElementById('gePlayer')?.pause(); }catch(e){}
  window.open('https://grandelement.github.io/radio/','_blank','noopener');
});

/* ========= MUSIC (panel below button, fully interactive) ========= */
(function(){
  const mini   = document.getElementById('mini');
  const player = document.getElementById('gePlayer');
  const nowPlaying = document.getElementById('nowPlaying');
  const btnMusic = document.getElementById('btnMusic');

  const tCur = document.getElementById('timeCur');
  const tMax = document.getElementById('timeMax');
  const seek = document.getElementById('seek');
  const vol  = document.getElementById('vol');
  const btnPrev = document.getElementById('prev');
  const btnPlay = document.getElementById('play');
  const btnNext = document.getElementById('next');
  const btnMode = document.getElementById('mode');
  const btnShuffle = document.getElementById('btnShuffle');
  const btnAlbum   = document.getElementById('btnAlbum');

  let PLAYLIST=[], pIndex=0, SHUFFLE=true;
  const fmt=t=>{ t=t|0; const m=(t/60)|0, s=(t%60)|0; return `${m}:${s.toString().padStart(2,'0')}`; };
  const shuffleArr=a=>{ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } };

  function setTitle(it){
    const txt = it && it.track ? it.track : '—';
    nowPlaying.innerHTML = '';
    const probe = document.createElement('span');
    probe.textContent = txt;
    probe.style.visibility='hidden';
    probe.style.position='absolute';
    nowPlaying.appendChild(probe);
    const pillWidth = nowPlaying.offsetWidth || 140;
    const textWidth = probe.offsetWidth || 0;
    nowPlaying.innerHTML='';
    if(textWidth <= pillWidth){
      nowPlaying.textContent = txt;
    }else{
      const outer = document.createElement('span');
      outer.className='npTicker';
      const inner = document.createElement('span');
      inner.className='npRun npAnim';
      inner.textContent = txt + '   ';
      outer.appendChild(inner.cloneNode(true));
      outer.appendChild(inner);
      nowPlaying.appendChild(outer);
    }
  }

  function loadManifest(){
    fetch('https://grandelement.github.io/website/data/manifest.json?_=' + Date.now())
      .then(r=>r.ok?r.json():[])
      .then(list=>{
        if(!Array.isArray(list)) list=[];
        PLAYLIST = list;
        if(SHUFFLE) shuffleArr(PLAYLIST);
        pIndex = 0;
        if(PLAYLIST.length){
          loadTrack(PLAYLIST[pIndex], true);
        }
      })
      .catch(err=>{
        console.error('manifest load error', err);
      });
  }

  function highlightAlbum(albumName){
    if(!albumName) return;
    const key = normAlbumName(albumName);
    const el = albumPlanets[key];
    if(!el) return;
    for(const k in albumPlanets) albumPlanets[k].classList.remove('planet--activeAlbum');
    el.classList.add('planet--activeAlbum');
  }

  function loadTrack(it, autoPlay){
    if(!it) return;
    try{
      player.src = it.url;
      setTitle(it);
      if(autoPlay) player.play().catch(()=>{});
      tCur.textContent='0:00';
      tMax.textContent=fmt(it.dur||0);
      seek.value=0;
      if(it.album){
        highlightAlbum(it.album);
      }
    }catch(e){
      console.error(e);
    }
  }

  btnMusic.addEventListener('click', ()=>{
    const shown = mini.classList.toggle('show');
    btnMusic.classList.toggle('active', shown);
    if(shown && !PLAYLIST.length) loadManifest();
  });

  player.addEventListener('timeupdate', ()=>{
    const t = player.currentTime || 0;
    const d = player.duration || (PLAYLIST[pIndex]?.dur||0);
    tCur.textContent = fmt(t);
    tMax.textContent = fmt(d);
    if(d>0) seek.value = Math.min(100, Math.max(0, t/d*100));
  });

  player.addEventListener('ended', ()=>{
    if(!PLAYLIST.length) return;
    pIndex = (pIndex+1) % PLAYLIST.length;
    loadTrack(PLAYLIST[pIndex], true);
  });

  seek.addEventListener('input', ()=>{
    const d = player.duration || (PLAYLIST[pIndex]?.dur||0);
    const t = d * (seek.value/100);
    player.currentTime = t;
  });

  vol.addEventListener('input', ()=> player.volume = parseFloat(vol.value||'0.7'));

  btnPlay.addEventListener('click', ()=>{
    if(player.paused){
      player.play().catch(()=>{});
      btnPlay.textContent='Pause';
    }else{
      player.pause();
      btnPlay.textContent='Play';
    }
  });

  btnPrev.addEventListener('click', ()=>{
    if(!PLAYLIST.length) return;
    pIndex = (pIndex-1+PLAYLIST.length)%PLAYLIST.length;
    loadTrack(PLAYLIST[pIndex], true);
  });
  btnNext.addEventListener('click', ()=>{
    if(!PLAYLIST.length) return;
    pIndex = (pIndex+1)%PLAYLIST.length;
    loadTrack(PLAYLIST[pIndex], true);
  });

  btnMode.addEventListener('click', ()=>{
    SHUFFLE = !SHUFFLE;
    btnMode.textContent = SHUFFLE ? 'Album' : 'Shuffle';
  });

  btnShuffle.addEventListener('click', ()=>{
    SHUFFLE = true;
    btnShuffle.classList.add('active');
    btnAlbum.classList.remove('active');
    if(PLAYLIST.length){
      const current = PLAYLIST[pIndex];
      shuffleArr(PLAYLIST);
      pIndex = Math.max(0, PLAYLIST.indexOf(current));
    }
  });

  btnAlbum.addEventListener('click', ()=>{
    SHUFFLE = false;
    btnAlbum.classList.add('active');
    btnShuffle.classList.remove('active');
    fetch('https://grandelement.github.io/website/data/manifest.json?_=' + Date.now())
      .then(r=>r.ok?r.json():[])
      .then(list=>{
        if(!Array.isArray(list)) list=[];
        PLAYLIST = list;
        pIndex = 0;
        if(PLAYLIST.length){
          loadTrack(PLAYLIST[pIndex], false);
        }
      });
  });

  loadManifest();
})();

/* ========= PLANETS (DOM positions only; physics separate) ========= */
const planetsEl = document.getElementById('planets');
const albumPlanets = {};

function placeSpiral(){
  planetsEl.innerHTML="";
  const w = innerWidth, h = innerHeight;
  const xCenter = w * 0.56;
  const yBottom = h * 0.88;
  const yTop    = h * 0.14;
  const amp     = Math.max(80, w * 0.12);
  const waves   = 1.2;
  ALBUMS.forEach((alb,i)=>{
    const t = i/(ALBUMS.length-1);
    const y = yBottom - t*(yBottom - yTop);
    const x = xCenter + amp * Math.sin((t * Math.PI * 2 * waves) - Math.PI/2);
    const aEl = document.createElement('a');
    aEl.className='planet'; aEl.style.left=x+'px'; aEl.style.top=y+'px';
    aEl.href=alb.link; aEl.target='_blank'; aEl.rel='noopener'; aEl.title=alb.title;
    aEl.innerHTML = `<span class="label">${alb.title}</span>`;
    aEl.style.backgroundImage = `url('${alb.cover}')`;
    // register for album glow
    albumPlanets[normAlbumName(alb.title)] = aEl;
    // touch zoom
    aEl.addEventListener('touchstart', ()=> aEl.classList.add('touchZoom'), {passive:true});
    aEl.addEventListener('touchend',   ()=> aEl.classList.remove('touchZoom'), {passive:true});
    // click-vs-drag for desktop: prevent link if thrown
    let downPos=null, dragged=false;
    aEl.addEventListener('pointerdown',e=>{ downPos={x:e.clientX,y:e.clientY}; dragged=false; });
    aEl.addEventListener('pointermove',e=>{ if(!downPos) return; if(Math.hypot(e.clientX-downPos.x, e.clientY-downPos.y)>6) dragged=true; });
    aEl.addEventListener('click',e=>{ if(dragged){ e.preventDefault(); e.stopPropagation(); } });
    planetsEl.appendChild(aEl);
  });
}
placeSpiral(); addEventListener('resize', placeSpiral, {passive:true});

/* ========= FX CANVAS ========= */
const canvas = document.getElementById('fx'), ctx = canvas.getContext('2d');
let W=innerWidth,H=innerHeight;
function resize(){ W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H; }
addEventListener('resize', resize, {passive:true}); resize();

const cometImg = new Image(); cometImg.src=IMG+'ge-logo%203.png';
const shipImg  = new Image(); shipImg.src=IMG+'ge-logo-4-cutout.png';
const moonImg  = new Image(); moonImg.src = IMG+'ge-radio-logo.png';

/* Adaptive performance guardrails */
const PERF = {dt:0.016, heat:0, targetFPS:60};
function perfHeat(dt){
  const target=1/PERF.targetFPS;
  PERF.heat = Math.max(0, Math.min(1, PERF.heat + (dt-target)*3));
}

/* Star-network — dense net + two cue-balls (blue/red) */
const NET = { pts:[], links:64, r:36, mini:[] };
(function initNet(){
  const base = Math.round(Math.min(180, (innerWidth*innerHeight)/28000));
  let count = base*5;                 // ~5× density
  if (innerWidth < 700) count = Math.max(120, Math.round(count*0.4));
  NET.pts = Array.from({length:count}, ()=>({
    x:Math.random()*W, y:Math.random()*H,
    vx:(Math.random()-.5)*0.06, vy:(Math.random()-.5)*0.06
  }));
  // EXACTLY one blue + one red cue-ball
  NET.mini = [
    { x:Math.random()*W, y:Math.random()*H, r:12, color:'blue', dragging:false, vx:rand(-20,20), vy:rand(-20,20) },
    { x:Math.random()*W, y:Math.random()*H, r:12, color:'red',  dragging:false, vx:rand(-20,20), vy:rand(-20,20) }
  ];
})();
let dragMini=null, miniHist=[];
canvas.addEventListener('pointerdown', e=>{
  for(const m of NET.mini){
    if(Math.hypot(e.clientX-m.x,e.clientY-m.y)<m.r+8){
      dragMini=m; dragMini.dragging=true;
      miniHist=[{x:e.clientX,y:e.clientY,t:performance.now()}]; e.preventDefault(); return;
    }
  }
},{passive:false});
canvas.addEventListener('pointermove', e=>{
  if(!dragMini) return;
  dragMini.x=e.clientX; dragMini.y=e.clientY;
  const now=performance.now();
  miniHist.push({x:e.clientX,y:e.clientY,t:now}); while(miniHist.length && now-miniHist[0].t>160) miniHist.shift();

  // Cue-ball effect while dragging: collide with planets and comets
  if (window.planetNodes){
    for (const p of planetNodes){
      collideElastic(dragMini, {x:p.x, y:p.y, r:p.r, vx:p.vx||0, vy:p.vy||0}, 0.98);
    }
  }
  for (const c of comets){
    collideElastic(dragMini, c, 0.96);
  }
},{passive:true});
canvas.addEventListener('pointerup', e=>{
  if(!dragMini) return;
  const now=performance.now();
  const last=miniHist[miniHist.length-1]||{x:dragMini.x,y:dragMini.y,t:now};
  const first=miniHist[0]||last;
  const dt=Math.max(16,last.t-first.t);
  dragMini.vx=(last.x-first.x)/dt*900;
  dragMini.vy=(last.y-first.y)/dt*900;
  dragMini.dragging=false;
  dragMini=null;
});

/* Net step + draw */
function netStepDraw(dt){
  const linkMult = 1 - PERF.heat*0.6;
  const speedMult = 1 + PERF.heat*1.4;

  for(const p of NET.pts){
    p.x+=p.vx*speedMult; p.y+=p.vy*speedMult;
    if(p.x<-40)p.x=W+40;
    if(p.x>W+40)p.x=-40;
    if(p.y<-40)p.y=H+40;
    if(p.y>H+40)p.y=-40;
  }

  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.strokeStyle = '#9ec8ff'; ctx.lineWidth=1;
  const r2 = (NET.r*NET.r) * (1+PERF.heat*0.8);
  for(const a of NET.pts){
    let links=0, maxLinks = Math.round(NET.links*linkMult);
    for(const b of NET.pts){
      if(a===b) continue;
      const dx=a.x-b.x, dy=a.y-b.y, d2=dx*dx+dy*dy;
      if(d2 < r2){
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        if(++links>maxLinks) break;
      }
    }
  }
  ctx.globalAlpha = 0.7; ctx.fillStyle='#cfe9ff';
  for(const p of NET.pts){ ctx.beginPath(); ctx.arc(p.x,p.y,0.7,0,Math.PI*2); ctx.fill(); }

  // mini blue/red cue-balls
  for(const m of NET.mini){
    if(!m.dragging){ m.x+=m.vx*dt; m.y+=m.vy*dt; m.vx*=0.995; m.vy*=0.995; }
    if(m.x<-40)m.x=W+40; if(m.x>W+40)m.x=-40; if(m.y<-40)m.y=H+40; if(m.y>H+40)m.y=-40;

    const tint = (m.color==='red') ? 'rgba(255,120,120,0.9)' : 'rgba(120,190,255,0.9)';
    const aura = (m.color==='red') ? 'rgba(255,120,120,0)'   : 'rgba(120,190,255,0)';
    const grd = ctx.createRadialGradient(m.x,m.y,2, m.x,m.y,m.r+10);
    grd.addColorStop(0, tint); grd.addColorStop(1, aura);
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(m.x,m.y,m.r+10,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = (m.color==='red') ? '#ff6b6b' : '#6fb8ff';
    ctx.beginPath(); ctx.arc(m.x,m.y,m.r,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

/* Comets, ships, miniShips */
const COMET = {max: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--comet-max'))||3, trail:26, fade:1200, spawn:[4,9], sizes:[22,28,32], speed:[36,72], touch:42};

class Comet{
  constructor(){
    const edge=choice(['l','r','t','b']), pad=40;
    if(edge==='l'){this.x=-pad; this.y=rand(0,H);}
    if(edge==='r'){this.x=W+pad; this.y=rand(0,H);}
    if(edge==='t'){this.x=rand(0,W); this.y=-pad;}
    if(edge==='b'){this.x=rand(0,W); this.y=H+pad;}
    const tx=rand(W*.2,W*.8), ty=rand(H*.2,H*.8);
    const a=Math.atan2(ty-this.y, tx-this.x), s=rand(...COMET.speed);
    this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s; this.r=choice(COMET.sizes);
    this.trail=[]; this.state='fly'; this.dead=false; this.dragging=false;
  }
  step(dt){
    if(!this.dragging){ this.x+=this.vx*dt; this.y+=this.vy*dt; }
    this.trail.push([this.x,this.y,performance.now()]); if(this.trail.length>COMET.trail) this.trail.shift();
    if(this.x<-140||this.x>W+140||this.y<-140||this.y>H+140) this.dead=true;
  }
  draw(){
    while(this.trail.length && performance.now()-this.trail[0][2] > 2500) this.trail.shift();
    for(const [tx,ty,ts] of this.trail){
      const a=Math.max(0,1-(performance.now()-ts)/COMET.fade);
      if(a<=0) continue;
      ctx.save();
      ctx.globalAlpha=a*0.28;
      ctx.beginPath();
      ctx.arc(tx,ty,this.r*1.4,0,Math.PI*2);
      ctx.fillStyle='rgba(180,220,255,0.85)';
      ctx.fill();
      ctx.restore();
    }

    if(!cometImg.complete) return;
    ctx.save();
    ctx.globalAlpha = 0.96;
    const s = this.r/40;
    const w = cometImg.width * s, h = cometImg.height * s;
    ctx.translate(this.x,this.y);
    ctx.rotate(Math.atan2(this.vy,this.vx)+Math.PI/2);
    ctx.drawImage(cometImg, -w/2, -h/2, w, h);
    ctx.restore();
  }
}

class Pair{
  constructor(a,b){
    this.a=a; this.b=b; this.t=0; this.dead=false;
  }
  step(dt){
    this.t+=dt;
    if(this.t>2){ this.dead=true; this.a.dead=true; this.b.dead=true; }
  }
  draw(){
    const t=this.t/2;
    const alpha = Math.max(0,1-t);
    if(alpha<=0) return;
    ctx.save();
    ctx.globalAlpha=alpha*0.9;
    ctx.strokeStyle='rgba(210,240,255,.9)';
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(this.a.x,this.a.y);
    ctx.lineTo(this.b.x,this.b.y);
    ctx.stroke();
    ctx.restore();
  }
}

class Ship{
  constructor(){
    const side=choice(['l','r','t','b']), pad=60;
    if(side==='l'){ this.x=-pad; this.y=rand(0,H); this.vx=rand(25,60); this.vy=rand(-20,20);}
    if(side==='r'){ this.x=W+pad; this.y=rand(0,H); this.vx=rand(-60,-25); this.vy=rand(-20,20);}
    if(side==='t'){ this.x=rand(0,W); this.y=-pad; this.vx=rand(-25,25); this.vy=rand(25,60);}
    if(side==='b'){ this.x=rand(0,W); this.y=H+pad; this.vx=rand(-25,25); this.vy=rand(-60,-25);}
    this.s=rand(.7,1.1);
    this.dead=false;
    this.beam=0;
    this.targets=[];
    this.forceBeamUntil=0;
  }
  step(dt){
    this.x+=this.vx*dt; this.y+=this.vy*dt;
    if(this.x<-200||this.x>W+200||this.y<-200||this.y>H+200) this.dead=true;
    const near=[];
    for(const c of comets){
      if(c.state!=='fly') continue;
      const d=Math.hypot(c.x-this.x,c.y-this.y);
      if(d<260) near.push(c);
    }
    if(near.length){
      this.beam = Math.min(1, this.beam + dt*1.5);
      this.targets = near;
    }else{
      this.beam = Math.max(0, this.beam - dt*1.5);
      if(this.beam===0) this.targets=[];
    }

    if(this.beam>0 && this.targets.length){
      const cx = W*0.5, cy = H*0.5;
      for(const c of this.targets){
        const dx=c.x-cx, dy=c.y-cy, d=Math.hypot(dx,dy)||1;
        const pull=40*dt*(1-PERF.heat*0.4);
        c.vx -= (dx/d)*pull;
        c.vy -= (dy/d)*pull;
      }
      const until = performance.now()+2200;
      nearest.forceBeamUntil = until;
      if (typeof nearest.captureNextComet === 'function') nearest.captureNextComet();
    }
  }
  draw(){
    if(!shipImg.complete) return;
    ctx.save(); ctx.globalAlpha=.45;
    const ang=Math.atan2(this.vy,this.vx)+Math.PI;
    const w=shipImg.width*this.s, h=shipImg.height*this.s;
    ctx.translate(this.x,this.y); ctx.rotate(ang);
    ctx.drawImage(shipImg,-w*0.3,-h*0.5,w*0.6,h*0.6);
    if(this.beam>0 && this.targets.length){
      for(const c of this.targets){
        const mx=c.x - this.x, my=c.y - this.y, len=Math.hypot(mx,my);
        ctx.save(); ctx.rotate(Math.atan2(my,mx));
        ctx.globalAlpha = 0.6;
        ctx.strokeStyle='rgba(126,203,255,.85)'; ctx.lineWidth=1.5;
        ctx.beginPath();
        for(let i=0;i<=len;i+=7){
          const offset = Math.sin((performance.now()/160)+i*0.08)*2.2;
          ctx.lineTo(i, offset);
        }
        ctx.stroke();
        ctx.restore();
      }
    }
    ctx.restore();
  }
}

class MiniShip{
  constructor(){
    this.x=rand(40,W-40);
    this.y=rand(40,H-40);
    this.vx=rand(-30,30);
    this.vy=rand(-30,30);
    this.r=16;
    this.dead=false;
  }
  step(dt){
    this.x+=this.vx*dt; this.y+=this.vy*dt;
    if(this.x<this.r||this.x>W-this.r) this.vx*=-1;
    if(this.y<this.r||this.y>H-this.r) this.vy*=-1;
  }
  draw(){
    ctx.save();
    ctx.globalAlpha=0.5;
    const g = ctx.createRadialGradient(this.x,this.y,2, this.x,this.y,this.r+8);
    g.addColorStop(0,'rgba(140,210,255,.95)');
    g.addColorStop(1,'rgba(140,210,255,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(this.x,this.y,this.r+8,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
}

const comets=[], pairs=[], ships=[], miniShips=[];
let last=performance.now()/1000, cTimer=0, cNext=rand(4,9), shipTimer=0, shipNext=rand(10,20), miniTimer=0, miniNext=rand(4,9);
let RUN=true; document.addEventListener('visibilitychange', ()=>{ RUN=!document.hidden; });

/* Ripple teleport + backgrounds */
const rp=document.createElement('canvas'); Object.assign(rp.style,{position:'fixed',inset:'0',zIndex:999,pointerEvents:'none'}); document.body.appendChild(rp);
const rpx=rp.getContext('2d');
function fitRP(){ rp.width=innerWidth; rp.height=innerHeight; }
addEventListener('resize', fitRP, {passive:true}); fitRP();
const BG_LIST = [
  'GE stars.jpg','original.jpg','Classifying-stars-by-colour.jpg','DMMRcwZX4AAoqRU.jpg','DN6jpqnXkAAGhbf.jpg',
  'AME3n86.jpg','andromeda-galaxy-space-stars.jpg','antimatter-explosion.jpg','core collapse supernova.jpg',
  'galaxy-starry-sky.jpg','milky-way-night-panorama.jpg','MZ6nMgorXde5H.png','nebula_cropped.jpg',
  'new-horizons-pluto.jpg','orion-nebula.jpg','rosette-nebula.jpg','spiral-galaxy.jpg','star-clusters.jpg',
  'starfield-long-exposure.jpg','supernova-remnant.jpg','V8L4WRF.jpg','westerlund-2.jpg',
  'Young-star-cluster-and-reflection-nebula-NGC-1333.jpg','zeta-ophiuchi.jpg','Hubble_Interacting_Galaxy_Arp_273.jpg',
  'Hubble_ultra_deep_field.jpg','ESA_Hubble_Tarantula_Nebula.jpg','M16_Pillars_of_Creation.jpg',
  'Cosmic-web-simulation.jpg','JWST_deep_field.jpg','JWST_Carina_Nebula.jpg','NGC_1300_barred_spiral_galaxy.jpg',
  'Horsehead_Nebula.jpg','Sombrero_Galaxy.jpg','Cartwheel_Galaxy.jpg','Eagle_Nebula.jpg',
  'Triangulum_Galaxy.jpg','Lagoon_Nebula.jpg','Ring_Nebula.jpg','Crab_Nebula.jpg','Omega_Nebula.jpg',
  'Helix_Nebula.jpg','Eta_Carinae_Nebula.jpg','Spiral_Galaxy_M51.jpg','Andromeda_wide.jpg',
  'Milky_Way_core.jpg','Deep_space_cluster.jpg','NGC_4414_flocculent_spiral_galaxy.jpg',
  'M101_Pinwheel_Galaxy.jpg','M33_Triangulum_Galaxy_detail.jpg','IC_2944_Running_Chicken_Nebula.jpg',
  'Dark_Nebula_Barnard_68.jpg','Galaxy_cluster_Abell_1689.jpg','Lenticular_galaxy_NGC_2787.jpg',
  'Star_forming_region_RCW_38.jpg','Wide_field_Milky_Way.jpg','Dust_lanes_in_spiral_galaxy.jpg',
  'Ultra_deep_cluster_view.jpg','Blue_supergiant_star.jpg','Red_supergiant_star.jpg','Binary_star_system.jpg',
  'Globular_cluster_M13.jpg','Open_cluster_Pleiades.jpg','Emission_nebula_detail.jpg','Reflection_nebula_detail.jpg',
  'Dark_molecular_cloud.jpg','Protostar_disk.jpg','Supernova_shock_front.jpg','Quasar_core.jpg',
  'Radio_galaxy_jets.jpg','Magellanic_Clouds_wide.jpg','Galaxy_merger_sequence.jpg','NGC_1309_spiral_galaxy.jpg',
  'Sun_corona_eclipse.jpg','Solar_prominence_detail.jpg','Aurora_borealis_over_mountains.jpg',
  'Meteor_shower_long_exposure.jpg','Wide_field_star_trails.jpg','Edge_on_spiral_galaxy.jpg',
  'Galaxy_with_warped_disk.jpg','Double_cluster_in_Perseus.jpg','HII_region_detail.jpg',
  'Planetary_nebula_rings.jpg','Stellar_nursery_pillars.jpg','Cosmic_filament_structure.jpg',
  '3-body-star-system.jpg','Core-collapse_supernova_remnant.jpg','Young_star_cluster_detail.jpg',
  'Multiwavelength_galaxy_composite.jpg','Interstellar_dust_cloud.jpg','Wide_field_cosmic_web.jpg',
  'Galaxy_group_Stephans_Quintet.jpg','Distant_quasar_field.jpg'
].map(n=> `${IMG}stars backgrounds/${encodeURI(n.replace(/\s+/g,' '))}`);
let bgIndex=0;
function setBG(i){
  const url = BG_LIST[(i%BG_LIST.length+BG_LIST.length)%BG_LIST.length];
  const testImg = new Image();
  testImg.onload = ()=>{
    document.body.style.backgroundImage =
      `url("${url}") , radial-gradient(circle at 50% 20%, rgba(110,184,255,0.16) 0%, rgba(0,0,0,0) 52%), url("data:image/svg+xml,%3Csvg viewBox='0 0 4 4' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='1' height='1' fill='%23091020'/%3E%3C/svg%3E")`;
    document.body.style.backgroundAttachment = 'fixed, scroll, scroll';
    document.body.style.backgroundPosition   = 'center center, top center, 0 0';
    document.body.style.backgroundRepeat     = 'no-repeat, repeat';
    document.body.style.backgroundSize       = 'cover, auto, 3px 3px';
  };
  testImg.src = url;
}
setBG(bgIndex);
function rippleAndNext(x,y){
  const start=performance.now(), dur=1200, D=Math.hypot(innerWidth,innerHeight);
  function draw(now){
    const t=Math.min(1,(now-start)/dur);
    rpx.clearRect(0,0,innerWidth,innerHeight);
    for(let k=0;k<3;k++){
      const tt=Math.max(0,t-k*0.12);
      rpx.globalAlpha=0.28*(1-tt);
      rpx.beginPath(); rpx.arc(x,y, D*tt, 0, Math.PI*2);
      rpx.lineWidth=4*(1-tt)+1; rpx.strokeStyle='rgba(120,180,255,0.85)'; rpx.stroke();
    }
    if(t<1) requestAnimationFrame(draw);
    else { rpx.clearRect(0,0,innerWidth,innerHeight); bgIndex=(bgIndex+1)%BG_LIST.length; setBG(bgIndex); }
  }
  requestAnimationFrame(draw);
}

/* Elastic collisions (equal mass) */
function collideElastic(a,b,rest=0.98){
  const dx=a.x-b.x, dy=a.y-b.y, dist=Math.hypot(dx,dy) || 1;
  const R=(a.r||10) + (b.r||10);
  if(dist>=R) return;
  const nx=dx/dist, ny=dy/dist, overlap=R-dist+0.5;
  a.x+=nx*overlap*0.5; a.y+=ny*overlap*0.5;
  b.x-=nx*overlap*0.5; b.y-=ny*overlap*0.5;
  const dvx=a.vx-b.vx, dvy=a.vy-b.vy;
  const vn = dvx*nx + dvy*ny;
  if(vn>0) return;
  const impulse = -(1+rest)*vn*0.5;
  a.vx += impulse*nx; a.vy += impulse*ny;
  b.vx -= impulse*nx; b.vy -= impulse*ny;
}

/* Drag & throw for comets */
let drag={obj:null,kind:null,hist:[]};
function nearestPick(x,y){
  let best=null,bestD=1e9,kind=null;
  for(const c of comets){
    const R=Math.max(18,(c.r||8)*2);
    const d=Math.hypot(x-c.x,y-c.y);
    if(d<R && d<bestD){ best=c; bestD=d; kind='comet'; }
  }
  return {obj:best,kind};
}
canvas.addEventListener('pointerdown', (e)=>{
  const {obj,kind}=nearestPick(e.clientX,e.clientY);
  if(!obj) return;
  drag={obj,kind,hist:[{x:e.clientX,y:e.clientY,t:performance.now()}]};
  obj.dragging=true; obj.x=e.clientX; obj.y=e.clientY;
  e.target.setPointerCapture && e.target.setPointerCapture(e.pointerId);
  e.preventDefault();
},{passive:false});
canvas.addEventListener('pointermove', (e)=>{
  if(!drag.obj) return;
  drag.obj.x=e.clientX; drag.obj.y=e.clientY;
  const now=performance.now();
  drag.hist.push({x:e.clientX,y:e.clientY,t:now}); while(drag.hist.length && now-drag.hist[0].t>160) drag.hist.shift();
},{passive:true});
canvas.addEventListener('pointerup', (e)=>{
  if(!drag.obj) return;
  const now=performance.now();
  const last=drag.hist[drag.hist.length-1]||{x:drag.obj.x,y:drag.obj.y,t:now};
  let ref=drag.hist[0]||last;
  for(let i=drag.hist.length-1;i>=0;i--) if(now-drag.hist[i].t>=60){ ref=drag.hist[i]; break; }
  const dt=Math.max(16,last.t-ref.t);
  const obj=drag.obj;
  obj.vx=(last.x-ref.x)/dt*900;
  obj.vy=(last.y-ref.y)/dt*900;
  obj.dragging=false;
  drag={obj:null,kind:null,hist:[]};
});

/* Main loop */
const MAX_SHIPS   = MOBILE ? 1 : 2;
const MINI_MAX    = MOBILE ? 10 : 20;
function loop(){
  if(!RUN){ requestAnimationFrame(loop); return; }
  const now=performance.now()/1000, dt=Math.min(.05, now-last); last=now; PERF.dt=dt; perfHeat(dt);

  const hot = PERF.heat>0.6;
  const wantComets = hot ? Math.max(1, COMET.max-1) : COMET.max;
  const wantShips  = hot ? Math.max(1, MAX_SHIPS-1) : MAX_SHIPS;
  const wantMini   = hot ? Math.max(6, MINI_MAX-6) : MINI_MAX;

  cTimer+=dt; if(cTimer>cNext && comets.length<wantComets){ comets.push(new Comet()); cTimer=0; cNext=rand(...COMET.spawn); }
  shipTimer+=dt; if(shipTimer>shipNext){ shipTimer=0; shipNext=rand(7,14); if(ships.length<wantShips) ships.push(new Ship()); }
  miniTimer+=dt; if(miniTimer>miniNext){ miniTimer=0; miniNext=rand(4,9); if(miniShips.length<wantMini) miniShips.push(new MiniShip()); }

  comets.forEach(c=>c.step(dt));
  ships.forEach(s=>s.step(dt));
  pairs.forEach(p=>p.step(dt));
  miniShips.forEach(s=>s.step(dt));

  for(let i=0;i<comets.length;i++){
    for(let j=i+1;j<comets.length;j++){
      const a=comets[i], b=comets[j];
      if(a.state==='pair'||b.state==='pair') continue;
      collideElastic(a,b,0.96);
    }
  }
  const sunRect=document.getElementById('sunWrap')?.getBoundingClientRect();
  const sx=sunRect?sunRect.left+sunRect.width/2:innerWidth*0.5;
  const sy=sunRect?sunRect.top+sunRect.width/2:innerHeight*0.5;
  const sr=sunRect?sunRect.width/2:0;

  // update canvas moon orbit around the sun center
  {
    const tOrbit = now;
    const angle = PHASE0 + (tOrbit % ORBIT_SEC) / ORBIT_SEC * Math.PI*2;
    const r = BASE_R + OSC_PX * Math.sin((tOrbit/OSC_SEC)*Math.PI*2);
    worldMoon.x = sx + Math.cos(angle)*r;
    worldMoon.y = sy + Math.sin(angle)*r;
    if(!worldMoon.r) worldMoon.r = MOON_SIZE/2;
  }

  for(const c of comets){
    if(c.dragging) continue;
    if (window.planetNodes) { for (const p of planetNodes) collideElastic(c, {x:p.x, y:p.y, r:p.r,vx:0,vy:0}, 0.95); }
    if(sr) collideElastic(c,{x:sx,y:sy,r:sr},0.95);
    if(worldMoon.r) collideElastic(c,{x:worldMoon.x,y:worldMoon.y,r:worldMoon.r},0.95);
  }

  for(let i=0;i<comets.length;i++)
    for(let j=i+1;j<comets.length;j++){
      const a=comets[i], b=comets[j];
      if(a.state!=='fly'||b.state!=='fly') continue;
      if(Math.hypot(a.x-b.x) < COMET.touch){
        a.state='pair'; b.state='pair'; pairs.push(new Pair(a,b));
      }
    }

  for(let i=comets.length-1;i>=0;i--) if(comets[i].dead) comets.splice(i,1);
  for(let i=pairs.length-1;i>=0;i--) if(pairs[i].dead) pairs.splice(i,1);
  for(let i=ships.length-1;i>=0;i--) if(ships[i].dead) ships.splice(i,1);
  for(let i=miniShips.length-1;i>=0;i--) if(miniShips[i].dead) miniShips.splice(i,1);

  ctx.clearRect(0,0,W,H);
  netStepDraw(dt);

  // draw radio moon in canvas
  if (moonImg.complete && worldMoon && worldMoon.r){
    ctx.save();
    const r = worldMoon.r;
    const gx = worldMoon.x;
    const gy = worldMoon.y;
    const halo = ctx.createRadialGradient(gx,gy,r*0.2,gx,gy,r*1.4);
    halo.addColorStop(0,'rgba(160,210,255,0.9)');
    halo.addColorStop(1,'rgba(160,210,255,0)');
    ctx.fillStyle = halo;
    ctx.beginPath();
    ctx.arc(gx,gy,r*1.4,0,Math.PI*2);
    ctx.fill();

    ctx.save();
    ctx.beginPath();
    ctx.arc(gx,gy,r,0,Math.PI*2);
    ctx.clip();
    ctx.drawImage(moonImg, gx-r, gy-r, r*2, r*2);
    ctx.restore();
    ctx.restore();
  }

  pairs.forEach(p=>p.draw());
  comets.forEach(c=>c.draw());
  miniShips.forEach(s=>s.draw());
  ships.forEach(s=>s.draw());

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Sun dragging */
(function enableDragSun(){
  const wrap = document.getElementById('sunWrap');
  let dragging=false, dx=0, dy=0, moved=false;
  wrap.addEventListener('pointerdown', (e)=>{
    dragging=true; moved=false; wrap.classList.add('dragging');
    const rect=wrap.getBoundingClientRect();
    dx=e.clientX-rect.left; dy=e.clientY-rect.top;
    e.preventDefault();
  }, {passive:false});
  addEventListener('pointermove', (e)=>{
    if(!dragging) return; moved=true;
    const w=wrap.offsetWidth, h=wrap.offsetHeight;
    const keep=0.7;
    let L=e.clientX-dx, T=e.clientY-dy;
    const minL = -w*(1-keep);
    const maxL = innerWidth - w*keep;
    const minT = -h*(1-keep);
    const maxT = innerHeight - h*keep;
    L=Math.max(minL, Math.min(maxL, L));
    T=Math.max(minT, Math.min(maxT, T));
    wrap.style.left = (L + w/2) + 'px';
    wrap.style.top  = (T + h/2) + 'px';
    wrap.style.transform='translate(-50%,-50%)';
  }, {passive:true});
  addEventListener('pointerup', (e)=>{
    if(dragging && !moved){
      const rect=wrap.getBoundingClientRect();
      rippleAndNext(rect.left+rect.width/2, rect.top+rect.height/2);
    }
    dragging=false; wrap.classList.remove('dragging');
  }, {passive:true});
})();

/* PLANET PHYSICS */
const planetNodes = [];
function buildPlanetPhysics(){
  planetNodes.length=0;
  [...document.querySelectorAll('.planet')].forEach(el=>{
    const rect = el.getBoundingClientRect();
    const size = rect.width || parseFloat(getComputedStyle(el).width) || 35;
    planetNodes.push({ el, x:rect.left + size/2, y:rect.top + size/2, r:size/2, vx:0, vy:0, dragging:false });
  });
}
buildPlanetPhysics(); addEventListener('resize', ()=>requestAnimationFrame(buildPlanetPhysics), {passive:true});

let pDrag=null, pHist=[];
document.getElementById('planets').addEventListener('pointerdown', (e)=>{
  const el = e.target.closest('.planet'); if(!el) return;
  const p = planetNodes.find(pp=>pp.el===el); if(!p) return;
  pDrag=p; pDrag.dragging=true; pHist=[{x:e.clientX,y:e.clientY,t:performance.now()}]; e.preventDefault();
},{passive:false});
addEventListener('pointermove', (e)=>{
  if(!pDrag) return;
  pDrag.x=e.clientX; pDrag.y=e.clientY;
  pDrag.el.style.left=(pDrag.x - pDrag.r)+'px';
  pDrag.el.style.top=(pDrag.y - pDrag.r)+'px';
  const now=performance.now(); pHist.push({x:e.clientX,y:e.clientY,t:now}); while(pHist.length && now-pHist[0].t>160) pHist.shift();
},{passive:true});
addEventListener('pointerup', (e)=>{
  if(!pDrag) return;
  const now=performance.now(); const last=pHist[pHist.length-1]||{x:pDrag.x,y:pDrag.y,t:now}; let ref=pHist[0]||last;
  for(let i=pHist.length-1;i>=0;i--) if(now-pHist[i].t>=60){ ref=pHist[i]; break; }
  const dt=Math.max(16,last.t-ref.t);
  pDrag.vx=(last.x-ref.x)/dt*900; pDrag.vy=(last.y-ref.y)/dt*900;
  pDrag.dragging=false; pDrag=null;
});

function planetStep(){
  const sunRect  = document.getElementById('sunWrap')?.getBoundingClientRect();
  const moonRect = document.querySelector('.moon')?.getBoundingClientRect();
  const sx=sunRect?sunRect.left+sunRect.width/2:0, sy=sunRect?sunRect.top+sunRect.width/2:0, sr=sunRect?sunRect.width/2:0;
  const mx=moonRect?moonRect.left+moonRect.width/2:0, my=moonRect?moonRect.top+moonRect.width/2:0, mr=moonRect?moonRect.width/2:0;

  for(const p of planetNodes){
    if(p.dragging) continue;
    p.x+=p.vx*(1/60); p.y+=p.vy*(1/60);
    p.vx*=0.985; p.vy*=0.985; if(Math.hypot(p.vx,p.vy)<5){ p.vx=0; p.vy=0; }

    if(p.x-p.r<0){ p.x=p.r; p.vx=Math.abs(p.vx)*0.98; }
    if(p.x+p.r>innerWidth){ p.x=innerWidth-p.r; p.vx=-Math.abs(p.vx)*0.98; }
    if(p.y-p.r<0){ p.y=p.r; p.vy=Math.abs(p.vy)*0.98; }
    if(p.y+p.r>innerHeight){ p.y=innerHeight-p.r; p.vy=-Math.abs(p.vy)*0.98; }

    if(sr) collideElastic(p,{x:sx,y:sy,r:sr},0.98);
    if(mr) collideElastic(p,{x:mx,y:my,r:mr},0.98);

    p.el.style.left=(p.x-p.r)+'px'; p.el.style.top=(p.y-p.r)+'px';
  }
  for(const p of planetNodes){
    for(const q of planetNodes){
      if(p===q) continue;
      collideElastic(p,q,0.98);
    }
  }
  requestAnimationFrame(planetStep);
}
planetStep();

/* Keep Sun placed reasonably on first load */
function nudgeSunNow(){
  const wrap=document.getElementById('sunWrap');
  const w=wrap.offsetWidth, h=wrap.offsetHeight;
  const L = Math.max(-w*0.25, Math.min(innerWidth - w*0.75, wrap.offsetLeft||innerWidth*0.18));
  const T = Math.max(-h*0.25, Math.min(innerHeight - h*0.75, wrap.offsetTop || innerHeight*0.64));
  wrap.style.left = (L + w/2) + 'px';
  wrap.style.top  = (T + h/2) + 'px';
  wrap.style.transform='translate(-50%,-50%)';
}
addEventListener('resize', nudgeSunNow, {passive:true}); nudgeSunNow();

// Canvas click near radio moon opens Grand Element Radio
canvas.addEventListener('pointerup', (e)=>{
  if(!worldMoon || !worldMoon.r) return;
  const dx = e.clientX - worldMoon.x;
  const dy = e.clientY - worldMoon.y;
  if(Math.hypot(dx,dy) <= worldMoon.r*1.1){
    try{ document.getElementById('gePlayer')?.pause(); }catch(err){}
    window.open('https://grandelement.github.io/radio/','_blank','noopener');
  }
}, {passive:true});
</script>
</body>
</html>
