<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Grand Element — Master</title>
<style>
  :root{
    --img-base: https://grandelement.github.io/website/images/;

    /* Background */
    --star-tile: 900px;

    /* Planets (album dots) */
    --planet-size: 35px;
    --planet-hover-scale: 3;
    --planet-glow: 18px;

    /* Sun + Moon */
    --sun-size: 200px;
    --moon-size: 120px;
    --orbit-seconds: 60;
    --orbit-gap-moons: 2.2;
    --orbit-radius: calc((var(--sun-size) * 0.5) + (var(--moon-size) * var(--orbit-gap-moons)));

    /* FX */
    --comet-max: 3;

    /* Brand blues */
    --blue-sun: #6fb8ff;
    --blue-sun-text: #06121f;
  }

  /* “Mini” layout — roughly half-sized on mobile */
  @media (max-width: 700px){
    :root{
      --planet-size: 18px;
      --sun-size: 120px;
      --moon-size: 72px;
      --orbit-gap-moons: 2.4;
    }
  }

  html,body{height:100%}
  body{
    margin:0; overflow:hidden; color:#eaf2ff; background:#000;
    background-image:
      url('https://grandelement.github.io/website/images/GE%20stars.jpg'),
      radial-gradient(closest-side,#fff 1px,rgba(255,255,255,0) 1px);
    background-position: center center, 0 0;
    background-repeat: no-repeat, repeat;
    background-size: cover, 3px 3px;
    background-attachment: fixed, scroll;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* FX canvas */
  #fx{ position:fixed; inset:0; display:block; z-index:3; }

  /* Hidden text (above background, below objects) */
  .layer-hiddentext{ position:fixed; inset:0; pointer-events:none; z-index:2; }
  .phrase{ position:absolute; color:#cfe9ff; font-weight:700; text-shadow:0 2px 8px rgba(0,0,0,.9); opacity:0; transition:opacity .5s ease; pointer-events:auto; }
  .phrase.show{ opacity:1; }
  .phrase.pinned{ color:#fff; text-decoration:underline; }

  /* Sun + Moon */
  .sunWrap{ position:absolute; left:18vw; top:64vh; transform:translate(-50%,-50%);
            width:var(--sun-size); height:var(--sun-size); pointer-events:auto; z-index:5; cursor:grab; }
  .sunWrap.dragging{ cursor:grabbing; }

  .sun{ position:absolute; inset:0; border-radius:50%;
        background:center/cover no-repeat url('https://grandelement.github.io/website/images/ge-logo-2.jpg');
        box-shadow: inset 0 0 60px rgba(255,255,255,.12); z-index:3; pointer-events:auto; }

  /* ABOUT at top of sun */
  .sunOverlayTop{
    position:absolute; inset:0; display:flex; flex-direction:column; align-items:center;
    justify-content:flex-start; gap:8px; pointer-events:none; text-align:center; padding-top:8%;
  }
  .sunAbout{ pointer-events:auto; font-weight:900; letter-spacing:.22em; font-size:13px; opacity:.95;
             text-shadow:0 0 14px rgba(150,190,255,.55); cursor:pointer; }

  /* HUD near lower sun */
  .sunHUD{
    position:absolute; left:50%; bottom:5%; transform:translate(-50%,0);
    display:flex; flex-direction:column; align-items:center; gap:6px; pointer-events:none;
  }
  #nowPlaying{
    pointer-events:auto;
    font-weight:800; letter-spacing:.2px;
    background:var(--blue-sun); color:var(--blue-sun-text);
    padding:4px 8px; border-radius:10px; max-width:88%;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .toggle{ pointer-events:auto; padding:6px 12px; border-radius:999px; border:1px solid rgba(220,240,255,.35);
           background:rgba(12,24,40,.6); cursor:pointer; }
  .toggle.active{ background:rgba(40,140,255,.45); }

  /* Collapsible player: BELOW the Music button (below the Sun) */
  .miniPlayer{
    position:absolute; left:50%; top:calc(100% + 12px); transform:translate(-50%,0); /* BELOW */
    width:86vw; max-width:360px;
    background:rgba(5,10,22,.92);
    border:1px solid rgba(220,240,255,.35); border-radius:16px; padding:10px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.55);
    display:none; flex-direction:column; gap:10px; align-items:stretch; font-size:12px;
    z-index:8; pointer-events:auto;
  }
  .controls{ display:flex; gap:6px; justify-content:center; }
  .btn{ width:26px; height:26px; border-radius:8px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); color:#eaf2ff; font-weight:900; display:grid; place-items:center; cursor:pointer; user-select:none; }
  .btn:active{ transform:translateY(1px); }
  .row{ display:flex; gap:10px; align-items:center; }
  .row input[type="range"]{ flex:1; }

  .orbit{ position:absolute; inset:0; transform-origin:50% 50%; z-index:6; pointer-events:none; }
  .carrier{ position:absolute; left:50%; top:50%; width:0; height:0; }
  .moon{ position:absolute; left:0; top:0; transform:translate(var(--orbit-radius), -50%);
         width:var(--moon-size); height:var(--moon-size); border-radius:50%; cursor:pointer; pointer-events:auto; display:grid; place-items:center; }
  .moon img{ width:100%; height:100%; object-fit:cover; border-radius:50%;
    box-shadow:0 0 10px 4px rgba(140,200,255,.35); border:1px solid rgba(160,210,255,.55);
    background: radial-gradient(circle, rgba(160,210,255,.55) 0%, rgba(160,210,255,.25) 60%, rgba(160,210,255,0) 70%);
  }

  .overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:10; }
  .overlay.show{ display:grid; }
  .aboutText{ max-width:min(90vw, 820px); margin:0 16px; text-align:center; color:#eaf2ff; font-size:18px; line-height:1.6;
              text-shadow:0 0 16px rgba(150,190,255,.45),0 0 30px rgba(60,120,200,.25); position:relative; }

  /* ABOUT close button */
  .aboutClose{
    position:absolute; top:24px; right:24px;
    width:34px; height:34px; border-radius:50%;
    border:1px solid rgba(220,240,255,.5);
    background:rgba(5,10,22,.7); color:#eaf2ff;
    font-size:22px; line-height:32px; text-align:center;
    cursor:pointer; z-index:11; backdrop-filter:blur(2px);
  }
  .aboutClose:hover{ background:rgba(20,40,70,.8); }
  .aboutClose:active{ transform:translateY(1px); }

  /* ABOUT extras */
  .aboutSection{margin-top:18px; text-align:left}
  .aboutSection h3{margin:0 0 6px 0; font-size:18px; text-align:center}
  .kv{display:flex; gap:10px; justify-content:center; margin-top:10px}
  .kv .pill{padding:6px 10px; border:1px solid rgba(220,240,255,.35); border-radius:999px; background:rgba(10,20,36,.6)}
  .details{margin:8px auto 0; max-width:640px; background:rgba(10,20,36,.55); padding:10px 12px; border-radius:12px; border:1px solid rgba(220,240,255,.25)}
  .details ul{margin:6px 0 0 18px}
  .toggleRow{display:flex; justify-content:center; margin-top:12px}
  #bgHelp{display:none}

  /* Planets */
  .planets{ position:fixed; inset:0; pointer-events:none; z-index:4; }
  .planet{ position:absolute; width:var(--planet-size); height:var(--planet-size); border-radius:50%; pointer-events:auto; overflow:hidden; cursor:pointer;
           background:#32406b; background-size:cover; background-position:center; box-shadow:0 0 10px rgba(255,255,255,.2);
           transition: transform .2s ease, box-shadow .18s ease; }
  .planet:hover, .planet.touchZoom{ transform:scale(var(--planet-hover-scale)); box-shadow:0 0 var(--planet-glow) rgba(255,160,255,.65),0 0 2px 1px rgba(255,255,255,.25) inset; }
  .planet .label{ position:absolute; left:50%; top:-12px; transform:translate(-50%,-100%); padding:6px 10px; border-radius:999px; white-space:nowrap;
                  background:rgba(15,25,50,.35); border:1px solid rgba(200,220,255,.5); backdrop-filter:blur(2px); font-size:12px; letter-spacing:.3px; font-weight:700;
                  opacity:0; pointer-events:none; transition:opacity .12s ease; }
  .planet:hover .label, .planet.touchZoom .label{ opacity:1; }
</style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="layer-hiddentext" id="phrases"></div>

  <!-- Sun + Moon -->
  <div class="sunWrap" id="sunWrap">
    <div class="sun" id="sun" title="ABOUT">
      <div class="sunOverlayTop">
        <div class="sunAbout" id="aboutBtn">ABOUT</div>
      </div>

      <!-- HUD near bottom of the sun -->
      <div class="sunHUD">
        <div id="nowPlaying">—</div>
        <div class="toggle" id="btnMusic">Music</div>
      </div>

      <!-- Player panel BELOW the button -->
      <div class="miniPlayer" id="mini">
        <div class="controls" id="mpControls">
          <div class="btn" id="prev" title="Prev">◀</div>
          <div class="btn" id="play" title="Play/Pause">▶</div>
          <div class="btn" id="next" title="Next">▶▶</div>
        </div>

        <div class="row">
          <span style="font-variant-numeric:tabular-nums" id="timeCur">0:00</span>
          <input id="seek" type="range" min="0" max="1000" value="0">
          <span style="font-variant-numeric:tabular-nums" id="timeMax">0:00</span>
        </div>
        <div class="row">
          <label style="opacity:.8">Vol</label>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8">
        </div>

        <div class="controls">
          <div class="toggle active" id="tgShuffle">Shuffle</div>
          <div class="toggle" id="tgAlbum">Album</div>
        </div>

        <audio id="gePlayer" preload="auto" playsinline></audio>
      </div>
    </div>

    <!-- Orbiting radio moon -->
    <div class="orbit" id="orbit">
      <div class="carrier">
        <div class="moon" id="moon" title="Grand Element Radio">
          <img alt="Grand Element Radio" src="https://grandelement.github.io/website/images/ge-radio-logo.png">
        </div>
      </div>
    </div>
  </div>

  <!-- Planets -->
  <div class="planets" id="planets"></div>

  <!-- ABOUT -->
  <div class="overlay" id="about">
    <button class="aboutClose" id="aboutClose" aria-label="Close">×</button>
    <div class="aboutText">
      Started the summer of 2005 in Las Vegas, Nevada. Experiments in sound and communication. A journey into the soul. Created with one vision: the listener is the "GRAND ELEMENT".
      Hypnotic rhythms and spacious soundscapes leave room for reflection, opening the body and soul to the voice of energy—reminding us that we are all one, all energy, and all love.

      <div class="aboutSection" id="aboutMembers">
        <h3>Band Members (all eras)</h3>
        <div class="details" id="membersList">
          <!-- Edit this list freely; safe placeholders -->
          <ul>
            <li>GE — Founder / composer / multi-instrumentalist</li>
            <!-- Add more members/roles here -->
          </ul>
        </div>
      </div>

      <div class="aboutSection">
        <div class="toggleRow">
          <div class="pill">Background Controls</div>
        </div>
        <div class="details" id="bgHelp">
          <ul>
            <li><b>Click Blue Sun</b>: Teleport (ripple) to next background.</li>
            <li><b>Drag Blue Sun</b>: Move it; at least 25% stays on-screen.</li>
            <li><b>Hover/Click Moon</b>: 60s orbit; click opens Radio (site music pauses).</li>
            <li><b>Planets</b>: Click (no drag) → Bandcamp. Drag/throw → pool-ball physics.</li>
            <li><b>Comets</b>: Drag/throw to bounce off planets/sun/moon & other comets.</li>
            <li><b>Ships</b>: Click to fire “sound-wave” tethers; click again to add more (up to 3).</li>
            <li><b>Hidden text</b>: Appears near cursor; click to pin/unpin.</li>
            <li><b>Starfield</b>: Double-click to reveal all hidden text briefly.</li>
          </ul>
        </div>
      </div>

      <br>
      <a href="mailto:info@grandelement.com" style="color:#dff3ff; font-weight:800; text-decoration:none;">✉ Contact</a>
    </div>
  </div>

<script>
/* ============== helpers ============== */
const IMG = getComputedStyle(document.documentElement).getPropertyValue('--img-base').trim() || 'https://grandelement.github.io/website/images/';
const MOBILE = innerWidth < 700 || /iPhone|Android/i.test(navigator.userAgent);
const rand=(a,b)=>Math.random()*(b-a)+a, choice=a=>a[(Math.random()*a.length)|0];

/* ========= PLANETS — spiral placement ========= */
const ALBUMS = [
  { title:"Fundamental\u00A0Groove", cover: IMG+"Grand%20Element%20-%20Fundamental%20Groove.jpg", link:"https://grandelement.bandcamp.com/album/fundamental-groove" },
  { title:"Trio",        cover: IMG+"Grand%20Element%20-%20Trio.jpg",        link:"https://grandelement.bandcamp.com/album/trio" },
  { title:"Live!",       cover: IMG+"Grand%20Element%20-%20Live.jpg",        link:"https://grandelement.bandcamp.com/album/live" },
  { title:"Sessions I",  cover: IMG+"Grand%20Element%20-%20Sessions%20I.jpg",  link:"https://grandelement.bandcamp.com/album/sessions-i" },
  { title:"Sessions II", cover: IMG+"Grand%20Element%20-%20Sessions%20II.jpg", link:"https://grandelement.bandcamp.com/album/sessions-ii" },
  { title:"Intergy",     cover: IMG+"Grand%20Element%20-%20Intergy.jpg",     link:"https://grandelement.bandcamp.com/album/intergy" },
  { title:"Love",        cover: IMG+"Grand%20Element%20-%20Love.jpg",        link:"https://grandelement.bandcamp.com/album/love" },
  { title:"Soul",        cover: IMG+"Grand%20Element%20-%20Soul.jpg",        link:"https://grandelement.bandcamp.com/album/soul" },
  { title:"Spirit",      cover: IMG+"Grand%20Element%20-%20Spirit.jpg",      link:"https://grandelement.bandcamp.com/album/spirit" },
  { title:"Fire",        cover: IMG+"Grand%20Element%20-%20Fire.jpg",        link:"https://grandelement.bandcamp.com/album/fire" }
];
const planetsEl = document.getElementById('planets');
function placeSpiral(){
  planetsEl.innerHTML="";
  const w = innerWidth, h = innerHeight;
  const xCenter = w * 0.56;
  const yBottom = h * 0.88;
  const yTop    = h * 0.14;
  const amp     = Math.max(80, w * 0.12);
  const waves   = 1.2;
  ALBUMS.forEach((alb,i)=>{
    const t = i/(ALBUMS.length-1);
    const y = yBottom - t*(yBottom - yTop);
    const x = xCenter + amp * Math.sin((t * Math.PI * 2 * waves) - Math.PI/2);
    const aEl = document.createElement('a');
    aEl.className='planet'; aEl.style.left=x+'px'; aEl.style.top=y+'px';
    aEl.href=alb.link; aEl.target='_blank'; aEl.rel='noopener'; aEl.title=alb.title;
    aEl.innerHTML = `<span class="label">${alb.title}</span>`;
    aEl.style.backgroundImage = `url('${alb.cover}')`;
    // touch zoom
    aEl.addEventListener('touchstart', ()=> aEl.classList.add('touchZoom'), {passive:true});
    aEl.addEventListener('touchend',   ()=> aEl.classList.remove('touchZoom'), {passive:true});
    // click-vs-drag for desktop: prevent link if thrown
    let downPos=null, dragged=false;
    aEl.addEventListener('pointerdown',e=>{ downPos={x:e.clientX,y:e.clientY}; dragged=false; });
    aEl.addEventListener('pointermove',e=>{ if(!downPos) return; if(Math.hypot(e.clientX-downPos.x, e.clientY-downPos.y)>6) dragged=true; });
    aEl.addEventListener('click',e=>{ if(dragged){ e.preventDefault(); e.stopPropagation(); } });
    planetsEl.appendChild(aEl);
  });
}
placeSpiral(); addEventListener('resize', placeSpiral, {passive:true});

/* ========= ABOUT ========= */
document.getElementById('aboutBtn').addEventListener('click', ()=> document.getElementById('about').classList.add('show'));
document.getElementById('about').addEventListener('click', (e)=>{ if(e.target.id==='about') e.currentTarget.classList.remove('show'); });
addEventListener('keydown', (e)=>{ if(e.key==='Escape') document.getElementById('about').classList.remove('show'); });
document.getElementById('aboutClose').addEventListener('click', ()=> document.getElementById('about').classList.remove('show'));

// ABOUT: Background Controls toggle
(function(){
  const pill = document.querySelector('.aboutSection .pill');
  const panel = document.getElementById('bgHelp');
  if(pill && panel){
    pill.style.cursor='pointer';
    pill.addEventListener('click', ()=> panel.style.display = (panel.style.display==='none'||panel.style.display==='')?'block':'none');
  }
})();

/* ========= RADIO MOON — 60s orbit; pause site audio on click ========= */
const orbit = document.getElementById('orbit');
const moon  = document.getElementById('moon');
const ORBIT_SEC = 60, PHASE0 = -Math.PI/2;
const BASE_R = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--orbit-radius')) || 260;
const OSC_PX = 30, OSC_SEC = 90;
function tickOrbit(){
  const t = Date.now()/1000;
  const angle = PHASE0 + (t % ORBIT_SEC) / ORBIT_SEC * Math.PI*2;
  const r = BASE_R + OSC_PX * Math.sin((t/OSC_SEC)*Math.PI*2);
  orbit.style.transform = `rotate(${angle}rad)`;
  moon.style.transform  = `translate(${r}px,-50%) rotate(${-angle}rad)`;
  const backHalf = (angle % (Math.PI*2)) > Math.PI;
  orbit.style.zIndex = backHalf ? 2 : 6;
  requestAnimationFrame(tickOrbit);
}
requestAnimationFrame(tickOrbit);
moon.addEventListener('click', ()=>{
  try{ document.getElementById('gePlayer')?.pause(); }catch(e){}
  window.open('https://grandelement.github.io/radio/','_blank','noopener');
});

/* ========= MUSIC (panel below button, fully interactive) ========= */
(function(){
  const mini   = document.getElementById('mini');
  const player = document.getElementById('gePlayer');
  const nowPlaying = document.getElementById('nowPlaying');
  const btnMusic = document.getElementById('btnMusic');

  const tCur = document.getElementById('timeCur');
  const tMax = document.getElementById('timeMax');
  const seek = document.getElementById('seek');
  const vol  = document.getElementById('vol');
  const btnPrev = document.getElementById('prev');
  const btnPlay = document.getElementById('play');
  const btnNext = document.getElementById('next');
  const tgShuffle = document.getElementById('tgShuffle');
  const tgAlbum   = document.getElementById('tgAlbum');

  // Open/close panel without covering the Music button
  btnMusic.addEventListener('click', (e)=>{
    e.stopPropagation();
    mini.style.display = (mini.style.display==='none' || mini.style.display==='') ? 'flex' : 'none';
  });

  // Prevent Sun drag from swallowing slider/panel events
  ['pointerdown','pointermove','touchstart'].forEach(ev=>{
    mini.addEventListener(ev, e=>{ e.stopPropagation(); }, {passive:false});
  });

  let PLAYLIST=[], pIndex=0, SHUFFLE=true;
  const fmt=t=>{ t=t|0; const m=(t/60)|0, s=(t%60)|0; return `${m}:${s.toString().padStart(2,'0')}`; };
  const shuffle=a=>{ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } };
  const setTitle = it => nowPlaying.textContent = it ? it.track : '—';

  async function fetchAllMp3s(){
    const r = await fetch('https://api.github.com/repos/grandelement/radio/git/trees/main?recursive=1',
                          {headers:{'Accept':'application/vnd.github+json'}});
    if(!r.ok) return [];
    const data = await r.json();
    return (data.tree||[])
      .filter(n=>n.type==='blob' && /\.mp3$/i.test(n.path))
      .map(n=>{
        const parts=n.path.split('/');
        const album = decodeURIComponent(parts[1]||'Unknown');
        const file  = decodeURIComponent(parts[parts.length-1]);
        const trackNum = (/^\s*(\d{1,3})/.exec(file)?.[1]??'9999')|0;
        const track = file.replace(/\.[^.]+$/,'').replace(/^\s*\d+\s*[-_.]?\s*/,'');
        return { url:`https://grandelement.github.io/radio/${encodeURI(n.path)}`, album, trackNum, track };
      });
  }

  function applyOrder(){
    if (SHUFFLE) {
      const base=[...PLAYLIST].sort((a,b)=>a.album.localeCompare(b.album)||a.trackNum-b.trackNum);
      PLAYLIST = base; shuffle(PLAYLIST);
    } else {
      PLAYLIST.sort((a,b)=>a.album.localeCompare(b.album)||a.trackNum-b.trackNum);
    }
    pIndex=0; startCurrent();
  }

  function startCurrent(){
    const it = PLAYLIST[pIndex];
    if(!it) return;
    player.src = it.url; setTitle(it);
    player.play().catch(()=>{});
    btnPlay.textContent='❚❚';
  }
  function next(){ if(!PLAYLIST.length) return; pIndex=(pIndex+1)%PLAYLIST.length; startCurrent(); }
  function prev(){ if(!PLAYLIST.length) return; pIndex=(pIndex-1+PLAYLIST.length)%PLAYLIST.length; startCurrent(); }

  btnNext.onclick=next; btnPrev.onclick=prev;
  btnPlay.onclick=()=>{ if(player.paused){ player.play().catch(()=>{}); btnPlay.textContent='❚❚'; } else { player.pause(); btnPlay.textContent='▶'; } };
  tgShuffle.onclick=()=>{ SHUFFLE=true;  tgShuffle.classList.add('active'); tgAlbum.classList.remove('active'); applyOrder(); };
  tgAlbum.onclick  =()=>{ SHUFFLE=false; tgAlbum.classList.add('active'); tgShuffle.classList.remove('active'); applyOrder(); };

  vol.addEventListener('input', ()=>{ player.volume = +vol.value; });
  player.addEventListener('loadedmetadata', ()=>{ seek.max=player.duration||1000; tMax.textContent=fmt(player.duration||0); });
  player.addEventListener('timeupdate',     ()=>{ if(!seek.matches(':active')) seek.value=player.currentTime||0; tCur.textContent=fmt(player.currentTime||0); });
  seek.addEventListener('input', ()=>{ try{ player.currentTime = +seek.value; }catch(e){} });

  player.addEventListener('ended', next);
  player.addEventListener('error', next);

  function unmuteOnce(){ player.muted=false; window.removeEventListener('pointerdown', unmuteOnce, {capture:true}); }
  window.addEventListener('pointerdown', unmuteOnce, {capture:true, once:true});
  player.muted=true;

  fetchAllMp3s().then(list=>{
    if(!list.length){ nowPlaying.textContent='No tracks found.'; return; }
    PLAYLIST = list; applyOrder();
  });
})();

/* ========= HIDDEN TEXT — proximity reveal + click to pin; Starfield dblclick = reveal-all ========= */
(function(){
  const layer = document.getElementById('phrases');
  const URL_TXT = 'https://grandelement.github.io/website/data/hidden.txt';
  let PHRASES=[];
  fetch(URL_TXT).then(r=>r.ok?r.text():'').then(t=>{
    PHRASES = t.split(/[,\r?\n]/).map(s=>s.trim()).filter(Boolean);
    if(!PHRASES.length) PHRASES = [
      'you are the grand element','energy in motion','silence between notes',
      'frequency is the vehicle','listen inward','breathe the rhythm','love is the key',
      'soul remembers','spirit moves','fire awakens'
    ];
    scatter();
  });
  function scatter(){
    layer.innerHTML='';
    const n=Math.max(10, PHRASES.length);
    for(let i=0;i<n;i++){
      const el=document.createElement('div');
      el.className='phrase'; el.textContent=PHRASES[i%PHRASES.length];
      el.style.left=(10+Math.random()*(innerWidth-220))+'px';
      el.style.top =(10+Math.random()*(innerHeight-120))+'px';
      el.onclick=()=> el.classList.toggle('pinned');
      layer.appendChild(el);
    }
  }
  let px=-9999, py=-9999; addEventListener('pointermove',e=>{px=e.clientX;py=e.clientY;},{passive:true});
  setInterval(()=>{
    const r=Math.min(innerWidth,innerHeight)*0.14;
    [...layer.children].forEach(el=>{
      if(el.classList.contains('pinned')){ el.classList.add('show'); return; }
      const rect=el.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
      const d=Math.hypot(px-cx,py-cy);
      if(d<r) el.classList.add('show'); else el.classList.remove('show');
    });
  }, 100);
  addEventListener('resize', ()=>requestAnimationFrame(scatter), {passive:true});

  // Double-click the canvas to reveal all temporarily
  const fx = document.getElementById('fx');
  fx.addEventListener('dblclick', ()=>{
    const nodes=[...layer.children];
    nodes.forEach(el=>el.classList.add('show'));
    setTimeout(()=>nodes.forEach(el=>{ if(!el.classList.contains('pinned')) el.classList.remove('show'); }), 4000);
  });
})();

/* ===========================
   FX — star-net, comets, ships, teleport
   =========================== */
const canvas = document.getElementById('fx'), ctx = canvas.getContext('2d');
let W=innerWidth,H=innerHeight; function resize(){ W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H; } addEventListener('resize', resize, {passive:true}); resize();

const cometImg = new Image(); cometImg.src=IMG+'ge-logo%203.png';
const shipImg  = new Image(); shipImg.src=IMG+'ge-logo-4-cutout.png';

/* Adaptive performance guardrails */
const PERF = {dt:0.016, heat:0, targetFPS:60};
function perfHeat(dt){ const target=1/PERF.targetFPS; PERF.heat = Math.max(0, Math.min(1, PERF.heat + (dt-target)*3)); }

/* Star-network — dense net + two cue-balls (blue/red) */
const NET = { pts:[], links:64, r:36, mini:[] };
(function initNet(){
  const base = Math.round(Math.min(180, (innerWidth*innerHeight)/28000));
  let count = base*5;                 // ~5× density
  if (innerWidth < 700) count = Math.max(120, Math.round(count*0.4));
  NET.pts = Array.from({length:count}, ()=>({
    x:Math.random()*W, y:Math.random()*H,
    vx:(Math.random()-.5)*0.06, vy:(Math.random()-.5)*0.06
  }));
  // EXACTLY one blue + one red cue-ball
  NET.mini = [
    { x:Math.random()*W, y:Math.random()*H, r:12, color:'blue', dragging:false, vx:rand(-20,20), vy:rand(-20,20) },
    { x:Math.random()*W, y:Math.random()*H, r:12, color:'red',  dragging:false, vx:rand(-20,20), vy:rand(-20,20) }
  ];
})();
let dragMini=null, miniHist=[];
canvas.addEventListener('pointerdown', e=>{
  for(const m of NET.mini){
    if(Math.hypot(e.clientX-m.x,e.clientY-m.y)<m.r+8){ dragMini=m; m.dragging=true; miniHist=[{x:e.clientX,y:e.clientY,t:performance.now()}]; e.preventDefault(); return; }
  }
},{passive:false});
canvas.addEventListener('pointermove', e=>{
  if(!dragMini) return;
  dragMini.x=e.clientX; dragMini.y=e.clientY; const now=performance.now();
  miniHist.push({x:e.clientX,y:e.clientY,t:now}); while(miniHist.length && now-miniHist[0].t>160) miniHist.shift();

  // Cue-ball effect while dragging: collide with planets and comets
  if (window.planetNodes){
    for (const p of planetNodes){
      collideElastic(dragMini, {x:p.x, y:p.y, r:p.r, vx:p.vx||0, vy:p.vy||0}, 0.98);
    }
  }
  for (const c of comets){
    collideElastic(dragMini, c, 0.96);
  }
},{passive:true});
canvas.addEventListener('pointerup', e=>{
  if(!dragMini) return;
  const now=performance.now(); const last=miniHist[miniHist.length-1], first=miniHist[0]||last; const dt=Math.max(16,last.t-first.t);
  dragMini.vx=(last.x-first.x)/dt*600; dragMini.vy=(last.y-first.y)/dt*600;
  dragMini.dragging=false; dragMini=null;
});

function netStepDraw(dt){
  const linkMult = PERF.heat>0.5 ? 0.6 : 1;
  const r2 = (NET.r*linkMult)*(NET.r*linkMult);

  for(const p of NET.pts){
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0)p.x+=W; if(p.x>W)p.x-=W; if(p.y<0)p.y+=H; if(p.y>H)p.y-=H;
  }
  ctx.save();
  ctx.globalAlpha = 0.18;
  ctx.strokeStyle = '#9ec8ff'; ctx.lineWidth=1;
  for(const a of NET.pts){
    let links=0, maxLinks = Math.round(NET.links*linkMult);
    for(const b of NET.pts){
      if(a===b) continue;
      const dx=a.x-b.x, dy=a.y-b.y, d2=dx*dx+dy*dy;
      if(d2 < r2){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); if(++links>maxLinks) break; }
    }
  }
  ctx.globalAlpha = 0.7; ctx.fillStyle='#cfe9ff';
  for(const p of NET.pts){ ctx.beginPath(); ctx.arc(p.x,p.y,0.7,0,Math.PI*2); ctx.fill(); }

  // mini blue/red cue-balls
  for(const m of NET.mini){
    if(!m.dragging){ m.x+=m.vx*dt; m.y+=m.vy*dt; m.vx*=0.995; m.vy*=0.995; }
    if(m.x<-40)m.x=W+40; if(m.x>W+40)m.x=-40; if(m.y<-40)m.y=H+40; if(m.y>H+40)m.y=-40;

    const tint = (m.color==='red') ? 'rgba(255,120,120,0.9)' : 'rgba(120,190,255,0.9)';
    const aura = (m.color==='red') ? 'rgba(255,120,120,0)'   : 'rgba(120,190,255,0)';
    const grd = ctx.createRadialGradient(m.x,m.y,2, m.x,m.y,m.r+10);
    grd.addColorStop(0, tint); grd.addColorStop(1, aura);
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(m.x,m.y,m.r+10,0,Math.PI*2); ctx.fill();

    ctx.fillStyle = (m.color==='red') ? '#ff6b6b' : '#6fb8ff';
    ctx.beginPath(); ctx.arc(m.x,m.y,m.r,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

/* Comets */
const COMET={sizes:[8,10,12,16], max:(innerWidth<700?2: (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--comet-max'))||3)), spawn:[4,9], speed:[60,140], trail:90, fade:1500, touch:26};
class Comet{
  constructor(){
    const edge=choice(['l','r','t','b']), pad=40;
    if(edge==='l'){this.x=-pad; this.y=rand(0,H);}
    if(edge==='r'){this.x=W+pad; this.y=rand(0,H);}
    if(edge==='t'){this.x=rand(0,W); this.y=-pad;}
    if(edge==='b'){this.x=rand(0,W); this.y=H+pad;}
    const tx=rand(W*.2,W*.8), ty=rand(H*.2,H*.8);
    const a=Math.atan2(ty-this.y, tx-this.x), s=rand(...COMET.speed);
    this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s; this.r=choice(COMET.sizes);
    this.trail=[]; this.state='fly'; this.dead=false; this.dragging=false;
  }
  step(dt){
    if(!this.dragging){ this.x+=this.vx*dt; this.y+=this.vy*dt; }
    this.trail.push([this.x,this.y,performance.now()]); if(this.trail.length>COMET.trail) this.trail.shift();
    if(this.x<-140||this.x>W+140||this.y<-140||this.y>H+140) this.dead=true;
  }
  draw(){
    while(this.trail.length && performance.now()-this.trail[0][2] > 2500) this.trail.shift();
    for(const [tx,ty,ts] of this.trail){
      const a=Math.max(0,1-(performance.now()-ts)/COMET.fade);
      if(a<=0) continue; ctx.globalAlpha=a*0.6;
      ctx.drawImage(cometImg, tx-this.r, ty-this.r, this.r*2, this.r*2);
    }
    ctx.globalAlpha=1; ctx.drawImage(cometImg, this.x-this.r, this.y-this.r, this.r*2, this.r*2);
  }
}
class Pair{
  constructor(a,b){
    this.a=a; this.b=b; this.t=0;
    this.cx=(a.x+b.x)/2; this.cy=(a.y+b.y)/2;
    this.R=Math.max(18, Math.hypot(a.x-b.x,a.y-b.y)/2);
    this.theta=Math.atan2(a.y-this.cy,a.x-this.cx);
    this.omega=(Math.PI*2)/3;
    const va=Math.atan2(a.vy,a.vx), vb=Math.atan2(b.vy,b.vx), out=(va+vb)/2;
    this.outA=out; this.outB=out+Math.PI;
    this.sA=Math.hypot(a.vx,a.vy); this.sB=Math.hypot(b.vx,b.vy);
    this.phase='orbit';
  }
  step(dt){
    this.t+=dt;
    if(this.phase==='orbit'){
      this.theta+=this.omega*dt;
      this.a.x=this.cx+Math.cos(this.theta)*this.R; this.a.y=this.cy+Math.sin(this.theta)*this.R;
      this.b.x=this.cx-Math.cos(this.theta)*this.R; this.b.y=this.cy-Math.sin(this.theta)*this.R;
      if(this.t>=3){ this.phase='pause'; this.t=0; }
    }else if(this.phase==='pause'){
      if(this.t>=2.5){
        this.phase='split';
        this.a.state='separate'; this.b.state='separate';
        this.a.vx=Math.cos(this.outA)*this.sA; this.a.vy=Math.sin(this.outA)*this.sA;
        this.b.vx=Math.cos(this.outB)*this.sB; this.b.vy=Math.sin(this.outB)*this.sB;
      }
    }else{ this.dead=true; }
  }
  draw(){
    if(this.phase!=='split'){
      const g=ctx.createRadialGradient(this.cx,this.cy,2,this.cx,this.cy,this.R+12);
      g.addColorStop(0,'rgba(180,220,255,.25)'); g.addColorStop(1,'rgba(180,220,255,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(this.cx,this.cy,this.R+12,0,Math.PI*2); ctx.fill();
    }
  }
}

/* Ships (cursor-follow field + click-to-tether up to 3) */
let mouseX=-9999, mouseY=-9999;
addEventListener('pointermove', e=>{ mouseX=e.clientX; mouseY=e.clientY; }, {passive:true});

class Ship{
  constructor(){
    const side = choice(['l','r','t','b']);
    this.s = MOBILE ? 0.16 : 0.2;
    const pad=60;
    if(side==='l'){ this.x=-pad; this.y=rand(0,H); this.vx=rand(80,220); this.vy=rand(-80,80); }
    if(side==='r'){ this.x=W+pad; this.y=rand(0,H); this.vx=-rand(80,220); this.vy=rand(-80,80); }
    if(side==='t'){ this.x=rand(0,W); this.y=-pad; this.vx=rand(-180,180); this.vy=rand(80,220); }
    if(side==='b'){ this.x=rand(0,W); this.y=H+pad; this.vx=rand(-180,180); this.vy=-rand(80,220); }
    this.ax=rand(-30,30); this.ay=rand(-30,30); this.curveT=rand(2,5); this.curveP=rand(0,Math.PI*2);
    this.dead=false; this.beam=0; this.targets=[]; this.forceBeamUntil=0; this.maxTargets=3; this.captureRadius=18;
  }
  captureNextComet(){
    const pool = comets.filter(c => c.state==='fly' && !this.targets.includes(c));
    if (!pool.length || this.targets.length >= this.maxTargets) return;
    pool.sort((a,b)=> (Math.hypot(a.x-this.x,a.y-this.y) - Math.hypot(b.x-this.x,b.y-this.y)));
    this.targets.push(pool[0]);
    this.beam = 1;
  }
  step(dt){
    // wandering + cursor follow
    this.curveP+=dt/this.curveT;
    this.vx+=Math.sin(this.curveP)*18*dt + this.ax*dt*.2;
    this.vy+=Math.cos(this.curveP)*18*dt + this.ay*dt*.2;

    const shipR = (shipImg.height||100)*this.s*0.3;
    const outer = shipR*2.2, inner = shipR*0.9;
    const dx = mouseX-this.x, dy = mouseY-this.y, d = Math.hypot(dx,dy);
    if(d < outer){
      const dir = Math.atan2(dy,dx);
      const k = Math.max(0, Math.min(1, (d-inner) / (outer-inner)));
      const followSpeed = 180*k;
      const stopDamp    = (d<inner ? 0.85 : 0.98);
      this.vx = this.vx*stopDamp + Math.cos(dir)*followSpeed*dt;
      this.vy = this.vy*stopDamp + Math.sin(dir)*followSpeed*dt;
      if(d<inner*0.6){ this.vx*=0.6; this.vy*=0.6; }
    }

    const v=Math.hypot(this.vx,this.vy); const vmin=50, vmax=320;
    if(v<vmin){ const a=Math.atan2(this.vy,this.vx)||rand(-Math.PI,Math.PI); this.vx=Math.cos(a)*vmin; this.vy=Math.sin(a)*vmin; }
    if(v>vmax){ this.vx*=vmax/v; this.vy*=vmax/v; }

    this.x+=this.vx*dt; this.y+=this.vy*dt;
    if(this.x<-140||this.x>W+140||this.y<-140||this.y>H+140) this.dead=true;

    // Reel in targets if any
    if (this.targets.length){
      // centroid between ship and targets
      const cx = this.targets.reduce((s,c)=>s+c.x,0)/this.targets.length;
      const cy = this.targets.reduce((s,c)=>s+c.y,0)/this.targets.length;
      const midX = (this.x + cx)/2, midY = (this.y + cy)/2;
      for (const c of this.targets){
        const dx = midX - c.x, dy = midY - c.y;
        const dist = Math.hypot(dx,dy) || 1;
        const k = 60, damp = 0.90;
        c.vx = (c.vx*damp) + (dx/dist)*k;
        c.vy = (c.vy*damp) + (dy/dist)*k;
        if (dist < this.captureRadius) c.state='captured';
      }
      // entangle when tight
      const tight = this.targets.length>=2 && this.targets.every(c=>c.state==='captured');
      if (tight){
        pairs.push(new Pair(this.targets[0], this.targets[1]));
        if (this.targets[2]) pairs.push(new Pair(this.targets[1], this.targets[2]));
        setTimeout(()=>{ this.targets.forEach(c=>c.state='fly'); this.targets.length=0; this.beam=0; }, 1800);
      }
    } else {
      this.beam = Math.max(0, this.beam - dt*1.2);
    }

    // forced beam time window
    if (performance.now() < this.forceBeamUntil) this.beam = 1;
  }
  draw(){
    if(!shipImg.complete) return;
    const ang=Math.atan2(this.vy,this.vx)+Math.PI;
    const w=shipImg.width*this.s, h=shipImg.height*this.s;
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(ang);
    const drawW=w*0.6, drawH=h*0.6; ctx.drawImage(shipImg,-drawW*0.3,-drawH*0.5,drawW,drawH);

    // beams to all targets
    if(this.beam>0 && this.targets.length){
      for(const c of this.targets){
        const mx=c.x - this.x, my=c.y - this.y, len=Math.hypot(mx,my);
        ctx.save(); ctx.rotate(Math.atan2(my,mx));
        ctx.globalAlpha = 0.75 * this.beam;
        ctx.strokeStyle='rgba(126,203,255,.95)'; ctx.lineWidth=2;
        ctx.beginPath();
        for(let i=0;i<=len;i+=6){
          const dy=Math.sin((i/len)*Math.PI*4 + performance.now()/250)*8*(0.6+0.4*this.beam);
          if(i===0) ctx.moveTo(12+i, dy); else ctx.lineTo(12+i, dy);
        }
        ctx.stroke(); ctx.restore();
      }
    }
    ctx.restore();
  }
}

/* Background mini-ships: small, click-to-tether (scaled) */
class MiniShip{
  constructor(){
    this.s = rand(0.015,0.05); // sizes ~1–5
    const side=choice(['l','r','t','b']), pad=40;
    if(side==='l'){ this.x=-pad;    this.y=rand(0,H);  this.vx=rand(12,38);  this.vy=rand(-18,18); }
    if(side==='r'){ this.x=W+pad;   this.y=rand(0,H);  this.vx=-rand(12,38); this.vy=rand(-18,18); }
    if(side==='t'){ this.x=rand(0,W); this.y=-pad;     this.vx=rand(-30,30); this.vy=rand(12,38);  }
    if(side==='b'){ this.x=rand(0,W); this.y=H+pad;    this.vx=rand(-30,30); this.vy=-rand(12,38); }
    this.dead=false; this.forceBeamUntil=0; this.beam=0; this.targets=[];
  }
  captureNextComet(){
    const pool = comets.filter(c => c.state==='fly' && !this.targets.includes(c));
    if(!pool.length || this.targets.length>=3) return;
    pool.sort((a,b)=> (Math.hypot(a.x-this.x,a.y-this.y) - Math.hypot(b.x-this.x,b.y-this.y)) );
    this.targets.push(pool[0]); this.beam=1;
  }
  step(dt){
    this.x+=this.vx*dt; this.y+=this.vy*dt;
    if(this.x<-100||this.x>W+100||this.y<-100||this.y>H+100) this.dead=true;

    if (performance.now() < this.forceBeamUntil && !this.targets.length) this.captureNextComet();
    if (performance.now() >= this.forceBeamUntil){ this.targets=[]; this.beam=0; }
  }
  draw(){
    if(!shipImg.complete) return;
    ctx.save(); ctx.globalAlpha=.45;
    const ang=Math.atan2(this.vy,this.vx)+Math.PI; const w=shipImg.width*this.s,h=shipImg.height*this.s;
    ctx.translate(this.x,this.y); ctx.rotate(ang); ctx.drawImage(shipImg,-w*0.3,-h*0.5,w*0.6,h*0.6);
    // beams
    if(this.beam>0 && this.targets.length){
      for(const c of this.targets){
        const mx=c.x - this.x, my=c.y - this.y, len=Math.hypot(mx,my);
        ctx.save(); ctx.rotate(Math.atan2(my,mx));
        ctx.globalAlpha = 0.6;
        ctx.strokeStyle='rgba(126,203,255,.85)'; ctx.lineWidth=1.5;
        ctx.beginPath();
        for(let i=0;i<=len;i+=7){
          const dy=Math.sin((i/len)*Math.PI*4 + performance.now()/260)*6;
          if(i===0) ctx.moveTo(10+i, dy); else ctx.lineTo(10+i, dy);
        }
        ctx.stroke(); ctx.restore();
      }
    }
    ctx.restore();
  }
}

/* Arrays + main loop with adaptivity */
const comets=[], pairs=[], ships=[], miniShips=[];
let last=performance.now()/1000, cTimer=0, cNext=rand(4,9), shipTimer=0, shipNext=rand(7,14), miniTimer=0, miniNext=rand(4,9);
let RUN=true; document.addEventListener('visibilitychange', ()=>{ RUN=!document.hidden; });

/* Ripple teleport + backgrounds */
const rp=document.createElement('canvas'); Object.assign(rp.style,{position:'fixed',inset:0,pointerEvents:'none',zIndex:999}); document.body.appendChild(rp);
const rpx=rp.getContext('2d'); function fitRP(){ rp.width=innerWidth; rp.height=innerHeight; } addEventListener('resize', fitRP, {passive:true}); fitRP();
const BG_LIST = [
  'GE stars.jpg','original.jpg','Classifying-stars-by-colour.jpg','hubble_ngc6440-jpg.jpg','9Ch3rMo7JnkDNd6phx3fQR.jpg','KTP rsGURjY4nF DQH7fua.jpg'
].map(n=> `${IMG}stars backgrounds/${encodeURI(n.replace(/\s+/g,' '))}`);
let bgIndex=0;
function setBG(i){
  const url = BG_LIST[(i%BG_LIST.length+BG_LIST.length)%BG_LIST.length];
  const testImg = new Image();
  testImg.onload = ()=>{
    document.body.style.backgroundImage = `url("${url}"), radial-gradient(closest-side,#fff 1px,rgba(255,255,255,0) 1px)`;
    document.body.style.backgroundPosition = 'center center, 0 0';
    document.body.style.backgroundRepeat   = 'no-repeat, repeat';
    document.body.style.backgroundSize     = 'cover, 3px 3px';
  };
  testImg.src = url;
}
setBG(bgIndex);
function rippleAndNext(x,y){
  const start=performance.now(), dur=1200, D=Math.hypot(innerWidth,innerHeight);
  function draw(now){
    const t=Math.min(1,(now-start)/dur);
    rpx.clearRect(0,0,innerWidth,innerHeight);
    for(let k=0;k<3;k++){
      const tt=Math.max(0,t-k*0.12);
      rpx.globalAlpha=0.28*(1-tt);
      rpx.beginPath(); rpx.arc(x,y, D*tt, 0, Math.PI*2);
      rpx.lineWidth=4*(1-tt)+1; rpx.strokeStyle='rgba(120,180,255,0.85)'; rpx.stroke();
    }
    if(t<1) requestAnimationFrame(draw);
    else { rpx.clearRect(0,0,innerWidth,innerHeight); bgIndex=(bgIndex+1)%BG_LIST.length; setBG(bgIndex); }
  }
  requestAnimationFrame(draw);
}

/* Elastic collisions (equal mass) */
function collideElastic(a,b,rest=0.98){
  const dx=a.x-b.x, dy=a.y-b.y, dist=Math.hypot(dx,dy) || 1;
  const R=(a.r||10) + (b.r||10);
  if(dist>=R) return;
  const nx=dx/dist, ny=dy/dist, overlap=R-dist+0.5;
  a.x+=nx*overlap*0.5; a.y+=ny*overlap*0.5;
  b.x-=nx*overlap*0.5; b.y-=ny*overlap*0.5;

  const avx=a.vx||0, avy=a.vy||0, bvx=b.vx||0, bvy=b.vy||0;
  const an = avx*nx + avy*ny;
  const bn = bvx*nx + bvy*ny;
  const at = -avx*ny + avy*nx;
  const bt = -bvx*ny + bvy*nx;
  const an2 = bn*rest, bn2 = an*rest;
  a.vx = an2*nx + at*(-ny);
  a.vy = an2*ny + at*( nx);
  b.vx = bn2*nx + bt*(-ny);
  b.vy = bn2*ny + bt*( nx);
}

/* Drag & throw for comets (bounce while dragging too) */
let drag={obj:null,kind:null,hist:[]};
function nearestPick(x,y){
  let best=null,bestD=1e9,kind=null;
  for(const c of comets){ const R=Math.max(18,(c.r||8)*2); const d=Math.hypot(x-c.x,y-c.y); if(d<R && d<bestD){ best=c; bestD=d; kind='comet'; } }
  return {obj:best,kind};
}
canvas.addEventListener('pointerdown', (e)=>{
  const {obj,kind}=nearestPick(e.clientX,e.clientY); if(!obj) return;
  drag={obj,kind,hist:[{x:e.clientX,y:e.clientY,t:performance.now()}]};
  obj.dragging=true; obj.x=e.clientX; obj.y=e.clientY;
  e.target.setPointerCapture && e.target.setPointerCapture(e.pointerId);
  e.preventDefault();
},{passive:false});
canvas.addEventListener('pointermove', (e)=>{
  if(!drag.obj) return; const x=e.clientX,y=e.clientY,now=performance.now();
  drag.obj.x=x; drag.obj.y=y; drag.hist.push({x,y,t:now}); while(drag.hist.length && now-drag.hist[0].t>160) drag.hist.shift();
  if(drag.kind==='comet' && drag.obj.trail){ drag.obj.trail.push([x,y,now]); if(drag.obj.trail.length>120) drag.obj.trail.shift(); }
  // While dragging: bounce off other comets & planets & sun/moon
  if (drag.kind==='comet') {
    for (const c of comets) { if(c!==drag.obj) collideElastic(drag.obj, c, 0.95); }
    if (window.planetNodes) { for (const p of planetNodes) collideElastic(drag.obj, {x:p.x, y:p.y, r:p.r, vx:0, vy:0}, 0.95); }
    const sunRect=document.getElementById('sunWrap')?.getBoundingClientRect();
    const moonRect=document.querySelector('.moon')?.getBoundingClientRect();
    if(sunRect){ collideElastic(drag.obj,{x:sunRect.left+sunRect.width/2,y:sunRect.top+sunRect.height/2,r:sunRect.width/2},0.95); }
    if(moonRect){ collideElastic(drag.obj,{x:moonRect.left+moonRect.width/2,y:moonRect.top+moonRect.height/2,r:moonRect.width/2},0.95); }
  }
},{passive:true});
canvas.addEventListener('pointerup', (e)=>{
  if(!drag.obj) return; const now=performance.now();
  const last=drag.hist[drag.hist.length-1]||{x:drag.obj.x,y:drag.obj.y,t:now}; let ref=drag.hist[0]||last;
  for(let i=drag.hist.length-1;i>=0;i--) if(now-drag.hist[i].t>=60){ ref=drag.hist[i]; break; }
  const dt=Math.max(16,last.t-ref.t); drag.obj.vx=(last.x-ref.x)/dt*1000; drag.obj.vy=(last.y-ref.y)/dt*1000;
  drag.obj.dragging=false; drag={obj:null,kind:null,hist:[]}; e.target.releasePointerCapture && e.target.releasePointerCapture(e.pointerId);
});

/* Click near ship/mini-ship → add another comet tether (up to 3) */
canvas.addEventListener('pointerdown', (e)=>{
  // nearest main ship or mini ship
  let nearest=null, best=28, isMini=false;
  for(const s of ships){ const d=Math.hypot(s.x-e.clientX,s.y-e.clientY); if(d<best){ best=d; nearest=s; isMini=false; } }
  for(const m of miniShips){ const d=Math.hypot(m.x-e.clientX,m.y-e.clientY); if(d<best){ best=d; nearest=m; isMini=true; } }
  if(nearest){
    const until = performance.now()+2200; // hold beams ~2.2s
    nearest.forceBeamUntil = until;
    if (typeof nearest.captureNextComet === 'function') nearest.captureNextComet();
  }
},{passive:true});

/* Main loop (adaptive counts) */
const MAX_SHIPS   = MOBILE ? 2 : 3;
const MINI_MAX    = MOBILE ? 10 : 20;
function loop(){
  if(!RUN){ requestAnimationFrame(loop); return; }
  const now=performance.now()/1000, dt=Math.min(.05, now-last); last=now; PERF.dt=dt; perfHeat(dt);

  const hot = PERF.heat>0.6;
  const wantComets = hot ? Math.max(1, COMET.max-1) : COMET.max;
  const wantShips  = hot ? Math.max(1, MAX_SHIPS-1) : MAX_SHIPS;
  const wantMini   = hot ? Math.max(6, MINI_MAX-6) : MINI_MAX;

  cTimer+=dt; if(cTimer>cNext && comets.length<wantComets){ comets.push(new Comet()); cTimer=0; cNext=rand(...COMET.spawn); }
  shipTimer+=dt; if(shipTimer>shipNext){ shipTimer=0; shipNext=rand(7,14); if(ships.length<wantShips) ships.push(new Ship()); }
  miniTimer+=dt; if(miniTimer>miniNext){ miniTimer=0; miniNext=rand(4,9); if(miniShips.length<wantMini) miniShips.push(new MiniShip()); }

  comets.forEach(c=>c.step(dt));
  ships.forEach(s=>s.step(dt));
  pairs.forEach(p=>p.step(dt));
  miniShips.forEach(s=>s.step(dt));

  /* comet collisions while flying */
  // comet vs comet
  for(let i=0;i<comets.length;i++){
    for(let j=i+1;j<comets.length;j++){
      const a=comets[i], b=comets[j];
      if(a.state==='pair'||b.state==='pair') continue;
      collideElastic(a,b,0.96);
    }
  }
  // comet vs planets/sun/moon
  const sunRect=document.getElementById('sunWrap')?.getBoundingClientRect();
  const moonRect=document.querySelector('.moon')?.getBoundingClientRect();
  const sx=sunRect?sunRect.left+sunRect.width/2:0, sy=sunRect?sunRect.top+sunRect.height/2:0, sr=sunRect?sunRect.width/2:0;
  const mx=moonRect?moonRect.left+moonRect.width/2:0, my=moonRect?moonRect.top+moonRect.height/2:0, mr=moonRect?moonRect.width/2:0;
  for(const c of comets){
    if(c.dragging) continue;
    if (window.planetNodes) { for (const p of planetNodes) collideElastic(c, {x:p.x,y:p.y,r:p.r,vx:0,vy:0}, 0.95); }
    if(sr) collideElastic(c,{x:sx,y:sy,r:sr},0.95);
    if(mr) collideElastic(c,{x:mx,y:my,r:mr},0.95);
  }

  // entanglement touch
  for(let i=0;i<comets.length;i++)
    for(let j=i+1;j<comets.length;j++){
      const a=comets[i], b=comets[j];
      if(a.state!=='fly'||b.state!=='fly') continue;
      if(Math.hypot(a.x-b.x) < COMET.touch){
        a.state='pair'; b.state='pair'; pairs.push(new Pair(a,b));
      }
    }

  // cleanup
  for(let i=comets.length-1;i>=0;i--) if(comets[i].dead) comets.splice(i,1);
  for(let i=pairs.length-1;i>=0;i--) if(pairs[i].dead) pairs.splice(i,1);
  for(let i=ships.length-1;i>=0;i--) if(ships[i].dead) ships.splice(i,1);
  for(let i=miniShips.length-1;i>=0;i--) if(miniShips[i].dead) miniShips.splice(i,1);

  ctx.clearRect(0,0,W,H);
  netStepDraw(dt);
  pairs.forEach(p=>p.draw());
  comets.forEach(c=>c.draw());
  miniShips.forEach(s=>s.draw());
  ships.forEach(s=>s.draw());

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Sun dragging — allow offscreen but keep ≥25% visible; click = TELEPORT */
(function enableDragSun(){
  const wrap = document.getElementById('sunWrap');
  let dragging=false, dx=0, dy=0, moved=false;
  wrap.addEventListener('pointerdown', (e)=>{
    dragging=true; moved=false; wrap.classList.add('dragging');
    const rect=wrap.getBoundingClientRect();
    dx=e.clientX-rect.left; dy=e.clientY-rect.top;
    e.preventDefault();
  }, {passive:false});
  addEventListener('pointermove', (e)=>{
    if(!dragging) return; moved=true;
    const w=wrap.offsetWidth, h=wrap.offsetHeight;
    const keep = 0.25;
    let L=e.clientX-dx, T=e.clientY-dy;
    const minL = -w*(1-keep);
    const maxL = innerWidth - w*keep;
    const minT = -h*(1-keep);
    const maxT = innerHeight - h*keep;
    L=Math.max(minL, Math.min(maxL, L));
    T=Math.max(minT, Math.min(maxT, T));
    wrap.style.left = (L + w/2) + 'px';
    wrap.style.top  = (T + h/2) + 'px';
    wrap.style.transform='translate(-50%,-50%)';
  }, {passive:true});
  addEventListener('pointerup', (e)=>{
    if(dragging && !moved){
      // single click → teleport ripple from Sun center
      const rect=wrap.getBoundingClientRect();
      rippleAndNext(rect.left+rect.width/2, rect.top+rect.height/2);
    }
    dragging=false; wrap.classList.remove('dragging');
  }, {passive:true});
})();

/* PLANET PHYSICS — pool-ball impulse; stay on screen; bounce sun/moon */
const planetNodes = [];
function buildPlanetPhysics(){
  planetNodes.length=0;
  document.querySelectorAll('.planet').forEach(el=>{
    const rect = el.getBoundingClientRect();
    const size = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--planet-size')) || 35;
    planetNodes.push({ el, x:rect.left + size/2, y:rect.top + size/2, r:size/2, vx:0, vy:0, dragging:false });
  });
}
buildPlanetPhysics(); addEventListener('resize', ()=>requestAnimationFrame(buildPlanetPhysics), {passive:true});

let pDrag=null, pHist=[];
document.getElementById('planets').addEventListener('pointerdown', (e)=>{
  const el = e.target.closest('.planet'); if(!el) return;
  const p = planetNodes.find(pp=>pp.el===el); if(!p) return;
  pDrag=p; pDrag.dragging=true; pHist=[{x:e.clientX,y:e.clientY,t:performance.now()}]; e.preventDefault();
},{passive:false});
addEventListener('pointermove', (e)=>{
  if(!pDrag) return;
  pDrag.x=e.clientX; pDrag.y=e.clientY; pDrag.el.style.left=(pDrag.x - pDrag.r)+'px'; pDrag.el.style.top=(pDrag.y - pDrag.r)+'px';
  const now=performance.now(); pHist.push({x:e.clientX,y:e.clientY,t:now}); while(pHist.length && now-pHist[0].t>160) pHist.shift();
},{passive:true});
addEventListener('pointerup', (e)=>{
  if(!pDrag) return;
  const now=performance.now(); const last=pHist[pHist.length-1]||{x:pDrag.x,y:pDrag.y,t:now}; let ref=pHist[0]||last;
  for(let i=pHist.length-1;i>=0;i--) if(now-pHist[i].t>=60){ ref=pHist[i]; break; }
  const dt=Math.max(16,last.t-ref.t);
  pDrag.vx=(last.x-ref.x)/dt*900; pDrag.vy=(last.y-ref.y)/dt*900;
  pDrag.dragging=false; pDrag=null;
});

function planetStep(){
  const sunRect  = document.getElementById('sunWrap')?.getBoundingClientRect();
  const moonRect = document.querySelector('.moon')?.getBoundingClientRect();
  const sx=sunRect?sunRect.left+sunRect.width/2:0, sy=sunRect?sunRect.top+sunRect.height/2:0, sr=sunRect?sunRect.width/2:0;
  const mx=moonRect?moonRect.left+moonRect.width/2:0, my=moonRect?moonRect.top+moonRect.height/2:0, mr=moonRect?moonRect.width/2:0;

  for(const p of planetNodes){
    if(p.dragging) continue;
    p.x+=p.vx*(1/60); p.y+=p.vy*(1/60);
    p.vx*=0.985; p.vy*=0.985; if(Math.hypot(p.vx,p.vy)<5){ p.vx=0; p.vy=0; }

    if(p.x-p.r<0){ p.x=p.r; p.vx=Math.abs(p.vx)*0.98; }
    if(p.x+p.r>innerWidth){ p.x=innerWidth-p.r; p.vx=-Math.abs(p.vx)*0.98; }
    if(p.y-p.r<0){ p.y=p.r; p.vy=Math.abs(p.vy)*0.98; }
    if(p.y+p.r>innerHeight){ p.y=innerHeight-p.r; p.vy=-Math.abs(p.vy)*0.98; }

    if(sr) collideElastic(p,{x:sx,y:sy,r:sr},0.98);
    if(mr) collideElastic(p,{x:mx,y:my,r:mr},0.98);

    p.el.style.left=(p.x-p.r)+'px'; p.el.style.top=(p.y-p.r)+'px';
  }
  for(let i=0;i<planetNodes.length;i++)
    for(let j=i+1;j<planetNodes.length;j++)
      collideElastic(planetNodes[i], planetNodes[j], 0.98);

  requestAnimationFrame(planetStep);
}
requestAnimationFrame(planetStep);

/* Keep Sun placed reasonably on first load */
function nudgeSunNow(){
  const wrap=document.getElementById('sunWrap');
  const w=wrap.offsetWidth, h=wrap.offsetHeight;
  const L = Math.max(-w*0.25, Math.min(innerWidth - w*0.75, wrap.offsetLeft||innerWidth*0.18));
  const T = Math.max(-h*0.25, Math.min(innerHeight - h*0.75, wrap.offsetTop || innerHeight*0.64));
  wrap.style.left = (L + w/2) + 'px';
  wrap.style.top  = (T + h/2) + 'px';
  wrap.style.transform='translate(-50%,-50%)';
}
addEventListener('resize', nudgeSunNow, {passive:true}); nudgeSunNow();

/* Teleport now only on Sun click (handled in sun drag block) */
</script>
</body>
</html>
