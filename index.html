<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Grand Element — Test Build (Draggable + Full Player)</title>
<style>
  :root{
    --img: https://grandelement.github.io/website/images/;

    /* Stars */
    --star-tile: 900px;

    /* Planets */
    --planet-size: 28px;
    --planet-hover-scale: 3;
    --planet-glow: 18px;

    /* Sun / Moon */
    --sun-size: 200px;
    --moon-size: 110px;
    --orbit-seconds: 60;
    --orbit-gap-moons: 2.2;
    --orbit-radius: calc((var(--sun-size)*.5) + (var(--moon-size)*var(--orbit-gap-moons)));

    /* FX */
    --comet-max: 3;
  }
  @media (max-width:700px){
    :root{
      --planet-size: 22px;
      --sun-size: 170px;
      --moon-size: 96px;
      --orbit-gap-moons: 2.4;
    }
  }

  html,body{height:100%}
  body{
    margin:0; overflow:hidden; color:#eaf2ff; background:#000;
    background-image:
      url('https://grandelement.github.io/website/images/GE%20stars.jpg'),
      radial-gradient(closest-side,#fff 1px,rgba(255,255,255,0) 1px);
    background-position:center center,0 0;
    background-repeat:repeat,repeat;
    background-size:var(--star-tile) var(--star-tile),3px 3px;
    background-attachment:fixed,scroll;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* Layers */
  #fx{ position:fixed; inset:0; z-index:1; }
  .layer-hiddentext{ position:fixed; inset:0; z-index:0; pointer-events:none; }

  /* Sun + Moon */
  .sunWrap{ position:absolute; left:18vw; top:64vh; transform:translate(-50%,-50%);
            width:var(--sun-size); height:var(--sun-size); z-index:5; }
  .sun{ position:absolute; inset:0; border-radius:50%;
        background:center/cover no-repeat url('https://grandelement.github.io/website/images/ge-logo-2.jpg');
        box-shadow:inset 0 0 60px rgba(255,255,255,.12);
        cursor:grab; }
  .sun.dragging{ cursor:grabbing; }
  .sunOverlay{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:8px; text-align:center; padding-top:8%; pointer-events:none; }
  .sunAbout{ pointer-events:auto; font-weight:900; letter-spacing:.22em; font-size:13px; opacity:.95; text-shadow:0 0 14px rgba(150,190,255,.55); cursor:pointer; }

  /* Mini player (inside sun) */
  .miniPlayer{ position:absolute; left:50%; bottom:10px; transform:translateX(-50%); width:86%;
    background:rgba(5,10,22,.55); border:1px solid rgba(220,240,255,.35); border-radius:12px; padding:6px 8px;
    box-shadow:0 8px 20px rgba(0,0,0,.45); display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center; font-size:12px; pointer-events:auto;
  }
  .controls{ display:flex; gap:6px; }
  .btn{ width:26px; height:26px; border-radius:8px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); color:#eaf2ff; font-weight:900; display:grid; place-items:center; cursor:pointer; user-select:none; }
  .btn:active{ transform:translateY(1px); }
  .toggles{ display:flex; gap:6px; }
  .toggle{ padding:3px 8px; border-radius:999px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); cursor:pointer; }
  .toggle.active{ background:rgba(40,140,255,.45); }
  .title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700; letter-spacing:.3px; }

  /* Drawer button (mobile: expands full controls) */
  .drawerBtn{ padding:3px 8px; border-radius:999px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); cursor:pointer; }

  /* Expanded player (overlay) */
  .playerOverlay{ position:fixed; inset:0; background:rgba(0,6,16,.72); display:none; place-items:center; z-index:12; }
  .playerOverlay.show{ display:grid; }
  .playerCard{ width:min(92vw,720px); background:rgba(6,14,28,.9); border:1px solid rgba(200,230,255,.35); border-radius:16px; padding:16px; box-shadow:0 24px 70px rgba(0,0,0,.6); display:grid; gap:10px; }
  .row{ display:flex; gap:10px; align-items:center; }
  .grow{ flex:1 }
  .range{ -webkit-appearance:none; width:100%; height:6px; background:rgba(200,230,255,.25); border-radius:999px; outline:none; }
  .range::-webkit-slider-thumb{ -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:#bfe2ff; border:1px solid #6fb7ff; }
  .time{ font-variant-numeric:tabular-nums; font-size:12px; opacity:.9 }

  /* Track list */
  .list{ max-height:40vh; overflow:auto; border:1px solid rgba(200,230,255,.25); border-radius:12px; padding:6px; background:rgba(8,16,28,.7); }
  .li{ padding:6px 8px; border-radius:8px; cursor:pointer; }
  .li:hover{ background:rgba(170,210,255,.15); }

  /* Orbit */
  .orbit{ position:absolute; inset:0; transform-origin:50% 50%; z-index:6; pointer-events:none; }
  .carrier{ position:absolute; left:50%; top:50%; width:0; height:0; }
  .moon{ position:absolute; left:0; top:0; transform:translate(var(--orbit-radius), -50%); width:var(--moon-size); height:var(--moon-size); border-radius:50%; cursor:pointer; pointer-events:auto; display:grid; place-items:center; }
  .moon img{ width:100%; height:100%; object-fit:cover; border-radius:50%;
    box-shadow:0 0 10px 4px rgba(140,200,255,.35); border:1px solid rgba(160,210,255,.55);
    background: radial-gradient(circle, rgba(160,210,255,.55) 0%, rgba(160,210,255,.25) 60%, rgba(160,210,255,0) 70%);
  }

  /* Planets */
  .planets{ position:fixed; inset:0; pointer-events:none; z-index:4; }
  .planet{ position:absolute; width:var(--planet-size); height:var(--planet-size); border-radius:50%; pointer-events:auto; overflow:hidden; cursor:grab;
           background:#32406b center/cover no-repeat; box-shadow:0 0 10px rgba(255,255,255,.2); transition: transform .2s ease, box-shadow .18s ease; }
  .planet.drag{ cursor:grabbing; }
  .planet:hover, .planet.touchZoom{ transform:scale(var(--planet-hover-scale)); box-shadow:0 0 var(--planet-glow) rgba(255,160,255,.65),0 0 2px 1px rgba(255,255,255,.25) inset; }
  .labelAlways{ position:absolute; left:50%; top:calc(100% + 8px); transform:translateX(-50%); padding:4px 8px; border-radius:999px; white-space:nowrap;
                 background:rgba(15,25,50,.35); border:1px solid rgba(200,220,255,.5); backdrop-filter:blur(2px); font-size:12px; letter-spacing:.3px; font-weight:700; }

  /* Hidden text */
  .phrase{ position:absolute; color:#cfe9ff; font-weight:700; text-shadow:0 2px 8px rgba(0,0,0,.9); opacity:0; transition:opacity .5s ease; }
  .phrase.show{ opacity:1; }
  .phrase.pinned{ color:#fff; text-decoration:underline; }

  /* About overlay */
  .overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:10; }
  .overlay.show{ display:grid; }
  .aboutText{ max-width:min(90vw, 820px); margin:0 16px; text-align:center; color:#eaf2ff; font-size:18px; line-height:1.6;
              text-shadow:0 0 16px rgba(150,190,255,.45),0 0 30px rgba(60,120,200,.25); }
</style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="layer-hiddentext" id="phrases"></div>

  <!-- SUN + PLAYER + MOON -->
  <div class="sunWrap" id="sunWrap">
    <div class="sun" id="sun" title="Drag me">
      <div class="sunOverlay">
        <div class="sunAbout" id="aboutBtn">ABOUT</div>

        <div class="miniPlayer" id="mini">
          <div class="controls">
            <div class="btn" id="prev" title="Prev">◀</div>
            <div class="btn" id="play" title="Play/Pause">▶</div>
            <div class="btn" id="next" title="Next">▶▶</div>
          </div>
          <div class="title" id="title">—</div>
          <div class="toggles">
            <div class="toggle active" id="tgShuffle">Shuffle</div>
            <div class="toggle" id="tgAlbum">Album</div>
            <div class="drawerBtn" id="drawer">Controls</div>
          </div>
          <audio id="gePlayer" preload="auto" playsinline></audio>
        </div>
      </div>
    </div>

    <div class="orbit" id="orbit">
      <div class="carrier">
        <div class="moon" id="moon" title="Grand Element Radio">
          <img alt="Grand Element Radio" src="https://grandelement.github.io/website/images/ge-radio-logo.png">
        </div>
      </div>
    </div>
  </div>

  <!-- EXPANDED PLAYER -->
  <div class="playerOverlay" id="pov">
    <div class="playerCard">
      <div class="row">
        <div class="btn" id="X">✕</div>
        <div class="title grow" id="bigTitle">—</div>
        <div class="toggle" id="bigShuffle">Shuffle</div>
        <div class="toggle" id="bigAlbum">Album</div>
      </div>
      <div class="row">
        <div class="btn" id="bPrev">◀</div>
        <div class="btn" id="bPlay">▶</div>
        <div class="btn" id="bNext">▶▶</div>
        <div class="time" id="tNow">0:00</div>
        <input class="range grow" type="range" id="seek" min="0" max="100" value="0" step="1">
        <div class="time" id="tDur">0:00</div>
      </div>
      <div class="row">
        <div style="font-size:12px;opacity:.9">Vol</div>
        <input class="range grow" type="range" id="vol" min="0" max="1" step="0.01" value="0.8">
      </div>
      <div class="list" id="trackList"></div>
    </div>
  </div>

  <!-- PLANETS -->
  <div class="planets" id="planets"></div>

  <!-- ABOUT -->
  <div class="overlay" id="about">
    <div class="aboutText">
      Started the summer of 2005 in Las Vegas, Nevada. Experiments in sound and communication. A journey into the soul. Created with one vision: the listener is the "GRAND ELEMENT".
      Hypnotic rhythms and spacious soundscapes leave room for reflection, opening the body and soul to the voice of energy—reminding us that we are all one, all energy, and all love.
      <br><br>
      <a href="mailto:info@grandelement.com" style="color:#dff3ff; font-weight:800; text-decoration:none;">✉ Contact</a>
    </div>
  </div>

<script>
/* ---------- Helpers ---------- */
const IMG = 'https://grandelement.github.io/website/images/';
const MOBILE = /iPhone|Android/i.test(navigator.userAgent) || innerWidth < 700;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const fmtTime=s=>{s|=0; const m=(s/60)|0, sec=('0'+(s%60)).slice(-2); return m+':'+sec;}
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]];}};

/* ---------- PLANETS (S curve) + draggable ---------- */
const ALBUMS = [
  { title:"Fundamental\u00A0Groove", cover: IMG+"Grand%20Element%20-%20Fundamental%20Groove.jpg", link:"https://grandelement.bandcamp.com/album/fundamental-groove" },
  { title:"Trio",        cover: IMG+"Grand%20Element%20-%20Trio.jpg",        link:"https://grandelement.bandcamp.com/album/trio" },
  { title:"Live!",       cover: IMG+"Grand%20Element%20-%20Live.jpg",        link:"https://grandelement.bandcamp.com/album/live" },
  { title:"Sessions I",  cover: IMG+"Grand%20Element%20-%20Sessions%20I.jpg",  link:"https://grandelement.bandcamp.com/album/sessions-i" },
  { title:"Sessions II", cover: IMG+"Grand%20Element%20-%20Sessions%20II.jpg", link:"https://grandelement.bandcamp.com/album/sessions-ii" },
  { title:"Intergy",     cover: IMG+"Grand%20Element%20-%20Intergy.jpg",     link:"https://grandelement.bandcamp.com/album/intergy" },
  { title:"Love",        cover: IMG+"Grand%20Element%20-%20Love.jpg",        link:"https://grandelement.bandcamp.com/album/love" },
  { title:"Soul",        cover: IMG+"Grand%20Element%20-%20Soul.jpg",        link:"https://grandelement.bandcamp.com/album/soul" },
  { title:"Spirit",      cover: IMG+"Grand%20Element%20-%20Spirit.jpg",      link:"https://grandelement.bandcamp.com/album/spirit" },
  { title:"Fire",        cover: IMG+"Grand%20Element%20-%20Fire.jpg",        link:"https://grandelement.bandcamp.com/album/fire" }
];
const planetsEl = document.getElementById('planets');
const planetNodes=[];
function placeSpiral(){
  planetsEl.innerHTML=""; planetNodes.length=0;
  const w = innerWidth, h = innerHeight;
  const xCenter = w * 0.56, yBottom = h * 0.88, yTop = h * 0.14;
  const amp = Math.max(80, w * 0.12), waves = 1.2;
  ALBUMS.forEach((alb,i)=>{
    const t = i/(ALBUMS.length-1);
    const y = yBottom - t*(yBottom - yTop);
    const x = xCenter + amp * Math.sin((t * Math.PI * 2 * waves) - Math.PI/2);
    const a = document.createElement('a');
    a.className='planet'; a.style.left=x+'px'; a.style.top=y+'px';
    a.href=alb.link; a.target='_blank'; a.rel='noopener'; a.title=alb.title;
    a.style.backgroundImage = `url('${alb.cover}')`;
    a.innerHTML = `<div class="labelAlways">${alb.title}</div>`;
    planetsEl.appendChild(a);
    planetNodes.push(a);
    makeDraggable(a);
  });
}
placeSpiral(); addEventListener('resize', placeSpiral, {passive:true});

/* ---------- HIDDEN TEXT ---------- */
const phrasesEl = document.getElementById('phrases');
let PHRASES=[];
fetch('https://grandelement.github.io/website/data/hidden.txt').then(r=>r.ok?r.text():'').then(t=>{
  PHRASES = t.split(/[\,\r?\n]/).map(s=>s.trim().replace(/,+$/,'')).filter(Boolean);
  const n=Math.max(10,PHRASES.length||10);
  for(let i=0;i<n;i++){
    const el=document.createElement('div'); el.className='phrase'; el.textContent=PHRASES[i % (PHRASES.length||1)]||'';
    el.style.left=(10+Math.random()*(innerWidth-220))+'px'; el.style.top=(10+Math.random()*(innerHeight-120))+'px';
    el.addEventListener('click',()=>el.classList.toggle('pinned')); phrasesEl.appendChild(el);
  }
});
let px=-9999,py=-9999; addEventListener('pointermove',e=>{px=e.clientX; py=e.clientY;},{passive:true});
setInterval(()=>{const r=Math.min(innerWidth,innerHeight)*.12; [...phrasesEl.children].forEach(el=>{
  if(el.classList.contains('pinned')){el.classList.add('show'); return;}
  const b=el.getBoundingClientRect(), cx=b.left+b.width/2, cy=b.top+b.height/2;
  (Math.hypot(px-cx,py-cy)<r) ? el.classList.add('show') : el.classList.remove('show');
});},90);

/* ---------- ABOUT ---------- */
const aboutBtn=document.getElementById('aboutBtn'), aboutEl=document.getElementById('about');
aboutBtn.addEventListener('click',()=>aboutEl.classList.add('show'));
aboutEl.addEventListener('click',e=>{if(e.target.id==='about') aboutEl.classList.remove('show');});
addEventListener('keydown',e=>{if(e.key==='Escape') aboutEl.classList.remove('show');});

/* ---------- SUN DRAG + MOON ORBIT (clock, counter-rotate, slow radial breathing) ---------- */
const sunWrap=document.getElementById('sunWrap'), sun=document.getElementById('sun'), orbit=document.getElementById('orbit'), moon=document.getElementById('moon');
let sunDrag=false, sx=0, sy=0, ox=0, oy=0;
function setSunPos(x,y){ sunWrap.style.left=x+'px'; sunWrap.style.top=y+'px'; }
sun.addEventListener('pointerdown',e=>{ sunDrag=true; sun.classList.add('dragging'); sun.setPointerCapture(e.pointerId); const r=sunWrap.getBoundingClientRect(); sx=e.clientX; sy=e.clientY; ox=r.left+r.width/2; oy=r.top+r.height/2; });
sun.addEventListener('pointermove',e=>{ if(!sunDrag) return; const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy); setSunPos(clamp(nx,100,innerWidth-100), clamp(ny,100,innerHeight-100)); });
sun.addEventListener('pointerup',e=>{ sunDrag=false; sun.classList.remove('dragging'); });

const ORBIT_SEC=60, PHASE0=-Math.PI/2;
const BASE_R=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--orbit-radius'))||260;
const OSC_PX=30, OSC_SEC=90;
function tickOrbit(){
  const t=Date.now()/1000;
  const angle=PHASE0 + (t%ORBIT_SEC)/ORBIT_SEC*Math.PI*2;
  const r=BASE_R + OSC_PX*Math.sin((t/OSC_SEC)*Math.PI*2);
  orbit.style.transform=`rotate(${angle}rad)`;
  moon.style.transform=`translate(${r}px, -50%) rotate(${-angle}rad)`;
  orbit.style.zIndex = (angle%(Math.PI*2))>Math.PI ? 2 : 6;
  requestAnimationFrame(tickOrbit);
}
requestAnimationFrame(tickOrbit);
moon.addEventListener('click',()=>window.open('https://grandelement.github.io/radio/','_blank','noopener'));

/* ---------- MUSIC: auto-discover MP3s (GitHub API), full controls, list ---------- */
const PLAYER=document.getElementById('gePlayer');
const titleEl=document.getElementById('title');
const prevBtn=document.getElementById('prev'), playBtn=document.getElementById('play'), nextBtn=document.getElementById('next');
const tgShuffle=document.getElementById('tgShuffle'), tgAlbum=document.getElementById('tgAlbum');
const drawerBtn=document.getElementById('drawer');
const pov=document.getElementById('pov'), bigTitle=document.getElementById('bigTitle'), X=document.getElementById('X');
const bPrev=document.getElementById('bPrev'), bPlay=document.getElementById('bPlay'), bNext=document.getElementById('bNext');
const seek=document.getElementById('seek'), tNow=document.getElementById('tNow'), tDur=document.getElementById('tDur'), vol=document.getElementById('vol');
const bigShuffle=document.getElementById('bigShuffle'), bigAlbum=document.getElementById('bigAlbum'), trackList=document.getElementById('trackList');
let PLAYLIST=[], pIndex=0, SHUFFLE=true, RUN=true;

function setTitle(i){ if(!PLAYLIST[i]){titleEl.textContent=bigTitle.textContent='—'; return;}
  const item=PLAYLIST[i]; const album=item.album.replace(/^Grand Element\s*-\s*\d{4}\s*-\s*/,'');
  const t= `${album} · ${item.track}`; titleEl.textContent=t; bigTitle.textContent=t;
}
function applyModeButtons(){
  (SHUFFLE?tgShuffle:tgAlbum).classList.add('active'); (SHUFFLE?tgAlbum:tgShuffle).classList.remove('active');
  (SHUFFLE?bigShuffle:bigAlbum).classList.add('active'); (SHUFFLE?bigAlbum:bigShuffle).classList.remove('active');
}
function loadAndPlay(i=pIndex){ if(!PLAYLIST.length) return; pIndex=(i+PLAYLIST.length)%PLAYLIST.length; PLAYER.src=PLAYLIST[pIndex].url; setTitle(pIndex);
  PLAYER.autoplay=true; PLAYER.muted=true; PLAYER.play().catch(()=>{}); playBtn.textContent=bPlay.textContent='❚❚'; highlightList(); }
function next(){ pIndex=(pIndex+1)%PLAYLIST.length; loadAndPlay(); }
function prev(){ pIndex=(pIndex-1+PLAYLIST.length)%PLAYLIST.length; loadAndPlay(); }

playBtn.onclick = ()=>{ if(PLAYER.paused){ PLAYER.play().catch(()=>{}); playBtn.textContent=bPlay.textContent='❚❚'; } else { PLAYER.pause(); playBtn.textContent=bPlay.textContent='▶'; } };
nextBtn.onclick=next; prevBtn.onclick=prev;
bPlay.onclick  = playBtn.onclick; bNext.onclick=next; bPrev.onclick=prev;

tgShuffle.onclick = ()=>{ SHUFFLE=true; applyModeButtons(); if(PLAYLIST.length){ const base=[...PLAYLIST].sort(sortAlbum); PLAYLIST=base.slice(); shuffle(PLAYLIST); loadAndPlay(0); } };
tgAlbum.onclick   = ()=>{ SHUFFLE=false; applyModeButtons(); if(PLAYLIST.length){ PLAYLIST.sort(sortAlbum); loadAndPlay(0); } };
bigShuffle.onclick=tgShuffle.onclick; bigAlbum.onclick=tgAlbum.onclick;

document.addEventListener('visibilitychange',()=>{ RUN=!document.hidden; if(!document.hidden && PLAYER.paused) PLAYER.play().catch(()=>{}); });
function unmuteOnce(){ PLAYER.muted=false; PLAYER.play().catch(()=>{}); window.removeEventListener('pointerdown', unmuteOnce, {capture:true}); }
window.addEventListener('pointerdown', unmuteOnce, {capture:true, once:true});

PLAYER.addEventListener('timeupdate',()=>{ if(PLAYER.duration){ seek.value = (PLAYER.currentTime/PLAYER.duration*100)|0; tNow.textContent=fmtTime(PLAYER.currentTime); tDur.textContent=fmtTime(PLAYER.duration|0); } });
seek.addEventListener('input',()=>{ if(PLAYER.duration) PLAYER.currentTime = (seek.value/100)*PLAYER.duration; });
vol.addEventListener('input',()=>{ PLAYER.volume = +vol.value; });

PLAYER.addEventListener('ended', next);
PLAYER.addEventListener('error', next);

drawerBtn.onclick = ()=>{ pov.classList.add('show'); };
X.onclick = ()=>{ pov.classList.remove('show'); };

function sortAlbum(a,b){ return a.album.localeCompare(b.album)||a.trackNum-b.trackNum; }
function renderList(){
  trackList.innerHTML = PLAYLIST.map((it,idx)=>`<div class="li" data-i="${idx}">${it.album.replace(/^Grand Element\s*-\s*\d{4}\s*-\s*/,'')} · ${it.track}</div>`).join('');
  trackList.querySelectorAll('.li').forEach(el=>el.onclick=()=>{ SHUFFLE=false; applyModeButtons(); PLAYLIST.sort(sortAlbum); loadAndPlay(+el.dataset.i); });
}
function highlightList(){
  [...trackList.children].forEach((el,i)=> el.style.background = (i===pIndex)?'rgba(170,210,255,.25)':'transparent');
}

async function fetchAllMp3s(){
  const r=await fetch('https://api.github.com/repos/grandelement/radio/git/trees/main?recursive=1',
                      {headers:{'Accept':'application/vnd.github+json'}});
  if(!r.ok) return [];
  const data=await r.json();
  return (data.tree||[])
    .filter(n=>n.type==='blob' && /\.mp3$/i.test(n.path))
    .map(n=>{
      const parts=n.path.split('/'); const album=decodeURIComponent(parts[1]||'Unknown');
      const file=decodeURIComponent(parts.pop());
      const num=(file.match(/^\s*(\d{1,3})/)||[])[1]; const tnum=num?+num:9999;
      return { url:`https://grandelement.github.io/radio/${encodeURI(n.path)}`, album, trackNum:tnum,
               track:file.replace(/\.[^.]+$/,'').replace(/^\s*\d+\s*[-_.]?\s*/,'') };
    });
}
(async function initMusic(){
  let items = await fetchAllMp3s();
  if(!items.length){ titleEl.textContent=bigTitle.textContent="No MP3s found under radio/music/"; return; }
  items.sort(sortAlbum);
  if(SHUFFLE){ PLAYLIST = items.slice(); shuffle(PLAYLIST); } else { PLAYLIST = items; }
  renderList(); applyModeButtons(); loadAndPlay(0);
})();

/* ---------- DRAGGABLE helper (for planets) ---------- */
function makeDraggable(el){
  let drag=false, sx=0, sy=0, ox=0, oy=0;
  el.addEventListener('pointerdown',e=>{ drag=true; el.classList.add('drag'); el.setPointerCapture(e.pointerId); const r=el.getBoundingClientRect(); sx=e.clientX; sy=e.clientY; ox=r.left; oy=r.top; e.preventDefault(); });
  el.addEventListener('pointermove',e=>{ if(!drag) return; const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy); el.style.left=nx+'px'; el.style.top=ny+'px'; });
  el.addEventListener('pointerup',()=>{ drag=false; el.classList.remove('drag'); });
}

/* ---------- FX: comets + GE ships + fling ---------- */
const canvas=document.getElementById('fx'), ctx=canvas.getContext('2d');
let W=innerWidth,H=innerHeight; function resize(){ W=innerWidth; H=innerHeight; canvas.width=W; canvas.height=H; } addEventListener('resize',resize,{passive:true}); resize();
const cometImg=new Image(); cometImg.src=IMG+'ge-logo%203.png';
const shipImg =new Image(); shipImg.src =IMG+'ge-logo-4-cutout.png';

const COMET={sizes:[8,10,12,16], max:parseInt(getComputedStyle(document.documentElement).getPropertyValue('--comet-max'))||3, spawn:[4,9], speed:[60,140], trail:80, fade:1200, touch:26};
const MAX_SHIPS = MOBILE?3:4, SHIP_SCALES = MOBILE?[0.08,0.12,0.16,0.20]:[0.10,0.14,0.19,0.22,0.26];
const MINI_MAX=10, MINI_SCALES=MOBILE?[0.035,0.045]:[0.04,0.055];
const SHIP_ART_OFFSET=Math.PI;
const rand=(a,b)=>Math.random()*(b-a)+a, choice=a=>a[(Math.random()*a.length)|0];

class Comet{
  constructor(){
    const edge=choice(['l','r','t','b']), pad=40;
    if(edge==='l'){this.x=-pad; this.y=rand(0,H);}
    if(edge==='r'){this.x=W+pad; this.y=rand(0,H);}
    if(edge==='t'){this.x=rand(0,W); this.y=-pad;}
    if(edge==='b'){this.x=rand(0,W); this.y=H+pad;}
    const tx=rand(W*.2,W*.8), ty=rand(H*.2,H*.8), a=Math.atan2(ty-this.y, tx-this.x), s=rand(...COMET.speed);
    this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s; this.r=choice(COMET.sizes); this.trail=[]; this.dead=false; this.state='fly';
  }
  step(dt){ if(this.state!=='fly'&&this.state!=='separate') return; this.x+=this.vx*dt; this.y+=this.vy*dt; this.trail.push([this.x,this.y,performance.now()]); if(this.trail.length>COMET.trail) this.trail.shift();
            if(this.x<-90||this.x>W+90||this.y<-90||this.y>H+90) this.dead=true; }
  draw(){ for(const [tx,ty,ts] of this.trail){ const a=Math.max(0,1-(performance.now()-ts)/COMET.fade); if(a<=0) continue; ctx.globalAlpha=a*.6; ctx.drawImage(cometImg,tx-this.r,ty-this.r,this.r*2,this.r*2); }
         ctx.globalAlpha=1; ctx.drawImage(cometImg,this.x-this.r,this.y-this.r,this.r*2,this.r*2); }
}
class MiniShip{ constructor(){ this.s=rand(...MINI_SCALES); const side=choice(['l','r','t','b']), pad=40;
   if(side==='l'){ this.x=-pad; this.y=rand(0,H); this.vx=rand(15,45); this.vy=rand(-20,20);}
   if(side==='r'){ this.x=W+pad; this.y=rand(0,H); this.vx=-rand(15,45); this.vy=rand(-20,20);}
   if(side==='t'){ this.x=rand(0,W); this.y=-pad; this.vx=rand(-35,35); this.vy=rand(15,45);}
   if(side==='b'){ this.x=rand(0,W); this.y=H+pad; this.vx=rand(-35,35); this.vy=-rand(15,45);} this.dead=false; }
  step(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; if(this.x<-100||this.x>W+100||this.y<-100||this.y>H+100) this.dead=true; }
  draw(){ if(!shipImg.complete) return; ctx.save(); ctx.globalAlpha=.45; const ang=Math.atan2(this.vy,this.vx)+Math.PI; const w=shipImg.width*this.s, h=shipImg.height*this.s; ctx.translate(this.x,this.y); ctx.rotate(ang); ctx.drawImage(shipImg,-w*.3,-h*.5,w*.6,h*.6); ctx.restore(); }
}
class Ship{ constructor(){ const side=choice(['l','r','t','b']); this.s=choice(SHIP_SCALES); const pad=60;
   if(side==='l'){this.x=-pad; this.y=rand(0,H); this.vx=rand(80,220); this.vy=rand(-80,80);}
   if(side==='r'){this.x=W+pad; this.y=rand(0,H); this.vx=-rand(80,220); this.vy=rand(-80,80);}
   if(side==='t'){this.x=rand(0,W); this.y=-pad; this.vx=rand(-180,180); this.vy=rand(80,220);}
   if(side==='b'){this.x=rand(0,W); this.y=H+pad; this.vx=rand(-180,180); this.vy=-rand(80,220);}
   this.dead=false; }
  step(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; if(this.x<-140||this.x>W+140||this.y<-140||this.y>H+140) this.dead=true; }
  draw(){ if(!shipImg.complete) return; const ang=Math.atan2(this.vy,this.vx)+SHIP_ART_OFFSET; const w=shipImg.width*this.s, h=shipImg.height*this.s; ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(ang); ctx.drawImage(shipImg,-w*.3,-h*.5,w*.6,h*.6); ctx.restore(); }
}

const comets=[], ships=[], minis=[];
let last=performance.now()/1000, tC=0, nC=rand(4,9), tS=0, nS=rand(6,12), tM=0, nM=rand(5,12);
function loop(){
  if(!RUN){ requestAnimationFrame(loop); return; }
  const now=performance.now()/1000, dt=Math.min(.05, now-last); last=now;
  tC+=dt; if(tC>nC && comets.length<COMET.max){ comets.push(new Comet()); tC=0; nC=rand(4,9); }
  tS+=dt; if(tS>nS){ tS=0; nS=rand(6,14); if(ships.length< (MOBILE?3:4)) ships.push(new Ship()); }
  tM+=dt; if(tM>nM){ tM=0; nM=rand(5,12); if(minis.length<10) minis.push(new MiniShip()); }

  comets.forEach(c=>c.step(dt)); ships.forEach(s=>s.step(dt)); minis.forEach(s=>s.step(dt));
  for(let i=comets.length-1;i>=0;i--) if(comets[i].dead) comets.splice(i,1);
  for(let i=ships.length-1;i>=0;i--) if(ships[i].dead) ships.splice(i,1);
  for(let i=minis.length-1;i>=0;i--) if(minis[i].dead) minis.splice(i,1);

  ctx.clearRect(0,0,W,H);
  comets.forEach(c=>c.draw()); minis.forEach(s=>s.draw()); ships.forEach(s=>s.draw());
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Grab & fling comets */
let grab=null, lastPts=[];
canvas.addEventListener('pointerdown',e=>{
  const x=e.clientX,y=e.clientY; let best=null,bd=1e9;
  for(const c of comets){ const d=Math.hypot(x-c.x,y-c.y); if(d<Math.max(26,c.r*1.6) && d<bd){bd=d; best=c;} }
  if(best){ grab=best; lastPts.length=0; }
});
canvas.addEventListener('pointermove',e=>{
  if(!grab) return; grab.x=e.clientX; grab.y=e.clientY; lastPts.push([e.clientX,e.clientY,performance.now()]);
  if(lastPts.length>5) lastPts.shift();
});
canvas.addEventListener('pointerup',()=>{
  if(!grab) return;
  if(lastPts.length>=2){
    const a=lastPts[0], b=lastPts[lastPts.length-1]; const dt=(b[2]-a[2])/1000||.016;
    grab.vx=(b[0]-a[0])/dt; grab.vy=(b[1]-a[1])/dt;
  }
  grab=null; lastPts.length=0;
});

/* Sun keep-away from left edge so orbit never clips */
function nudgeSun(){ const r=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--orbit-radius'))||260; const rect=sunWrap.getBoundingClientRect(); if(rect.left<r+90) setSunPos(r+90, rect.top+rect.height/2); }
addEventListener('resize', nudgeSun, {passive:true}); nudgeSun();
</script>
</body>
</html>
