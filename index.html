<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GE Universe — Modular Bundle</title>
<link rel="stylesheet" href="modules/core.css">
<style>
  body{ background:#000 url("images/GE%20stars.jpg") center/cover no-repeat fixed; }
  #stage{ position:fixed; inset:0 }
  #bg,#fx,#ripple{ position:absolute; inset:0 }
  #fx{ z-index:2 } #ripple{ z-index:3; pointer-events:none }
  #diag{ position:fixed; right:10px; top:10px; z-index:9999; width:380px; max-height:72dvh; overflow:auto;
    background:rgba(10,18,30,.9); border:1px solid rgba(200,220,255,.35); border-radius:12px; padding:10px 12px; color:#eaf2ff; font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif }
  #diag h1{ margin:0 0 8px 0; font-size:14px; letter-spacing:.15em; opacity:.9 }
  .controls{ display:flex; gap:8px; margin:8px 0 4px }
  button{ background:#0f2238; color:#eaf2ff; border:1px solid rgba(200,220,255,.35); border-radius:8px; padding:6px 10px; cursor:pointer }
  .row{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:start; padding:6px 0; border-top:1px dashed rgba(200,220,255,.2) }
  .row:first-of-type{ border-top:0 }
  .name{ font-weight:600; word-break:break-all }
  .badge{ padding:3px 8px; border-radius:999px; font-weight:700; font-size:12px; white-space:nowrap }
  .ok{ background:rgba(56,217,159,.15); border:1px solid rgba(56,217,159,.45); color:#38d99f }
  .warn{ background:rgba(255,204,102,.12); border:1px solid rgba(255,204,102,.45); color:#ffcc66 }
  .err{ background:rgba(255,107,107,.12); border:1px solid rgba(255,107,107,.45); color:#ff6b6b }
  .msg{ grid-column:1/-1; opacity:.9; font-size:12px; margin-top:4px; white-space:pre-wrap }
  #foot{ position:fixed; left:10px; bottom:10px; font-size:12px; opacity:.85; background:rgba(10,18,30,.9); border:1px solid rgba(200,220,255,.35); border-radius:999px; padding:6px 10px; color:#eaf2ff }
</style>
</head>
<body>

<div id="stage">
  <canvas id="bg"></canvas>
  <canvas id="fx"></canvas>
  <canvas id="ripple"></canvas>
</div>

<div id="diag" role="region" aria-label="Module diagnostics">
  <h1>GE Loader • modules/</h1>
  <div class="controls">
    <button id="reload">Reload</button>
    <button id="min">Minimize</button>
  </div>
  <div id="list"></div>
</div>
<div id="foot">Starting…</div>

<script>
/* ---------- PATHS ---------- */
const BASE = 'modules/'; // change to 'https://grandelement.github.io/website/modules/' for live GitHub Pages

/* ---------- SHARED SDK ---------- */
window.GE_ENV = {
  BASE, IMAGES:'images/', DATA:'data/',
  marks:{}, mark:(name,msg)=>{ GE_ENV.marks[name]=msg||'started'; },
  readyHooks:[], log:(...a)=>console.log('[GE]',...a), error:(...a)=>console.error('[GE]',...a)
};

/* ---------- CANVASES ---------- */
(function bootstrapStage(){
  const bg = document.getElementById('bg');
  const fx = document.getElementById('fx');
  const rp = document.getElementById('ripple');
  function fit(){ for(const c of [bg,fx,rp]){ c.width=innerWidth; c.height=innerHeight; } }
  addEventListener('resize',fit,{passive:true}); fit();
  window.GE_CANVAS = { bg, fx, ripple: rp, bgCtx:bg.getContext('2d'), fxCtx:fx.getContext('2d'), rippleCtx:rp.getContext('2d') };
})();

/* ---------- DIAG UI ---------- */
const $ = (s,p=document)=>p.querySelector(s), list=$('#list'), foot=$('#foot');
function rowFor(item){ const r=document.createElement('div'); r.className='row';
  r.innerHTML=`<div class="name">${item.name}</div><div class="badge warn">…</div><div class="msg">${item.note||''}</div>`; return r; }
function setBadge(row,cls,txt){ const b=row.querySelector('.badge'); b.className='badge '+cls; b.textContent=txt; }
function setMsg(row,msg){ row.querySelector('.msg').textContent=msg||''; }
document.getElementById('min').onclick=()=>{ const d=document.getElementById('diag'); if(d.style.height==='28px'){ d.style.height=''; d.style.overflow='auto'; } else { d.style.height='28px'; d.style.overflow='hidden'; } };
document.getElementById('reload').onclick=()=>runLoader(true);

/* ---------- MODULES TO LOAD ---------- */
const CANDIDATES = [
  { name:'core.js',       note:'Core utilities & globals.', required:true },
  { name:'background.js', note:'Starfield + ships.', required:false },
  { name:'fx.js',         note:'Ripple + background shuffle.', required:false },
  { name:'sun_moon.js',   note:'Blue sun + 60s moon orbit.', required:false },
  { name:'planets.js',    note:'Albums (grab/throw/bounce).', required:false },
  { name:'game.js',       note:'Comets with tails + bounce.', required:false },
  { name:'hidden_text.js',note:'Hidden phrases layer.', required:false },
  { name:'mini_player.js',note:'Audio player.', required:false },
  { name:'app.js',        note:'App wiring.', required:false }
];

async function fetchText(url){
  try{
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) return {ok:false,status:r.status,statusText:r.statusText};
    return {ok:true,text:await r.text()};
  }catch(e){ return {ok:false,error:String(e)}; }
}

function loadJS_inline(name, code, asModule){
  return new Promise(res=>{
    const blob=new Blob([code+`\\n//# sourceURL=${name}`],{type:'text/javascript'});
    const url=URL.createObjectURL(blob);
    const s=document.createElement('script'); s.src=url; if(asModule) s.type='module'; s.defer=true;
    s.onload=()=>{ URL.revokeObjectURL(url); res({ok:true}); };
    s.onerror=()=>{ URL.revokeObjectURL(url); res({ok:false,error:'inline script error'}); };
    document.head.appendChild(s);
  });
}

async function tryLoad(item, row){
  setBadge(row,'warn','loading');
  const url = BASE + item.name;
  const r = await fetchText(url);
  if(!r.ok){ setBadge(row,item.required?'err':'warn',item.required?'missing':'missing'); setMsg(row, r.status?`${r.status} ${r.statusText}`:r.error); return false; }
  const src=r.text;
  const hasES = /(^\\s*import\\s+|\\bexport\\s+)/m.test(src);
  const wrapped = hasES ? src : `try{(function(){\\n${src}\\n})();}catch(e){console.error('GE classic error in ${item.name}:',e);}`;
  const out = await loadJS_inline(item.name, wrapped, hasES);
  if(!out.ok){ setBadge(row,item.required?'err':'warn','failed'); setMsg(row,out.error||'load error'); return false; }
  setBadge(row,'ok','loaded');
  setTimeout(()=>{ // give the module a moment to call GE_ENV.mark()
    if(!GE_ENV.marks[item.name]){ setBadge(row,'warn','no init'); setMsg(row,'Module loaded but did not call GE_ENV.mark("'+item.name+'").'); }
    else { setBadge(row,'ok','started'); setMsg(row, GE_ENV.marks[item.name]); }
  }, 600);
  return true;
}

async function runLoader(reset=false){
  if(reset){ list.innerHTML=''; foot.textContent='Reloading…'; }
  const rows={}; for(const it of CANDIDATES){ const r=rowFor(it); list.appendChild(r); rows[it.name]=r; }
  let fail=0;
  for(const it of CANDIDATES){
    const ok = await tryLoad(it, rows[it.name]);
    if(!ok && it.required) fail++;
  }
  foot.textContent = fail ? `Loaded with ${fail} required error(s).` : 'All required modules loaded.';
  try{ (GE_ENV.readyHooks||[]).forEach(fn=>{ try{ fn&&fn(); }catch(e){ console.error('readyHook error',e); } }); }
  finally{ foot.textContent += ' Post-inits done.'; }
}
runLoader();
</script>
</body>
</html>
