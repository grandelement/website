<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GE Universe — Modular Loader</title>
<style>
  :root {
    --ok: #38d99f;
    --warn: #ffcc66;
    --err: #ff6b6b;
    --ink: #eaf2ff;
    --glass: rgba(10,18,30,.9);
    --line: rgba(200,220,255,.35);
  }
  html,body { height:100% }
  body {
    margin:0; background:#000 url("images/GE%20stars.jpg") center/cover no-repeat fixed;
    color:var(--ink); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden;
  }

  /* minimal stage so existing modules have somewhere to draw */
  #stage { position:fixed; inset:0; }
  #bg, #fx, #ripple { position:absolute; inset:0; }
  #bg { z-index:0 }
  #fx { z-index:2 }
  #ripple { z-index:3; pointer-events:none }

  /* diagnostic panel */
  #diag {
    position:fixed; right:10px; top:10px; z-index:9999;
    width:360px; max-height:70dvh; overflow:auto;
    background:var(--glass); border:1px solid var(--line); border-radius:12px; padding:10px 12px;
    box-shadow:0 12px 32px rgba(0,0,0,.45);
  }
  #diag h1 { margin:0 0 8px 0; font-size:14px; letter-spacing:.15em; opacity:.9 }
  #diag .row { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:start; padding:6px 0; border-top:1px dashed rgba(200,220,255,.2) }
  #diag .row:first-of-type { border-top:0 }
  .name { font-weight:600; word-break:break-all }
  .badge { padding:3px 8px; border-radius:999px; font-weight:700; font-size:12px; white-space:nowrap; }
  .ok { background: rgba(56,217,159,.15); border:1px solid rgba(56,217,159,.45); color:var(--ok) }
  .warn { background: rgba(255,204,102,.12); border:1px solid rgba(255,204,102,.45); color:var(--warn) }
  .err { background: rgba(255,107,107,.12); border:1px solid rgba(255,107,107,.45); color:var(--err) }
  .msg { grid-column:1 / -1; opacity:.9; font-size:12px; margin-top:4px; white-space:pre-wrap }
  .controls { display:flex; gap:8px; margin:8px 0 4px }
  button { background:#0f2238; color:var(--ink); border:1px solid var(--line); border-radius:8px; padding:6px 10px; cursor:pointer }
  button:active { transform: translateY(1px) }

  /* tiny sticky footer for quick status */
  #foot { position:fixed; left:10px; bottom:10px; font-size:12px; opacity:.85; background:var(--glass); border:1px solid var(--line); border-radius:999px; padding:6px 10px }
</style>
</head>
<body>

<div id="stage" aria-hidden="true">
  <canvas id="bg"></canvas>
  <canvas id="fx"></canvas>
  <canvas id="ripple"></canvas>
</div>

<div id="diag" role="region" aria-label="Module diagnostics">
  <h1>GE Loader • modules/</h1>
  <div class="controls">
    <button id="reload">Reload modules</button>
    <button id="toggle">Minimize</button>
  </div>
  <div id="list"></div>
</div>

<div id="foot">Starting…</div>

<script>
/* =============== CONFIG =============== */
/* Base path containing your JS/CSS modules */
const BASE = 'modules/';

/* Candidate files to try (edit to taste). Order matters. */
const CANDIDATES = [
  { name:'core.css',    type:'css',  optional:false, note:'Base styles for site.' },
  { name:'core.js',     type:'js',   optional:false, note:'Core utilities & globals.' },
  { name:'background.js',type:'js',  optional:true,  note:'Star/background manager.' },
  { name:'sun_moon.js', type:'js',   optional:true,  note:'Blue sun + orbiting moon.' },
  { name:'planets.js',  type:'js',   optional:true,  note:'Album planets & physics.' },
  { name:'fx.js',       type:'js',   optional:true,  note:'Ripple, links, and visual FX.' },
  { name:'game.js',     type:'js',   optional:true,  note:'Comets / Quantum game.' },
  { name:'hidden_text.js',type:'js', optional:true,  note:'Hidden text layer.' },
  { name:'mini_player.js',type:'js', optional:true,  note:'Audio player (shuffle/album).' },
  { name:'app.js',      type:'js',   optional:true,  note:'App bootstrap/wiring.' }
];

/* Give modules helpful globals to discover environment */
window.GE_ENV = {
  BASE,                // where modules live
  IMAGES: 'images/',   // images base
  DATA: 'data/',       // data base (e.g., hidden.txt)
  log: (...a)=>console.log('[GE]',...a),
  error: (...a)=>console.error('[GE]',...a),
  readyHooks: [],      // modules can push a function to run after all loads
};

/* =============== DIAGNOSTICS UI =============== */
const $ = (s,p=document)=>p.querySelector(s);
const list = $('#list');
const foot = $('#foot');

function rowFor(item){
  const row = document.createElement('div');
  row.className = 'row';
  row.innerHTML = `
    <div class="name">${item.name}</div>
    <div class="badge warn">…</div>
    <div class="msg">${item.note||''}</div>
  `;
  return row;
}
function setBadge(row, cls, text){ const b = $('.badge', row); b.className = 'badge '+cls; b.textContent = text; }
function setMsg(row, msg){ $('.msg', row).textContent = msg || ''; }

$('#toggle').onclick = ()=>{
  const d = $('#diag');
  if (d.style.height === '28px'){ d.style.height=''; d.style.overflow='auto'; $('#toggle').textContent='Minimize'; }
  else { d.style.height='28px'; d.style.overflow='hidden'; $('#toggle').textContent='Expand'; }
};

$('#reload').onclick = ()=>runLoader(true);

/* =============== LOADER =============== */
async function headCheck(url){
  try {
    // Using GET because some servers reject HEAD for static hosting; keep it lightweight
    const r = await fetch(url, { method: 'GET', cache: 'no-store' });
    if (!r.ok) return { ok:false, status:r.status, statusText:r.statusText };
    // Don’t consume body; we only check existence / CORS
    return { ok:true };
  } catch (e){
    return { ok:false, error: String(e && e.message || e) };
  }
}

function loadCSS(url){
  return new Promise((resolve)=>{
    const link = document.createElement('link');
    link.rel='stylesheet'; link.href=url;
    link.onload = ()=>resolve({ ok:true });
    link.onerror = ()=>resolve({ ok:false, error:'link onerror (path or CORS)' });
    document.head.appendChild(link);
  });
}

function loadScript(url){
  return new Promise((resolve)=>{
    const s = document.createElement('script');
    s.src = url;     // vanilla scripts expected
    s.defer = true;  // let HTML parse complete first
    s.onload = ()=>resolve({ ok:true });
    s.onerror = ()=>resolve({ ok:false, error:'script onerror (path or CORS)' });
    document.head.appendChild(s);
  });
}

async function tryLoad(item, row){
  const url = BASE + item.name;
  setBadge(row,'warn','checking');

  // 1) Probe availability (gives better message than only onerror)
  const head = await headCheck(url);
  if (!head.ok){
    const why = head.status ? `${head.status} ${head.statusText||''}`.trim() : (head.error || 'unknown error');
    if (item.optional){
      setBadge(row,'warn','missing');
      setMsg(row, `Optional. Not found or blocked: ${why}`);
      return { ok:false, optional:true };
    } else {
      setBadge(row,'err','required missing');
      setMsg(row, `Required module missing or blocked: ${why}`);
      return { ok:false, optional:false };
    }
  }

  // 2) Attempt to load
  setBadge(row,'warn','loading');
  const res = item.type==='css' ? await loadCSS(url) : await loadScript(url);

  if (res.ok){
    setBadge(row,'ok','loaded');
    setMsg(row, item.note||'');
    return { ok:true };
  } else {
    const label = item.optional ? 'failed (optional)' : 'failed';
    setBadge(row, item.optional ? 'warn' : 'err', label);
    setMsg(row, `${res.error||'unknown load failure'}`);
    return { ok:false, optional:item.optional };
  }
}

async function runLoader(reset=false){
  if (reset){ list.innerHTML=''; foot.textContent='Reloading…'; }
  window.GE_ENV.loadResults = {};
  const rows = {};
  for (const it of CANDIDATES){ const r = rowFor(it); list.appendChild(r); rows[it.name]=r; }

  let requiredFailures = 0;
  for (const it of CANDIDATES){
    const r = await tryLoad(it, rows[it.name]);
    window.GE_ENV.loadResults[it.name] = r;
    if (!r.ok && !r.optional) requiredFailures++;
  }

  if (requiredFailures){
    foot.textContent = `Loaded with ${requiredFailures} required module error(s). See panel.`;
  } else {
    foot.textContent = 'All required modules loaded. Running post-inits…';
  }

  // Allow any module to register a hook like GE_ENV.readyHooks.push(() => {...})
  try{
    (window.GE_ENV.readyHooks||[]).forEach(fn=>{
      try{ fn && fn(); }catch(e){ console.error('readyHook error', e); }
    });
  } finally {
    foot.textContent += ' Done.';
  }
}

/* Show JS errors in the panel too */
window.addEventListener('error', (e)=>{
  const row = document.createElement('div');
  row.className='row';
  row.innerHTML = `<div class="name">runtime</div><div class="badge err">error</div><div class="msg"></div>`;
  setMsg(row, e.message);
  list.appendChild(row);
});

/* Kick it off */
runLoader();

/* =============== Minimal helpers many modules expect =============== */
/* Canvas sizing helpers so background/fx modules can draw immediately */
(function bootstrapStage(){
  const bg = document.getElementById('bg');
  const fx = document.getElementById('fx');
  const rp = document.getElementById('ripple');
  function fit(){
    for (const c of [bg,fx,rp]){ c.width = innerWidth; c.height = innerHeight; }
  }
  addEventListener('resize', fit, { passive:true });
  fit();
  // Export for modules
  window.GE_CANVAS = { bg, fx, ripple: rp, bgCtx: bg.getContext('2d'), fxCtx: fx.getContext('2d'), rippleCtx: rp.getContext('2d') };
})();
</script>

</body>
</html>
