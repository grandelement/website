<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Grand Element — Universe (Template+All)</title>
<style>
  :root{
    --img-base: https://grandelement.github.io/website/images/;

    --star-tile: 900px;

    /* planets */
    --planet-size: 28px;
    --planet-hover-scale: 3;
    --planet-glow: 18px;

    /* sun + moon */
    --sun-size: 200px;
    --moon-size: 120px;
    --orbit-seconds: 60;
    --orbit-gap-moons: 2.2;
    --orbit-radius: calc((var(--sun-size) * 0.5) + (var(--moon-size) * var(--orbit-gap-moons)));
  }
  @media (max-width: 700px){
    :root{ --planet-size:22px; --sun-size:170px; --moon-size:96px; --orbit-gap-moons:2.4; }
  }

  html,body{height:100%}
  body{
    margin:0; overflow:hidden; color:#eaf2ff; background:#000;
    background-image:
      url('https://grandelement.github.io/website/images/GE%20stars.jpg'),
      radial-gradient(closest-side,#fff 1px,rgba(255,255,255,0) 1px);
    background-position:center center, 0 0;
    background-repeat:no-repeat, repeat;
    background-size:cover, 3px 3px;     /* cover = no stretching */
    background-attachment:fixed, scroll;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* layers */
  #fx{position:fixed; inset:0; z-index:1; display:block}
  #ripple{position:fixed; inset:0; z-index:3; display:block; pointer-events:none}
  .layer-hiddentext{position:fixed; inset:0; z-index:0; pointer-events:none}
  .planets{position:fixed; inset:0; z-index:7; pointer-events:none} /* planets above sun/moon */

  /* sun/moon */
  .sunWrap{ position:absolute; left:18vw; top:64vh; transform:translate(-50%,-50%);
            width:var(--sun-size); height:var(--sun-size); pointer-events:none; z-index:5; }
  .sun{ position:absolute; inset:0; border-radius:50%;
        background:center/cover no-repeat url('https://grandelement.github.io/website/images/ge-logo-2.jpg');
        box-shadow:inset 0 0 60px rgba(255,255,255,.12); z-index:3; }
  .sunOverlay{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:8px; pointer-events:auto; text-align:center; padding-top:8%;}
  .sunAbout{ font-weight:900; letter-spacing:.22em; font-size:13px; text-shadow:0 0 14px rgba(150,190,255,.55); cursor:pointer; }

  .orbit{ position:absolute; inset:0; transform-origin:50% 50%; z-index:6; pointer-events:none; }
  .carrier{ position:absolute; left:50%; top:50%; width:0; height:0; }
  .moon{ position:absolute; left:0; top:0; transform:translate(var(--orbit-radius), -50%);
         width:var(--moon-size); height:var(--moon-size); border-radius:50%; cursor:pointer; pointer-events:auto; display:grid; place-items:center; }
  .moon img{ width:100%; height:100%; object-fit:cover; border-radius:50%;
    box-shadow:0 0 10px 4px rgba(140,200,255,.35); border:1px solid rgba(160,210,255,.55);
    background: radial-gradient(circle, rgba(160,210,255,.55) 0%, rgba(160,210,255,.25) 60%, rgba(160,210,255,0) 70%);
  }

  /* mini player */
  .miniPlayer{ position:absolute; left:50%; bottom:10px; transform:translateX(-50%); width:86%;
    background:rgba(5,10,22,.55); border:1px solid rgba(220,240,255,.35); border-radius:12px; padding:6px 8px;
    box-shadow:0 8px 20px rgba(0,0,0,.45);
    display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center; font-size:12px; }
  .controls{ display:flex; gap:6px; }
  .btn{ width:26px; height:26px; border-radius:8px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); color:#eaf2ff; font-weight:900; display:grid; place-items:center; cursor:pointer; user-select:none; }
  .btn:active{ transform:translateY(1px); }
  .toggles{ display:flex; gap:6px; }
  .toggle{ padding:3px 8px; border-radius:999px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); cursor:pointer; }
  .toggle.active{ background:rgba(40,140,255,.45); }
  .title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700; letter-spacing:.3px; }

  /* planets */
  .planet{ position:absolute; width:var(--planet-size); height:var(--planet-size); border-radius:50%; pointer-events:auto; overflow:hidden; cursor:pointer;
           background:#32406b; background-size:cover; background-position:center; box-shadow:0 0 10px rgba(255,255,255,.2);
           transition:transform .2s ease, box-shadow .18s ease; }
  .planet:hover,.planet.touchZoom{ transform:scale(var(--planet-hover-scale)); box-shadow:0 0 var(--planet-glow) rgba(255,160,255,.65), 0 0 2px 1px rgba(255,255,255,.25) inset; }
  .planet .label{ position:absolute; left:50%; top:-12px; transform:translate(-50%,-100%); padding:6px 10px; border-radius:999px; white-space:nowrap;
                  background:rgba(15,25,50,.35); border:1px solid rgba(200,220,255,.5); backdrop-filter:blur(2px); font-size:12px; letter-spacing:.3px; font-weight:700;
                  opacity:0; pointer-events:none; transition:opacity .12s ease; }
  .planet:hover .label,.planet.touchZoom .label{ opacity:1; }

  /* hidden text */
  .phrase{ position:absolute; color:#cfe9ff; font-weight:700; text-shadow:0 2px 8px rgba(0,0,0,.9); opacity:0; transition:opacity .5s ease; }
  .phrase.show{ opacity:1; }
  .phrase.pinned{ color:#fff; text-decoration:underline; }

  /* debug */
  #debug{position:fixed;right:10px;top:10px;z-index:9999;display:none;min-width:280px;background:rgba(10,18,30,.92);border:1px solid rgba(200,220,255,.35);border-radius:10px;padding:10px}
  #debug.show{display:block}
  #debug pre{max-height:240px;overflow:auto;background:rgba(0,0,0,.35);padding:8px;border-radius:8px;margin:6px 0 0 0;white-space:pre-wrap}
</style>
</head>
<body>

  <canvas id="fx"></canvas>
  <canvas id="ripple"></canvas>
  <div class="layer-hiddentext" id="phrases"></div>

  <div class="sunWrap" id="sunWrap">
    <div class="sun" id="sun" title="ABOUT">
      <div class="sunOverlay">
        <div class="sunAbout" id="aboutBtn">ABOUT</div>

        <!-- Mini player -->
        <div class="miniPlayer" id="mini">
          <div class="controls">
            <div class="btn" id="prev" title="Prev">◀</div>
            <div class="btn" id="play" title="Play/Pause">▶</div>
            <div class="btn" id="next" title="Next">▶▶</div>
          </div>
          <div class="title" id="title">—</div>
          <div class="toggles">
            <div class="toggle active" id="tgShuffle">Shuffle</div>
            <div class="toggle" id="tgAlbum">Album</div>
          </div>
          <audio id="gePlayer" preload="auto" playsinline></audio>
          <div style="grid-column:1 / -1; display:flex; gap:8px; align-items:center; margin-top:6px">
            <input id="seek" type="range" min="0" max="100" value="0" style="flex:1"/>
            <span id="now" style="font-variant-numeric:tabular-nums">0:00</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="width:130px"/>
          </div>
        </div>
      </div>
    </div>

    <div class="orbit" id="orbit">
      <div class="carrier">
        <div class="moon" id="moon" title="Grand Element Radio">
          <img alt="Grand Element Radio"
               src="https://grandelement.github.io/website/images/ge-radio-logo.png">
        </div>
      </div>
    </div>
  </div>

  <div class="planets" id="planets"></div>

  <div id="debug"><b>Debugger</b> (press <code>~</code>)<pre id="log"></pre></div>

<script>
/* =========================
   CONFIG + LOG
========================= */
const LOG = (m)=>{ const pre=document.getElementById('log'); pre.textContent+=m+"\n"; pre.scrollTop=pre.scrollHeight; };
addEventListener('keydown',e=>{ if(e.key==='~') document.getElementById('debug').classList.toggle('show'); });
addEventListener('error',e=>LOG('ERR '+e.message));
addEventListener('unhandledrejection',e=>LOG('REJ '+e.reason));

const IMG = 'https://grandelement.github.io/website/images/';
const BACKGROUNDS = [
  "stars_backgrounds/Grand Element - Fundamental Groove.jpg",
  "stars_backgrounds/Grand Element - Trio.jpg",
  "stars_backgrounds/Grand Element - Live.jpg",
  "stars_backgrounds/Grand Element - Sessions I.jpg",
  "stars_backgrounds/Grand Element - Sessions II.jpg",
  "stars_backgrounds/Grand Element - Intergy.jpg",
  "stars_backgrounds/Grand Element - Love.jpg",
  "stars_backgrounds/Grand Element - Soul.jpg",
  "stars_backgrounds/Grand Element - Spirit.jpg",
  "stars_backgrounds/Grand Element - Fire.jpg"
];

/* =========================
   PLANETS: spiral layout → physics
========================= */
const ALBUMS = [
  { title:"Fundamental\u00A0Groove", cover: IMG+"Grand%20Element%20-%20Fundamental%20Groove.jpg", link:"https://grandelement.bandcamp.com/album/fundamental-groove" },
  { title:"Trio",        cover: IMG+"Grand%20Element%20-%20Trio.jpg",        link:"https://grandelement.bandcamp.com/album/trio" },
  { title:"Live!",       cover: IMG+"Grand%20Element%20-%20Live.jpg",        link:"https://grandelement.bandcamp.com/album/live" },
  { title:"Sessions I",  cover: IMG+"Grand%20Element%20-%20Sessions%20I.jpg",  link:"https://grandelement.bandcamp.com/album/sessions-i" },
  { title:"Sessions II", link:"https://grandelement.bandcamp.com/album/sessions-ii", cover: IMG+"Grand%20Element%20-%20Sessions%20II.jpg" },
  { title:"Intergy",     cover: IMG+"Grand%20Element%20-%20Intergy.jpg",     link:"https://grandelement.bandcamp.com/album/intergy" },
  { title:"Love",        cover: IMG+"Grand%20Element%20-%20Love.jpg",        link:"https://grandelement.bandcamp.com/album/love" },
  { title:"Soul",        cover: IMG+"Grand%20Element%20-%20Soul.jpg",        link:"https://grandelement.bandcamp.com/album/soul" },
  { title:"Spirit",      cover: IMG+"Grand%20Element%20-%20Spirit.jpg",      link:"https://grandelement.bandcamp.com/album/spirit" },
  { title:"Fire",        cover: IMG+"Grand%20Element%20-%20Fire.jpg",        link:"https://grandelement.bandcamp.com/album/fire" }
];

const planetsEl = document.getElementById('planets');
const planets = []; // {el,x,y,r,vx,vy,drag}
function placeSpiral(){
  planetsEl.innerHTML=""; planets.length=0;
  const w=innerWidth,h=innerHeight, xCenter=w*0.56, yBottom=h*0.88, yTop=h*0.14, amp=Math.max(80,w*0.12), waves=1.2;
  const R=[55,50,46,42,42,38,38,34,34,30]; // radii for physics (px)
  ALBUMS.forEach((alb,i)=>{
    const t=i/(ALBUMS.length-1), y=yBottom - t*(yBottom-yTop), x=xCenter + amp*Math.sin((t*Math.PI*2*waves)-Math.PI/2);
    const a=document.createElement('a'); a.className='planet'; a.style.left=x+'px'; a.style.top=y+'px'; a.style.width=a.style.height='var(--planet-size)';
    a.href=alb.link; a.target='_blank'; a.title=alb.title; a.innerHTML=`<span class="label">${alb.title}</span>`; a.style.backgroundImage=`url('${alb.cover}')`;
    planetsEl.appendChild(a);
    planets.push({el:a, x, y, r:R[i], vx:0, vy:0, drag:false, link:alb.link});
    a.addEventListener('touchstart',()=>a.classList.add('touchZoom'),{passive:true});
    a.addEventListener('touchend',()=>a.classList.remove('touchZoom'),{passive:true});

    // drag/throw
    let sx=0,sy=0,startX=0,startY=0,t0=0;
    a.addEventListener('pointerdown',e=>{ planets[i].drag=true; a.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; startX=planets[i].x; startY=planets[i].y; t0=performance.now(); });
    a.addEventListener('pointermove',e=>{ const p=planets[i]; if(!p.drag) return; p.x=startX+(e.clientX-sx); p.y=startY+(e.clientY-sy); paintPlanet(p); });
    a.addEventListener('pointerup',e=>{
      a.releasePointerCapture(e.pointerId); const p=planets[i]; const dt=Math.max(16,performance.now()-t0); const dx=p.x-startX, dy=p.y-startY; const dist=Math.hypot(dx,dy);
      if(dist<5 && dt<180){ // click
        teleportFrom(p.x,p.y); window.open(p.link,'_blank','noopener'); p.drag=false; return;
      }
      p.vx=(dx/dt)*14; p.vy=(dy/dt)*14; p.drag=false;
    });
  });
}
placeSpiral(); addEventListener('resize',placeSpiral,{passive:true});

function paintPlanet(p){ p.el.style.left=p.x+'px'; p.el.style.top=p.y+'px'; }

/* physics loop */
function bouncePlanetOffCircle(p,cx,cy,cr){
  const dx=p.x-cx, dy=p.y-cy, d=Math.hypot(dx,dy); if(d===0) return;
  if(d < p.r + cr){ const nx=dx/d, ny=dy/d; const overlap = p.r + cr - d + 0.5; p.x+=nx*overlap; p.y+=ny*overlap; const dot=p.vx*nx+p.vy*ny; p.vx=(p.vx-2*dot*nx)*0.85; p.vy=(p.vy-2*dot*ny)*0.85; }
}

/* =========================
   HIDDEN TEXT (phrases)
========================= */
const phrasesEl = document.getElementById('phrases');
let PHRASES=[];
fetch('https://grandelement.github.io/website/data/hidden.txt')
  .then(r=>r.ok?r.text():'').then(t=>{ PHRASES=t.split(/[\,\r?\n]/).map(s=>s.trim().replace(/,+$/,'')).filter(Boolean); scatterPhrases(); });
function scatterPhrases(){
  phrasesEl.innerHTML=""; const n=Math.max(10, PHRASES.length||10);
  for(let i=0;i<n;i++){
    const el=document.createElement('div'); el.className='phrase'; el.textContent=PHRASES[i%(PHRASES.length||1)]||'';
    el.style.left=(10+Math.random()*(innerWidth-220))+'px'; el.style.top=(10+Math.random()*(innerHeight-120))+'px';
    el.addEventListener('click',()=>el.classList.toggle('pinned')); phrasesEl.appendChild(el);
  }
}
let px=-9999,py=-9999; addEventListener('pointermove',e=>{px=e.clientX;py=e.clientY;},{passive:true});
setInterval(()=>{ const r=Math.min(innerWidth,innerHeight)*0.12; [...phrasesEl.children].forEach(el=>{ if(el.classList.contains('pinned')){el.classList.add('show');return;} const rect=el.getBoundingClientRect(); const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2; const d=Math.hypot(px-cx,py-cy); if(d<r)el.classList.add('show'); else el.classList.remove('show'); }); },90);

/* =========================
   ABOUT overlay
========================= */
document.getElementById('aboutBtn').addEventListener('click',()=> window.open('https://grandelement.com/about','_blank','noopener'));

/* =========================
   MOON orbit (60s, upright), depth swap
========================= */
const orbit = document.getElementById('orbit'); const moon = document.getElementById('moon');
const PHASE0 = -Math.PI/2, ORBIT_SEC=60, BASE_R = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--orbit-radius'))||260, OSC_PX=30, OSC_SEC=90;
(function orbitLoop(){ const t=Date.now()/1000; const ang=PHASE0 + (t%ORBIT_SEC)/ORBIT_SEC*Math.PI*2; const r=BASE_R + OSC_PX*Math.sin((t/OSC_SEC)*Math.PI*2);
  orbit.style.transform=`rotate(${ang}rad)`; moon.style.transform=`translate(${r}px,-50%) rotate(${-ang}rad)`;
  orbit.style.zIndex = ((ang%(Math.PI*2))>Math.PI)?2:6; requestAnimationFrame(orbitLoop); })();
moon.addEventListener('click',()=> window.open('https://grandelement.github.io/radio/','_blank','noopener'));

/* =========================
   MUSIC (seek + volume)
========================= */
const PLAYER=document.getElementById('gePlayer'), titleEl=document.getElementById('title'), btnPrev=document.getElementById('prev'), btnPlay=document.getElementById('play'), btnNext=document.getElementById('next'), tgShuffle=document.getElementById('tgShuffle'), tgAlbum=document.getElementById('tgAlbum'), seek=document.getElementById('seek'), vol=document.getElementById('vol'), nowEl=document.getElementById('now');
let PLAYLIST=[], pIndex=0, SHUFFLE=true;
function setTitle(item){ titleEl.textContent = item ? `${item.album.replace(/^Grand Element\\s*-\\s*\\d{4}\\s*-\\s*/,'')} · ${item.track}` : '—'; }
function shuffleInPlace(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } }
async function fetchAllMp3s(){
  const r=await fetch('https://api.github.com/repos/grandelement/radio/git/trees/main?recursive=1',{headers:{'Accept':'application/vnd.github+json'}}); if(!r.ok) return [];
  const data=await r.json(); const files=(data.tree||[]).filter(n=>n.type==='blob' && /\.mp3$/i.test(n.path));
  return files.map(n=>{ const parts=n.path.split('/'); const album=parts.length>1?decodeURIComponent(parts[1]):'Unknown'; const file=decodeURIComponent(parts.at(-1));
    const m=file.match(/^\s*(\d{1,3})/); const trackNum=m?parseInt(m[1],10):9999;
    return { url:`https://grandelement.github.io/radio/${encodeURI(n.path)}`, album, trackNum, track:file.replace(/\.[^.]+$/,'').replace(/^\s*\d+\s*[-_.]?\s*/,'') }; });
}
function loadAndPlay(){ if(!PLAYLIST.length) return; const item=PLAYLIST[pIndex]; PLAYER.src=item.url; setTitle(item); PLAYER.play().catch(()=>{}); btnPlay.textContent='❚❚'; }
btnPlay.onclick=()=>{ if(PLAYER.paused){ PLAYER.play().catch(()=>{}); btnPlay.textContent='❚❚'; } else { PLAYER.pause(); btnPlay.textContent='▶'; } };
btnNext.onclick=()=>{ pIndex=(pIndex+1)%PLAYLIST.length; loadAndPlay(); };
btnPrev.onclick=()=>{ pIndex=(pIndex-1+PLAYLIST.length)%PLAYLIST.length; loadAndPlay(); };
tgShuffle.onclick=()=>{ SHUFFLE=true; tgShuffle.classList.add('active'); tgAlbum.classList.remove('active'); if(PLAYLIST.length){ const base=[...PLAYLIST].sort((a,b)=>a.album.localeCompare(b.album)||a.trackNum-b.trackNum); PLAYLIST=base.slice(); shuffleInPlace(PLAYLIST); pIndex=0; loadAndPlay(); } };
tgAlbum.onclick=()=>{ SHUFFLE=false; tgAlbum.classList.add('active'); tgShuffle.classList.remove('active'); if(PLAYLIST.length){ PLAYLIST.sort((a,b)=>a.album.localeCompare(b.album)||a.trackNum-b.trackNum); pIndex=0; loadAndPlay(); } };
PLAYER.addEventListener('ended',()=>btnNext.onclick());
PLAYER.addEventListener('timeupdate',()=>{ if(!isFinite(PLAYER.duration)) return; seek.value=(PLAYER.currentTime/PLAYER.duration*100)|0; const m=(PLAYER.currentTime/60)|0, s=(PLAYER.currentTime|0)%60; nowEl.textContent=`${m}:${String(s).padStart(2,'0')}`; });
seek.oninput=()=>{ if(isFinite(PLAYER.duration)) PLAYER.currentTime = (seek.value/100)*PLAYER.duration; };
vol.oninput=()=>{ PLAYER.volume=+vol.value; };
window.addEventListener('pointerdown',()=>{ PLAYER.muted=false; },{once:true,capture:true});
(async function initMusic(){ const items=await fetchAllMp3s(); if(!items.length){ titleEl.textContent="No MP3s found"; return; } items.sort((a,b)=>a.album.localeCompare(b.album)||a.trackNum-b.trackNum); PLAYLIST = SHUFFLE ? (shuffleInPlace(items.slice()), items) : items; if(SHUFFLE) shuffleInPlace(PLAYLIST); pIndex=0; loadAndPlay(); })();

/* =========================
   FX: star network + comets + ships
========================= */
const fx = document.getElementById('fx'), fd = fx.getContext('2d');
const ripple = document.getElementById('ripple'), rp = ripple.getContext('2d');
function fit(){ fx.width=ripple.width=innerWidth; fx.height=ripple.height=innerHeight; } addEventListener('resize',fit,{passive:true}); fit();

const rand=(a,b)=>Math.random()*(b-a)+a, choice=a=>a[(Math.random()*a.length)|0];
const cometImg=new Image(); cometImg.src=IMG+'ge-logo%203.png';
const shipImg=new Image(); shipImg.src=IMG+'ge-logo-4-cutout.png';
const MOBILE = /iPhone|Android/i.test(navigator.userAgent) || innerWidth < 700;

let RUN=true; document.addEventListener('visibilitychange',()=>{ RUN=!document.hidden; });

/* star network */
const STAR_COUNT = 6000;   // push to 10000 if smooth
const LINK_RADIUS=55, MAX_LINKS=3, GRID=64;
let stars=[];
function initStars(){ stars = Array.from({length:STAR_COUNT},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-.5)*0.08,vy:(Math.random()-.5)*0.08,r:Math.random()*1.2+0.2})); }
initStars();
function buildGrid(){ const cols=Math.ceil(innerWidth/GRID), rows=Math.ceil(innerHeight/GRID), g=Array.from({length:cols*rows},()=>[]); for(let i=0;i<stars.length;i++){ const s=stars[i]; let cx=(s.x/GRID)|0, cy=(s.y/GRID)|0; if(cx<0)cx=0;if(cy<0)cy=0;if(cx>=cols)cx=cols-1;if(cy>=rows)cy=rows-1; g[cx+cy*cols].push(i);} return {g,cols,rows}; }

/* comets */
const COMET={sizes:[8,10,12,16], max:3, spawn:[4,9], speed:[60,140], trail:80, fade:1400, touch:26};
class Comet{ constructor(){ const edge=choice(['l','r','t','b']), pad=40; if(edge==='l'){this.x=-pad;this.y=rand(0,innerHeight);} if(edge==='r'){this.x=innerWidth+pad;this.y=rand(0,innerHeight);} if(edge==='t'){this.x=rand(0,innerWidth);this.y=-pad;} if(edge==='b'){this.x=rand(0,innerWidth);this.y=innerHeight+pad;} const tx=rand(innerWidth*.2,innerWidth*.8), ty=rand(innerHeight*.2,innerHeight*.8); const a=Math.atan2(ty-this.y,tx-this.x), s=rand(...COMET.speed); this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s; this.r=choice(COMET.sizes); this.trail=[]; this.state='fly'; this.dead=false; }
  step(dt){ if(this.state!=='fly'&&this.state!=='separate')return; this.x+=this.vx*dt; this.y+=this.vy*dt; this.trail.push([this.x,this.y,performance.now()]); if(this.trail.length>COMET.trail) this.trail.shift(); if(this.x<-90||this.x>innerWidth+90||this.y<-90||this.y>innerHeight+90) this.dead=true; }
  draw(){ for(const [tx,ty,ts] of this.trail){ const a=Math.max(0,1-(performance.now()-ts)/COMET.fade); if(a<=0)continue; fd.globalAlpha=a*0.6; fd.drawImage(cometImg, tx-this.r, ty-this.r, this.r*2, this.r*2); } fd.globalAlpha=1; fd.drawImage(cometImg, this.x-this.r, this.y-this.r, this.r*2, this.r*2); } }
class Pair{ constructor(a,b){ this.a=a; this.b=b; this.cx=(a.x+b.x)/2; this.cy=(a.y+b.y)/2; this.R=Math.max(18,Math.hypot(a.x-b.x)/2); this.theta=Math.atan2(a.y-this.cy,a.x-this.cx); this.omega=(Math.PI*2)/3; this.t=0; this.phase='orbit'; const va=Math.atan2(a.vy,a.vx), vb=Math.atan2(b.vy,b.vx), out=(va+vb)/2; this.outA=out; this.outB=out+Math.PI; this.sA=Math.hypot(a.vx,a.vy); this.sB=Math.hypot(b.vx,b.vy); }
  step(dt){ this.t+=dt; if(this.phase==='orbit'){ this.theta+=this.omega*dt; this.a.x=this.cx+Math.cos(this.theta)*this.R; this.a.y=this.cy+Math.sin(this.theta)*this.R; this.b.x=this.cx-Math.cos(this.theta)*this.R; this.b.y=this.cy-Math.sin(this.theta)*this.R; if(this.t>=3){ this.phase='pause'; this.t=0; } } else if(this.phase==='pause'){ if(this.t>=2.5){ this.phase='split'; this.a.state='separate'; this.b.state='separate'; this.a.vx=Math.cos(this.outA)*this.sA; this.a.vy=Math.sin(this.outA)*this.sA; this.b.vx=Math.cos(this.outB)*this.sB; this.b.vy=Math.sin(this.outB)*this.sB; } } else { this.dead=true; } }
  draw(){ if(this.phase!=='split'){ const g=fd.createRadialGradient(this.cx,this.cy,2,this.cx,this.cy,this.R+12); g.addColorStop(0,'rgba(180,220,255,.25)'); g.addColorStop(1,'rgba(180,220,255,0)'); fd.fillStyle=g; fd.beginPath(); fd.arc(this.cx,this.cy,this.R+12,0,Math.PI*2); fd.fill(); } } }

/* ships */
const MAX_SHIPS=MOBILE?3:4, SHIP_SCALES=MOBILE?[0.08,0.12,0.16,0.20]:[0.10,0.14,0.19,0.22,0.26], MINI_MAX=10, MINI_SCALES=MOBILE?[0.035,0.045]:[0.04,0.055], SHIP_ART_OFFSET=Math.PI;
class Ship{ constructor(){ const side=choice(['l','r','t','b']); this.s=choice(SHIP_SCALES); this.featured=Math.random()<0.12; if(this.featured) this.s=MOBILE?0.20:0.26; const pad=60; if(side==='l'){this.x=-pad;this.y=rand(0,innerHeight);this.vx=rand(80,220);this.vy=rand(-80,80);} if(side==='r'){this.x=innerWidth+pad;this.y=rand(0,innerHeight);this.vx=-rand(80,220);this.vy=rand(-80,80);} if(side==='t'){this.x=rand(0,innerWidth);this.y=-pad;this.vx=rand(-180,180);this.vy=rand(80,220);} if(side==='b'){this.x=rand(0,innerWidth);this.y=innerHeight+pad;this.vx=rand(-180,180);this.vy=-rand(80,220);} if(this.featured){ this.x=innerWidth+80; this.y=rand(innerHeight*.1,innerHeight*.9); this.vx=-80; this.vy=rand(-10,10); } this.ax=rand(-30,30); this.ay=rand(-30,30); this.curveT=rand(2,5); this.curveP=rand(0,Math.PI*2); this.dead=false; }
  step(dt){ this.curveP+=dt/this.curveT; this.vx+=Math.sin(this.curveP)*18*dt + this.ax*dt*.2; this.vy+=Math.cos(this.curveP)*18*dt + this.ay*dt*.2; const v=Math.hypot(this.vx,this.vy), vmax=320; if(v>vmax){ this.vx*=vmax/v; this.vy*=vmax/v; } this.x+=this.vx*dt; this.y+=this.vy*dt; if(this.x<-140||this.x>innerWidth+140||this.y<-140||this.y>innerHeight+140) this.dead=true; }
  draw(){ if(!shipImg.complete) return; const ang=Math.atan2(this.vy,this.vx)+SHIP_ART_OFFSET; const w=shipImg.width*this.s, h=shipImg.height*this.s; fd.save(); fd.translate(this.x,this.y); fd.rotate(ang); fd.drawImage(shipImg,-w*0.3,-h*0.5,w*0.6,h*0.6); fd.restore(); } }
class MiniShip{ constructor(){ this.s=(Math.random()*(MINI_SCALES[1]-MINI_SCALES[0])+MINI_SCALES[0]); const side=choice(['l','r','t','b']), pad=40; if(side==='l'){this.x=-pad;this.y=rand(0,innerHeight);this.vx=rand(15,45);this.vy=rand(-20,20);} if(side==='r'){this.x=innerWidth+pad;this.y=rand(0,innerHeight);this.vx=-rand(15,45);this.vy=rand(-20,20);} if(side==='t'){this.x=rand(0,innerWidth);this.y=-pad;this.vx=rand(-35,35);this.vy=rand(15,45);} if(side==='b'){this.x=rand(0,innerWidth);this.y=innerHeight+pad;this.vx=rand(-35,35);this.vy=-rand(15,45);} this.dead=false; }
  step(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; if(this.x<-100||this.x>innerWidth+100||this.y<-100||this.y>innerHeight+100) this.dead=true; }
  draw(){ if(!shipImg.complete) return; fd.save(); fd.globalAlpha=0.45; const ang=Math.atan2(this.vy,this.vx)+Math.PI; const w=shipImg.width*this.s, h=shipImg.height*this.s; fd.translate(this.x,this.y); fd.rotate(ang); fd.drawImage(shipImg,-w*0.3,-h*0.5,w*0.6,h*0.6); fd.restore(); } }

const comets=[], pairs=[], bigShips=[], miniShips=[];
let last=performance.now()/1000, cTimer=0, cNext=rand(4,9), shipTimer=0, shipNext=rand(6,12), miniTimer=0, miniNext=rand(5,12);

fx.addEventListener('mousemove',e=>{ bigShips.forEach(s=>{ const d=Math.hypot(s.x-e.clientX,s.y-e.clientY); const a=(d<60)?-1:1; s.vx+=(Math.random()-.5)*0.0012*a; s.vy+=(Math.random()-.5)*0.0012*a; }); });
fx.addEventListener('click', e=>{ let best=null,bestD=18; for(const s of bigShips){ const d=Math.hypot(s.x-e.clientX,s.y-e.clientY); if(d<bestD){best=s;bestD=d;} } if(best) teleportFrom(best.x,best.y); });

function bounceOffCircle(c,cx,cy,cr){ const dx=c.x-cx,dy=c.y-cy,d=Math.hypot(dx,dy); if(d===0) return; if(d<cr+c.r){ const nx=dx/d, ny=dy/d, overlap=cr+c.r-d+0.5; c.x+=nx*overlap; c.y+=ny*overlap; const dot=c.vx*nx+c.vy*ny; c.vx=(c.vx-2*dot*nx)*0.9; c.vy=(c.vy-2*dot*ny)*0.9; } }

function loop(){
  if(!RUN){ requestAnimationFrame(loop); return; }
  const now=performance.now()/1000, dt=Math.min(.05, now-last); last=now;

  /* spawn pools */
  cTimer+=dt; if(cTimer>cNext && comets.length<COMET.max){ comets.push(new Comet()); cTimer=0; cNext=rand(4,9); }
  shipTimer+=dt; if(shipTimer>shipNext){ shipTimer=0; shipNext=rand(6,14); if(bigShips.length< (MOBILE?2:3) ) bigShips.push(new Ship()); }
  miniTimer+=dt; if(miniTimer>miniNext){ miniTimer=0; miniNext=rand(5,12); if(miniShips.length<10) miniShips.push(new MiniShip()); }

  /* stars move */
  for(const s of stars){ s.x+=s.vx; s.y+=s.vy; if(s.x<0)s.x+=innerWidth; else if(s.x>innerWidth)s.x-=innerWidth; if(s.y<0)s.y+=innerHeight; else if(s.y>innerHeight)s.y-=innerHeight; }

  /* comets update + bounce sun/moon */
  const sun=document.getElementById('sun').getBoundingClientRect(), moon=document.getElementById('moon').getBoundingClientRect();
  const sunC={x:sun.left+sun.width/2, y:sun.top+sun.height/2, r:sun.width/2}; const moonC={x:moon.left+moon.width/2, y:moon.top+moon.height/2, r:moon.width/2};
  comets.forEach(c=>{ c.step(dt); bounceOffCircle(c,sunC.x,sunC.y,sunC.r); bounceOffCircle(c,moonC.x,moonC.y,moonC.r); });
  bigShips.forEach(s=>s.step(dt)); miniShips.forEach(s=>s.step(dt)); pairs.forEach(p=>p.step(dt));

  /* entangle when close */
  for(let i=0;i<comets.length;i++) for(let j=i+1;j<comets.length;j++){ const a=comets[i],b=comets[j]; if(a.state!=='fly'||b.state!=='fly')continue; if(Math.hypot(a.x-b.x,a.y-b.y)<COMET.touch){ a.state='pair'; b.state='pair'; pairs.push(new Pair(a,b)); } }

  /* cleanup */
  for(let i=comets.length-1;i>=0;i--) if(comets[i].dead) comets.splice(i,1);
  for(let i=pairs.length-1;i>=0;i--) if(pairs[i].dead) pairs.splice(i,1);
  for(let i=bigShips.length-1;i>=0;i--) if(bigShips[i].dead) bigShips.splice(i,1);
  for(let i=miniShips.length-1;i>=0;i--) if(miniShips[i].dead) miniShips.splice(i,1);

  /* planets physics */
  const loss=0.985, edgeLoss=0.86;
  for(let i=0;i<planets.length;i++){
    const p=planets[i]; if(!p.drag){ p.x+=p.vx; p.y+=p.vy; p.vx*=loss; p.vy*=loss; }
    if(p.x-p.r<0){ p.x=p.r; p.vx= Math.abs(p.vx)*edgeLoss; }
    if(p.x+p.r>innerWidth){ p.x=innerWidth-p.r; p.vx= -Math.abs(p.vx)*edgeLoss; }
    if(p.y-p.r<0){ p.y=p.r; p.vy= Math.abs(p.vy)*edgeLoss; }
    if(p.y+p.r>innerHeight){ p.y=innerHeight-p.r; p.vy= -Math.abs(p.vy)*edgeLoss; }
    for(let j=i+1;j<planets.length;j++){ const q=planets[j]; const dx=q.x-p.x, dy=q.y-p.y, d=Math.hypot(dx,dy), R=p.r+q.r; if(d>0&&d<R){ const nx=dx/d, ny=dy/d, overlap=R-d; p.x-=nx*overlap/2; p.y-=ny*overlap/2; q.x+=nx*overlap/2; q.y+=ny*overlap/2; const pvn=p.vx*nx+p.vy*ny, qvn=q.vx*nx+q.vy*ny; const tmp=pvn; p.vx+=(qvn-pvn)*nx; p.vy+=(qvn-pvn)*ny; q.vx+=(tmp-qvn)*nx; q.vy+=(tmp-qvn)*ny; } }
    bouncePlanetOffCircle(p, sunC.x,sunC.y,sunC.r); bouncePlanetOffCircle(p, moonC.x,moonC.y,moonC.r); paintPlanet(p);
  }

  /* draw: stars network → pairs glow → comets → ships */
  fd.clearRect(0,0,innerWidth,innerHeight);
  // stars dots
  fd.globalAlpha=0.9; fd.fillStyle='#cfe9ff'; fd.beginPath(); for(const s of stars){ fd.moveTo(s.x+s.r,s.y); fd.arc(s.x,s.y,s.r,0,Math.PI*2);} fd.fill();
  // links (grid)
  const {g,cols,rows}=buildGrid(); fd.globalAlpha=0.35; fd.lineWidth=1; fd.strokeStyle='#9ec8ff';
  for(let cx=0;cx<cols;cx++){ for(let cy=0;cy<rows;cy++){ const cell=g[cx+cy*cols]; if(!cell.length) continue;
    const neigh=[]; for(let dx=-1;dx<=1;dx++) for(let dy=-1;dy<=1;dy++){ const nx=cx+dx,ny=cy+dy; if(nx<0||ny<0||nx>=cols||ny>=rows) continue; neigh.push(...g[nx+ny*cols]); }
    for(const i of cell){ const a=stars[i]; let links=0; for(const j of neigh){ if(i===j) continue; const b=stars[j]; const dx=a.x-b.x,dy=a.y-b.y; if(dx*dx+dy*dy<LINK_RADIUS*LINK_RADIUS){ fd.beginPath(); fd.moveTo(a.x,a.y); fd.lineTo(b.x,b.y); fd.stroke(); if(++links>=MAX_LINKS) break; } } } } }
  pairs.forEach(p=>p.draw()); comets.forEach(c=>c.draw()); miniShips.forEach(s=>s.draw()); bigShips.forEach(s=>s.draw());

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* =========================
   Teleport ripple + background shuffle
========================= */
let bgIndex=0;
function setBG(idx){ const url = IMG + BACKGROUNDS[idx%BACKGROUNDS.length]; document.body.style.backgroundImage = `url("${url}")`; }
function teleportFrom(x,y){
  const start=performance.now(), dur=2000; // ~2s
  function draw(now){
    const t=Math.min(1,(now-start)/dur);
    rp.clearRect(0,0,innerWidth,innerHeight);
    rp.save(); rp.globalAlpha=0.35*(1-t);
    rp.beginPath(); rp.arc(x,y, Math.hypot(innerWidth,innerHeight)*t, 0, Math.PI*2);
    rp.lineWidth=6*(1-t)+1; rp.strokeStyle='rgba(120,180,255,0.8)'; rp.stroke(); rp.restore();
    if(t<1) requestAnimationFrame(draw);
    else { rp.clearRect(0,0,innerWidth,innerHeight); bgIndex=(bgIndex+1)%BACKGROUNDS.length; setBG(bgIndex); }
  }
  requestAnimationFrame(draw);
}
</script>
</body>
</html>
