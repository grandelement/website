<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Grand Element ‚Äî Universe</title>
<style>
  :root{
    --sun-size: 280px;
    --moon-size: 110px;
  }
  html,body{height:100%}
  body{
    margin:0; overflow:hidden; color:#eaf2ff; background:#000;
    background:url("https://grandelement.github.io/website/images/GE%20stars.jpg") center/cover no-repeat fixed;
    font:14px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* layers */
  #fx,#ripple{position:fixed;inset:0}
  #ripple{z-index:3;pointer-events:none}
  #phrases{position:fixed;inset:0;z-index:2;pointer-events:auto}   /* enable comet clicks */
  #planets{position:fixed;inset:0;z-index:7;pointer-events:auto}   /* planets above sun/moon */

  /* sun + moon */
  #sunWrap{position:fixed;left:16vw;top:62vh;transform:translate(-50%,-50%);z-index:5;width:var(--sun-size);height:var(--sun-size);pointer-events:auto}
  #sun{position:absolute;inset:0;border-radius:50%;background:center/cover no-repeat url("https://grandelement.github.io/website/images/ge-logo-2.jpg");box-shadow:inset 0 0 60px rgba(255,255,255,.12)}
  .sunOverlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;pointer-events:auto}
  .about{margin-top:10%;font-weight:900;letter-spacing:.22em;font-size:13px;text-shadow:0 0 14px rgba(150,190,255,.55);cursor:pointer}
  #orbit{position:absolute;inset:0;transform-origin:50% 50%;z-index:6;pointer-events:none}
  #orbit .carrier{position:absolute;left:50%;top:50%}
  #moon{position:absolute;left:0;top:0;transform:translate(200px,-50%);width:var(--moon-size);height:var(--moon-size);border-radius:50%;
        cursor:pointer;pointer-events:auto;background:center/cover no-repeat url("https://grandelement.github.io/website/images/ge-radio-logo.png");
        box-shadow:0 0 10px 3px rgba(160,210,255,.45)}
  #moon .label{position:absolute;left:50%;top:100%;transform:translate(-50%,10px);font-weight:700;font-size:12px;text-shadow:0 2px 6px #000}

  /* planets */
  .planet{position:absolute;border-radius:50%;display:block;cursor:pointer;background:radial-gradient(circle at 35% 35%, #1b4d6f 0%, #0b2230 60%);
          width:56px;height:56px;box-shadow:0 0 14px rgba(160,210,255,.45);transition:transform .12s}
  .planet:hover{transform:scale(1.18)}
  .planet .label{position:absolute;left:50%;top:-8px;transform:translate(-50%,-100%);background:rgba(15,25,50,.35);padding:4px 8px;border-radius:999px;border:1px solid rgba(200,220,255,.45);font-weight:700;font-size:12px;opacity:0}
  .planet:hover .label{opacity:1}

  /* comets */
  .comet{position:absolute;width:10px;height:10px;border-radius:50%;background:#fff;box-shadow:0 0 8px 2px rgba(255,255,255,.6);cursor:pointer}

  /* player */
  #playerToggle{position:fixed;left:12px;bottom:12px;z-index:9;border:1px solid rgba(200,220,255,.35);padding:6px 10px;border-radius:999px;background:rgba(12,20,35,.85);cursor:pointer}
  #playerBox{position:fixed;left:12px;bottom:54px;z-index:9;display:none;background:rgba(10,20,35,.9);border:1px solid rgba(200,220,255,.35);
             border-radius:14px;padding:12px;backdrop-filter:blur(4px);min-width:300px}
  #playerBox.show{display:block}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .btn{width:34px;height:34px;border-radius:8px;border:1px solid rgba(200,220,255,.35);display:grid;place-items:center;cursor:pointer;user-select:none}
  .toggle{border:1px solid rgba(200,220,255,.35);padding:4px 8px;border-radius:999px;cursor:pointer;user-select:none}
  .active{background:rgba(60,140,255,.35)}
  input[type="range"]{width:160px}
  #now{min-width:40px;text-align:center;font-variant-numeric:tabular-nums}
  #trackTitle{font-weight:700;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* debug */
  #debug{position:fixed;right:10px;top:10px;z-index:9999;display:none;min-width:280px;background:rgba(10,18,30,.92);border:1px solid rgba(200,220,255,.35);border-radius:10px;padding:10px}
  #debug.show{display:block}
  #debug pre{max-height:220px;overflow:auto;background:rgba(0,0,0,.35);padding:8px;border-radius:8px;margin:6px 0 0 0;white-space:pre-wrap}
</style>
</head>
<body>

  <canvas id="fx"></canvas>
  <canvas id="ripple"></canvas>
  <div id="phrases"></div>

  <div id="sunWrap">
    <div id="sun"><div class="sunOverlay"><div class="about" id="aboutBtn">ABOUT</div></div></div>
    <div id="orbit"><div class="carrier"><div id="moon" title="Grand Element Radio"><div class="label">GE RADIO</div></div></div></div>
  </div>

  <div id="planets"></div>

  <button id="playerToggle">Music</button>
  <div id="playerBox">
    <div class="row" style="justify-content:space-between">
      <div id="trackTitle">‚Äî</div><div id="now">0:00</div>
    </div>
    <div class="row">
      <div class="btn" id="prev">‚èÆ</div>
      <div class="btn" id="play">‚ñ∂</div>
      <div class="btn" id="next">‚è≠</div>
      <input id="seek" type="range" min="0" max="100" value="0"/>
    </div>
    <div class="row">
      <div class="toggle active" id="tgShuffle">Shuffle</div>
      <div class="toggle" id="tgAlbum">Album</div>
      <span style="margin-left:auto">üîâ</span>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9"/>
    </div>
    <audio id="audio" preload="auto" playsinline></audio>
  </div>

  <div id="debug"><b>Debugger</b> (press <code>~</code>)<pre id="log"></pre></div>

<script>
/* ========= CONFIG ========= */
const IMG_BASE = "https://grandelement.github.io/website/images/";
const BACKGROUNDS = [
  "stars_backgrounds/Grand Element - Fundamental Groove.jpg",
  "stars_backgrounds/Grand Element - Trio.jpg",
  "stars_backgrounds/Grand Element - Live.jpg",
  "stars_backgrounds/Grand Element - Sessions I.jpg",
  "stars_backgrounds/Grand Element - Sessions II.jpg",
  "stars_backgrounds/Grand Element - Intergy.jpg",
  "stars_backgrounds/Grand Element - Love.jpg",
  "stars_backgrounds/Grand Element - Soul.jpg",
  "stars_backgrounds/Grand Element - Spirit.jpg",
  "stars_backgrounds/Grand Element - Fire.jpg"
];
const ALBUMS = [
  {name:"FUNDAMENTAL GROOVE", url:"https://grandelement.bandcamp.com/album/fundamental-groove"},
  {name:"TRIO",               url:"https://grandelement.bandcamp.com/album/trio"},
  {name:"LIVE",               url:"https://grandelement.bandcamp.com/album/live"},
  {name:"SESSIONS I",         url:"https://grandelement.bandcamp.com/album/sessions-i"},
  {name:"SESSIONS II",        url:"https://grandelement.bandcamp.com/album/sessions-ii"},
  {name:"INTERGY",            url:"https://grandelement.bandcamp.com/album/intergy"},
  {name:"LOVE",               url:"https://grandelement.bandcamp.com/album/love"},
  {name:"SOUL",               url:"https://grandelement.bandcamp.com/album/soul"},
  {name:"SPIRIT",             url:"https://grandelement.bandcamp.com/album/spirit"},
  {name:"FIRE",               url:"https://grandelement.bandcamp.com/album/fire"}
];
const ORBIT_SECONDS = 60;

/* ========= DEBUG ========= */
const DBG = document.getElementById('debug'), LOG = (m)=>{ const pre=document.getElementById('log'); pre.textContent+=m+"\n"; pre.scrollTop=pre.scrollHeight; };
addEventListener('keydown',e=>{ if(e.key==='~') DBG.classList.toggle('show'); });
addEventListener('error',e=>LOG('ERR: '+e.message));
addEventListener('unhandledrejection',e=>LOG('REJ: '+e.reason));

/* ========= CANVASES ========= */
const fx = document.getElementById('fx'), fd = fx.getContext('2d');
const ripple = document.getElementById('ripple'), rp = ripple.getContext('2d');
function fit(){ fx.width=ripple.width=innerWidth; fx.height=ripple.height=innerHeight; }
addEventListener('resize',fit); fit();

/* ========= STAR NETWORK (toned down) + SHIPS ========= */
let stars=[], ships=[];
const STAR_COUNT=3000, LINK_RADIUS=32, MAX_LINKS=1, GRID=64;
function initStars(){ stars=Array.from({length:STAR_COUNT},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-.5)*0.08,vy:(Math.random()-.5)*0.08,r:Math.random()*1.1+0.2})); }
function buildGrid(){ const cols=Math.ceil(innerWidth/GRID), rows=Math.ceil(innerHeight/GRID), g=Array.from({length:cols*rows},()=>[]); for(let i=0;i<stars.length;i++){ const s=stars[i]; let cx=(s.x/GRID)|0,cy=(s.y/GRID)|0; cx=Math.max(0,Math.min(cols-1,cx)); cy=Math.max(0,Math.min(rows-1,cy)); g[cx+cy*cols].push(i);} return {g,cols,rows}; }
function spawnShips(){ const spawn=(n,size,speed)=>Array.from({length:n},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-.5)*speed,vy:(Math.random()-.5)*speed,size})); ships=[...spawn(100,1,0.25),...spawn(50,2.5,0.18),...spawn(10,6,0.08)]; }
initStars(); spawnShips();
let slow=false;
function fxLoop(){
  fd.clearRect(0,0,innerWidth,innerHeight);
  const k = slow?0.5:1;
  for(const s of stars){ s.x+=s.vx*k; s.y+=s.vy*k; if(s.x<0)s.x+=innerWidth; else if(s.x>innerWidth)s.x-=innerWidth; if(s.y<0)s.y+=innerHeight; else if(s.y>innerHeight)s.y-=innerHeight; }
  // dots
  fd.globalAlpha=0.9; fd.fillStyle='#cfe9ff'; fd.beginPath(); for(const s of stars){ fd.moveTo(s.x+s.r,s.y); fd.arc(s.x,s.y,s.r,0,Math.PI*2);} fd.fill();
  // faint links
  const {g,cols,rows}=buildGrid(); fd.globalAlpha=0.18; fd.lineWidth=1; fd.strokeStyle='#9ec8ff';
  for(let cx=0;cx<cols;cx++)for(let cy=0;cy<rows;cy++){ const cell=g[cx+cy*cols]; if(!cell.length) continue;
    const neigh=[]; for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++){ const nx=cx+dx,ny=cy+dy; if(nx<0||ny<0||nx>=cols||ny>=rows) continue; neigh.push(...g[nx+ny*cols]); }
    for(const i of cell){ const a=stars[i]; let links=0; for(const j of neigh){ if(i===j) continue; const b=stars[j]; const dx=a.x-b.x,dy=a.y-b.y;if(dx*dx+dy*dy<LINK_RADIUS*LINK_RADIUS){ fd.beginPath();fd.moveTo(a.x,a.y);fd.lineTo(b.x,b.y);fd.stroke(); if(++links>=MAX_LINKS) break; } }
  } }
  // ships
  fd.globalAlpha=1;
  for(const sh of ships){
    sh.x+=sh.vx*k; sh.y+=sh.vy*k;
    if(sh.x<-20) sh.x=innerWidth+20; if(sh.x>innerWidth+20) sh.x=-20;
    if(sh.y<-20) sh.y=innerHeight+20; if(sh.y>innerHeight+20) sh.y=-20;
    fd.beginPath(); fd.arc(sh.x,sh.y,sh.size,0,Math.PI*2); fd.fillStyle=(sh.size>=6?'#6fb8ff':'#bcd6ff'); fd.fill();
  }
  requestAnimationFrame(fxLoop);
}
fxLoop();

// Hover nudges; click mothership to teleport
fx.addEventListener('mousemove',e=>{
  ships.forEach(s=>{
    const d=Math.hypot(s.x-e.clientX,s.y-e.clientY);
    const accel = s.size>=6?0.003:0.002;      // stronger
    const dir = (d<80)?-1:1;                  // bigger zone
    s.vx += (Math.random()-.5)*accel*dir;
    s.vy += (Math.random()-.5)*accel*dir;
  });
});
fx.addEventListener('click', e=>{
  let best=null, bestD=32;                    // larger hit
  for(const s of ships){
    if(s.size<6) continue;
    const d=Math.hypot(s.x-e.clientX,s.y-e.clientY);
    if(d<bestD){ best=s; bestD=d; }
  }
  if(best) teleportFrom(best.x,best.y);
});

/* ========= COMETS (clickable) ========= */
const cometHost=document.getElementById('phrases'); const comets=[];
function spawnComets(){
  for(let i=0;i<48;i++){
    const el=document.createElement('div'); el.className='comet';
    const size = i%10===0?14:(i%5===0?9:6); el.style.width=el.style.height=size+'px';
    cometHost.appendChild(el);
    const c={el,x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:size/2,vx:(Math.random()-.5)*0.6,vy:(Math.random()-.5)*0.6,ent:null};
    el.addEventListener('click',()=>{ // pin + brief pause
      c.vx=c.vy=0; setTimeout(()=>{ c.vx=(Math.random()-.5)*0.6; c.vy=(Math.random()-.5)*0.6; },600);
    });
    comets.push(c);
  }
}
spawnComets();

function bounceOffCircle(c,cx,cy,cr){
  const dx=c.x-cx, dy=c.y-cy, d=Math.hypot(dx,dy); if(d===0) return;
  if(d < cr + c.r){
    const nx=dx/d, ny=dy/d, overlap = cr + c.r - d + 0.5;
    c.x += nx*overlap; c.y += ny*overlap;
    const dot = c.vx*nx + c.vy*ny;
    c.vx = (c.vx - 2*dot*nx)*0.9; c.vy = (c.vy - 2*dot*ny)*0.9;
  }
}
function cometsLoop(){
  fd.save(); fd.globalCompositeOperation='lighter';
  comets.forEach(c=>{
    const k=slow?0.5:1;
    c.x+=c.vx*k; c.y+=c.vy*k; // no frame walls: can drift away
    c.el.style.transform=`translate(${c.x-c.r}px,${c.y-c.r}px)`;
    // tails
    const len = 18 + c.r*4;
    fd.beginPath(); fd.moveTo(c.x,c.y); fd.lineTo(c.x - c.vx*len, c.y - c.vy*len);
    fd.lineWidth=Math.max(1,c.r/2); fd.strokeStyle='rgba(190,220,255,.55)'; fd.stroke();
    // bounce sun/moon
    const sun=document.getElementById('sun').getBoundingClientRect();
    const moon=document.getElementById('moon').getBoundingClientRect();
    bounceOffCircle(c,sun.left+sun.width/2, sun.top+sun.height/2, sun.width/2);
    bounceOffCircle(c,moon.left+moon.width/2, moon.top+moon.height/2, moon.width/2);
  });
  fd.restore();
  requestAnimationFrame(cometsLoop);
}
cometsLoop();

/* ========= PLANETS (pool physics + click) ========= */
const planetHost=document.getElementById('planets'); const planets=[];
(function placeSpiral(){
  const w=innerWidth,h=innerHeight, xC=w*0.56, yB=h*0.88, yT=h*0.14, amp=Math.max(80,w*0.12), waves=1.2;
  const R=[55,50,46,42,42,38,38,34,34,30];
  ALBUMS.forEach((alb,i)=>{
    const t=i/(ALBUMS.length-1), y=yB - t*(yB-yT), x=xC + amp*Math.sin((t*Math.PI*2*waves)-Math.PI/2);
    const a=document.createElement('a'); a.className='planet'; a.style.left=x+'px'; a.style.top=y+'px';
    a.innerHTML=`<span class="label">${alb.name}</span>`; a.title=alb.name; a.href=alb.url; a.target='_blank';
    planetHost.appendChild(a);
    planets.push({el:a,x,y,r:R[i],vx:0,vy:0,drag:false,link:alb.url});
    let sx=0,sy=0,startX=0,startY=0,t0=0;
    a.addEventListener('pointerdown',e=>{ const p=planets[i]; p.drag=true; a.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; startX=p.x; startY=p.y; t0=performance.now(); });
    a.addEventListener('pointermove',e=>{ const p=planets[i]; if(!p.drag) return; p.x=startX+(e.clientX-sx); p.y=startY+(e.clientY-sy); paintPlanet(p); });
    a.addEventListener('pointerup',e=>{
      a.releasePointerCapture(e.pointerId); const p=planets[i]; const dt=Math.max(16,performance.now()-t0); const dx=p.x-startX, dy=p.y-startY; const dist=Math.hypot(dx,dy);
      if(dist<5 && dt<180){ teleportFrom(p.x,p.y); window.open(p.link,'_blank','noopener'); p.drag=false; return; }
      p.vx=(dx/dt)*18; p.vy=(dy/dt)*18; p.drag=false;
    });
  });
  addEventListener('resize',()=>{ planetHost.innerHTML=''; planets.length=0; placeSpiral(); },{once:true});
})();
function paintPlanet(p){ p.el.style.left=p.x+'px'; p.el.style.top=p.y+'px'; }

function bouncePlanetOffCircle(p,cx,cy,cr){
  const dx=p.x-cx, dy=p.y-cy, d=Math.hypot(dx,dy); if(d===0) return;
  if(d < p.r + cr){ const nx=dx/d, ny=dy/d, overlap=p.r+cr-d+0.5; p.x+=nx*overlap; p.y+=ny*overlap; const dot=p.vx*nx+p.vy*ny; p.vx=(p.vx-2*dot*nx)*0.85; p.vy=(p.vy-2*dot*ny)*0.85; }
}
function planetsLoop(){
  const loss=0.985, edgeLoss=0.86;
  for(let i=0;i<planets.length;i++){
    const p=planets[i]; if(!p.drag){ p.x+=p.vx; p.y+=p.vy; p.vx*=loss; p.vy*=loss; }
    if(p.x-p.r<0){ p.x=p.r; p.vx=Math.abs(p.vx)*edgeLoss; }
    if(p.x+p.r>innerWidth){ p.x=innerWidth-p.r; p.vx=-Math.abs(p.vx)*edgeLoss; }
    if(p.y-p.r<0){ p.y=p.r; p.vy=Math.abs(p.vy)*edgeLoss; }
    if(p.y+p.r>innerHeight){ p.y=innerHeight-p.r; p.vy=-Math.abs(p.vy)*edgeLoss; }
    for(let j=i+1;j<planets.length;j++){
      const q=planets[j], dx=q.x-p.x, dy=q.y-p.y, d=Math.hypot(dx,dy), R=p.r+q.r;
      if(d>0&&d<R){ const nx=dx/d, ny=dy/d, overlap=R-d; p.x-=nx*overlap/2; p.y-=ny*overlap/2; q.x+=nx*overlap/2; q.y+=ny*overlap/2;
        const pvn=p.vx*nx+p.vy*ny, qvn=q.vx*nx+q.vy*ny, tmp=pvn; p.vx+=(qvn-pvn)*nx; p.vy+=(qvn-pvn)*ny; q.vx+=(tmp-qvn)*nx; q.vy+=(tmp-qvn)*ny; }
    }
    const sun=document.getElementById('sun').getBoundingClientRect();
    const moon=document.getElementById('moon').getBoundingClientRect();
    bouncePlanetOffCircle(p,sun.left+sun.width/2,sun.top+sun.height/2,sun.width/2);
    bouncePlanetOffCircle(p,moon.left+moon.width/2,moon.top+moon.height/2,moon.width/2);
    paintPlanet(p);
  }
  requestAnimationFrame(planetsLoop);
}
planetsLoop();

/* ========= MOON ORBIT + DRAGGABLE SUN ========= */
const carrier=document.querySelector('#orbit .carrier'); const moon=document.getElementById('moon');
(function orbitLoop(){ const t=performance.now()/1000; const ang=-2*Math.PI*(t/ORBIT_SECONDS); carrier.style.transform=`rotate(${ang}rad)`; moon.style.transform=`translate(200px,-50%) rotate(${-ang}rad)`; requestAnimationFrame(orbitLoop); })();
document.getElementById('sunWrap').addEventListener('pointerdown',e=>{
  const wrap=e.currentTarget; let sx=e.clientX,sy=e.clientY,left=wrap.offsetLeft,top=wrap.offsetTop; wrap.setPointerCapture(e.pointerId);
  function mv(ev){ wrap.style.transform='translate(0,0)'; wrap.style.left=(left+(ev.clientX-sx))+'px'; wrap.style.top=(top+(ev.clientY-sy))+'px'; }
  function up(ev){ wrap.releasePointerCapture(ev.pointerId); wrap.removeEventListener('pointermove',mv); wrap.removeEventListener('pointerup',up); }
  wrap.addEventListener('pointermove',mv); wrap.addEventListener('pointerup',up);
});

/* ========= RIPPLE + BACKGROUND ========= */
let bgIndex=0; function setBG(idx){ document.body.style.backgroundImage=`url("${IMG_BASE+BACKGROUNDS[idx%BACKGROUNDS.length]}")`; }
function teleportFrom(x,y){
  slow=true; const start=performance.now(), dur=2000;
  function draw(now){
    const t=Math.min(1,(now-start)/dur);
    rp.clearRect(0,0,innerWidth,innerHeight);
    rp.save(); rp.globalAlpha=0.35*(1-t);
    rp.beginPath(); rp.arc(x,y, Math.hypot(innerWidth,innerHeight)*t, 0, Math.PI*2);
    rp.lineWidth=6*(1-t)+1; rp.strokeStyle='rgba(120,180,255,0.8)'; rp.stroke(); rp.restore();
    if(t<1) requestAnimationFrame(draw);
    else { rp.clearRect(0,0,innerWidth,innerHeight); bgIndex=(bgIndex+1)%BACKGROUNDS.length; setBG(bgIndex); slow=false; }
  }
  requestAnimationFrame(draw);
}

/* ========= ABOUT ========= */
document.getElementById('aboutBtn').onclick=()=> window.open('https://grandelement.com/about','_blank','noopener');

/* ========= PLAYER (autoplay-safe + fallback) ========= */
const audio=document.getElementById('audio'), btnPlay=document.getElementById('play'), btnPrev=document.getElementById('prev'), btnNext=document.getElementById('next');
const seek=document.getElementById('seek'), vol=document.getElementById('vol'), titleEl=document.getElementById('trackTitle'), nowEl=document.getElementById('now');
const toggle=document.getElementById('playerToggle'), box=document.getElementById('playerBox'), tgShuffle=document.getElementById('tgShuffle'), tgAlbum=document.getElementById('tgAlbum');
let playlist=[], iTrack=0, shuffle=true;

toggle.onclick=()=>{ box.classList.toggle('show'); };

async function fetchAllMp3s(){
  const r=await fetch('https://api.github.com/repos/grandelement/radio/git/trees/main?recursive=1',{headers:{'Accept':'application/vnd.github+json'}});
  if(!r.ok) return [];
  const data=await r.json(); const files=(data.tree||[]).filter(n=>n.type==='blob' && /\.mp3$/i.test(n.path));
  return files.map(n=>{
    const path=encodeURI(n.path); const parts=n.path.split('/'); const album=decodeURIComponent(parts[1]||'Unknown'); const file=decodeURIComponent(parts.at(-1)||'');
    const m=file.match(/^\s*(\d{1,3})/); const trackNum=m?parseInt(m[1],10):9999;
    return {url:`https://grandelement.github.io/radio/${path}`, album, track:file.replace(/\.[^.]+$/,'').replace(/^\s*\d+\s*[-_.]?\s*/,'') , trackNum};
  });
}
const FALLBACK = {url:'https://grandelement.github.io/radio/Trio/01.mp3', album:'Trio', track:'01', trackNum:1};
function setTitle(it){ titleEl.textContent = it ? `${it.album} ¬∑ ${it.track}` : '‚Äî'; }
function shuffleInPlace(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } }

(async function initMusic(){
  try{
    const items = await fetchAllMp3s();
    playlist = items.length ? items : [FALLBACK];
  }catch{ playlist=[FALLBACK]; }
  if(shuffle){ shuffleInPlace(playlist); }
  iTrack=0; setTitle(playlist[0]);
})();

btnPlay.onclick=()=>{
  if(!audio.src && playlist[0]) audio.src = playlist[0].url; // first user click wires source
  if(audio.paused){ audio.play().catch(()=>{}); btnPlay.textContent='‚è∏'; }
  else { audio.pause(); btnPlay.textContent='‚ñ∂'; }
};
btnNext.onclick=()=>{ if(!playlist.length) return; iTrack=(iTrack+1)%playlist.length; audio.src=playlist[iTrack].url; setTitle(playlist[iTrack]); audio.play().catch(()=>{}); btnPlay.textContent='‚è∏'; };
btnPrev.onclick=()=>{ if(!playlist.length) return; iTrack=(iTrack-1+playlist.length)%playlist.length; audio.src=playlist[iTrack].url; setTitle(playlist[iTrack]); audio.play().catch(()=>{}); btnPlay.textContent='‚è∏'; };
tgShuffle.onclick=()=>{ shuffle=true; tgShuffle.classList.add('active'); tgAlbum.classList.remove('active'); if(playlist.length){ shuffleInPlace(playlist); iTrack=0; setTitle(playlist[0]); } };
tgAlbum.onclick=()=>{ shuffle=false; tgAlbum.classList.add('active'); tgShuffle.classList.remove('active'); if(playlist.length){ playlist.sort((a,b)=>a.album.localeCompare(b.album)||a.trackNum-b.trackNum); iTrack=0; setTitle(playlist[0]); } };
audio.addEventListener('timeupdate',()=>{ if(!isFinite(audio.duration)) return; seek.value=(audio.currentTime/audio.duration*100)|0; const m=(audio.currentTime/60)|0, s=(audio.currentTime|0)%60; nowEl.textContent=`${m}:${String(s).padStart(2,'0')}`; });
seek.oninput=()=>{ if(isFinite(audio.duration)) audio.currentTime = (seek.value/100)*audio.duration; };
vol.oninput=()=> audio.volume=+vol.value;
audio.addEventListener('ended',()=> btnNext.onclick());

/* ========= EXTRA ========= */
document.getElementById('moon').addEventListener('click',()=> window.open('https://grandelement.github.io/radio/','_blank','noopener'));
document.getElementById('aboutBtn').addEventListener('click',()=> window.open('https://grandelement.com/about','_blank','noopener'));
</script>
</body>
</html>
