<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Grand Element — Site (Index)</title>
<style>
  :root{
    --imgRoot: https://grandelement.github.io/website/images/;

    /* Background */
    --star-tile: 900px;

    /* Planets */
    --planet-size: 30px;
    --planet-hover-scale: 3;
    --planet-glow: 18px;

    /* Sun/Moon */
    --sun-size: 260px;    /* desktop */
    --moon-size: 110px;
    --orbit-seconds: 60;  /* full rotation */
    --orbit-gap: 1.65;    /* distance factor moon→sun */
    --orbit-radius: calc((var(--sun-size)*0.5) + var(--moon-size)*var(--orbit-gap));

    /* FX */
    --comet-max: 3;
  }

  @media (max-width: 820px){
    :root{
      --planet-size: 22px;
      --sun-size: 130px;
      --moon-size: 90px;
      --orbit-gap: 1.8;
      --orbit-radius: calc((var(--sun-size)*0.5) + var(--moon-size)*var(--orbit-gap));
    }
  }

  html,body{height:100%}
  body{
    margin:0; overflow:hidden; color:#eaf2ff; background:#000;
    background-image:
      url('https://grandelement.github.io/website/images/GE%20stars.jpg'),
      radial-gradient(closest-side,#fff 1px,rgba(255,255,255,0) 1px);
    background-position:center center,0 0;
    background-repeat:repeat,repeat;
    background-size:var(--star-tile) var(--star-tile),3px 3px; /* never stretch */
    image-rendering:auto;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  /* Layers */
  #fx{ position:fixed; inset:0; z-index:1; }
  .layer-hiddentext{ position:fixed; inset:0; z-index:0; pointer-events:none; }
  .phrase{ position:absolute; color:#cfe9ff; font-weight:700; text-shadow:0 2px 8px rgba(0,0,0,.9); opacity:0; transition:opacity .5s ease; }
  .phrase.show{ opacity:1; }
  .phrase.pinned{ color:#fff; text-decoration:underline; }

  /* Sun + Moon */
  .sunWrap{ position:absolute; left:18vw; top:64vh; transform:translate(-50%,-50%); width:var(--sun-size); height:var(--sun-size); z-index:5; }
  .sun{ position:absolute; inset:0; border-radius:50%;
        background:center/cover no-repeat url('https://grandelement.github.io/website/images/ge-logo-2.jpg');
        box-shadow: inset 0 0 60px rgba(255,255,255,.12);
        cursor:grab; }
  .sun.dragging{ cursor:grabbing; }
  .sunOverlay{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:8px; text-align:center; padding-top:8%; pointer-events:none; }
  .sunAbout{ pointer-events:auto; font-weight:900; letter-spacing:.22em; font-size:13px; opacity:.95; text-shadow:0 0 14px rgba(150,190,255,.55); cursor:pointer; }

  /* Toggle button (inside sun) */
  .controlsToggle{ pointer-events:auto; margin-top:6px; font-weight:800; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none; }
  .controlsToggle:active{ transform:translateY(1px); }

  /* Mini player — pinned to LOWER HALF of the sun */
  .miniPlayer{
    position:absolute; left:50%; bottom:6%; transform:translateX(-50%);
    width:86%;
    background:rgba(5,10,22,.55); border:1px solid rgba(220,240,255,.35); border-radius:12px; padding:6px 8px;
    box-shadow:0 8px 20px rgba(0,0,0,.45);
    display:none; grid-template-columns:auto 1fr auto; gap:8px; align-items:center; font-size:12px; pointer-events:auto;
  }
  .miniPlayer.show{ display:grid; }
  .controls{ display:flex; gap:8px; }
  .btn{ width:28px; height:28px; border-radius:8px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); color:#eaf2ff; font-weight:900; display:grid; place-items:center; cursor:pointer; user-select:none; }
  .btn:active{ transform:translateY(1px); }
  .toggles{ display:flex; gap:8px; }
  .toggle{ padding:4px 8px; border-radius:999px; border:1px solid rgba(220,240,255,.35); background:rgba(12,24,40,.6); cursor:pointer; }
  .toggle.active{ background:rgba(40,140,255,.45); }
  .title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700; letter-spacing:.3px; }

  .miniRow{ grid-column:1 / -1; display:flex; align-items:center; gap:8px; margin-top:6px; }
  .range{ -webkit-appearance:none; width:100%; height:6px; background:rgba(200,230,255,.25); border-radius:999px; outline:none; }
  .range::-webkit-slider-thumb{ -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:#bfe2ff; border:1px solid #6fb7ff; }

  /* Orbit */
  .orbit{ position:absolute; inset:0; transform-origin:50% 50%; z-index:6; pointer-events:none; will-change: transform; }
  .carrier{ position:absolute; left:50%; top:50%; width:0; height:0; }
  .moon{
    position:absolute; left:0; top:0;
    transform: translate(var(--orbit-radius), -50%);
    width:var(--moon-size); height:var(--moon-size); border-radius:50%;
    cursor:pointer; pointer-events:auto; display:grid; place-items:center;
    background: radial-gradient(circle, rgba(160,210,255,.55) 0%, rgba(160,210,255,.25) 60%, rgba(160,210,255,0) 70%), center/cover no-repeat url('https://grandelement.github.io/website/images/ge-radio-logo.png');
    box-shadow:0 0 10px 4px rgba(140,200,255,.35); border:1px solid rgba(160,210,255,.55);
    will-change: transform;
  }

  /* About overlay */
  .overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:10; }
  .overlay.show{ display:grid; }
  .aboutText{ max-width:min(90vw, 820px); margin:0 16px; text-align:center; color:#eaf2ff; font-size:18px; line-height:1.6; text-shadow:0 0 16px rgba(150,190,255,.45),0 0 30px rgba(60,120,200,.25); }

  /* Planets layer */
  .planets{ position:fixed; inset:0; pointer-events:none; z-index:4; }
  .planet{ position:absolute; width:var(--planet-size); height:var(--planet-size); border-radius:50%; pointer-events:auto; overflow:hidden; cursor:grab;
           background:#32406b center/cover no-repeat; box-shadow:0 0 10px rgba(255,255,255,.2); transition: transform .2s ease, box-shadow .18s ease; }
  .planet.drag{ cursor:grabbing; }
  .planet:hover, .planet.touchZoom{ transform:scale(var(--planet-hover-scale)); box-shadow:0 0 var(--planet-glow) rgba(255,160,255,.65),0 0 2px 1px rgba(255,255,255,.25) inset; }
  .labelAlways{ position:absolute; left:50%; top:calc(100% + 8px); transform:translateX(-50%); padding:4px 8px; border-radius:999px; white-space:nowrap;
                 background:rgba(15,25,50,.35); border:1px solid rgba(200,220,255,.5); backdrop-filter:blur(2px); font-size:12px; letter-spacing:.3px; font-weight:700; }

  @media (max-width: 820px){
    .sunWrap{ left:22vw; top:72vh; }
    .miniPlayer{ width:92%; bottom:4%; font-size:11px; transform:translateX(-50%) scale(.86); }
    .labelAlways{ font-size:11px; top:calc(100% + 6px); }
  }
</style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="layer-hiddentext" id="phrases"></div>

  <div class="sunWrap" id="sunWrap">
    <div class="sun" id="sun" title="Drag me">
      <div class="sunOverlay">
        <div class="sunAbout" id="aboutBtn">ABOUT</div>
        <div class="controlsToggle" id="togglePanel">Music Controls</div>
        <div class="miniPlayer" id="mini">
          <div class="controls">
            <div class="btn" id="prev" title="Prev">◀</div>
            <div class="btn" id="play" title="Play/Pause">▶</div>
            <div class="btn" id="next" title="Next">▶▶</div>
          </div>
          <div class="title" id="title">—</div>
          <div class="toggles">
            <div class="toggle active" id="tgShuffle">Shuffle</div>
            <div class="toggle" id="tgAlbum">Album</div>
          </div>
          <audio id="gePlayer" preload="auto" playsinline></audio>
          <div class="miniRow">
            <input class="range" id="seek" type="range" min="0" max="100" value="0">
            <input class="range" id="vol"  type="range" min="0" max="1" step="0.02" value="0.9" style="width:90px;">
          </div>
        </div>
      </div>
    </div>
    <div class="orbit" id="orbit">
      <div class="carrier"><div class="moon" id="moon" title="Grand Element Radio"></div></div>
    </div>
  </div>

  <div class="planets" id="planets"></div>

  <div class="overlay" id="about">
    <div class="aboutText">
      Started the summer of 2005 in Las Vegas, Nevada. Experiments in sound and communication. A journey into the soul. Created with one vision: the listener is the "GRAND ELEMENT".
      Hypnotic rhythms and spacious soundscapes leave room for reflection, opening the body and soul to the voice of energy—reminding us that we are all one, all energy, and all love.
      <br><br>
      <a href="mailto:info@grandelement.com" style="color:#dff3ff; font-weight:800; text-decoration:none;">✉ Contact</a>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const IMG = 'https://grandelement.github.io/website/images/';
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]];}};
const MOBILE = /iPhone|Android/i.test(navigator.userAgent) || innerWidth < 700;

/* ---------- planets (S-curve, draggable, click-vs-drag safe, per-planet label + glow) ---------- */
const ALBUMS = [
  { t:"Fundamental\u00A0Groove", c:"Grand%20Element%20-%20Fundamental%20Groove.jpg", l:"https://grandelement.bandcamp.com/album/fundamental-groove", glow:"#ff6363" },
  { t:"Trio",        c:"Grand%20Element%20-%20Trio.jpg",        l:"https://grandelement.bandcamp.com/album/trio",        glow:"#ffd36e" },
  { t:"Live!",       c:"Grand%20Element%20-%20Live.jpg",        l:"https://grandelement.bandcamp.com/album/live",        glow:"#a0ff7a" },
  { t:"Sessions I",  c:"Grand%20Element%20-%20Sessions%20I.jpg",  l:"https://grandelement.bandcamp.com/album/sessions-i", glow:"#70e0ff" },
  { t:"Sessions II", c:"Grand%20Element%20-%20Sessions%20II.jpg", l:"https://grandelement.bandcamp.com/album/sessions-ii",glow:"#9ab0ff" },
  { t:"Intergy",     c:"Grand%20Element%20-%20Intergy.jpg",     l:"https://grandelement.bandcamp.com/album/intergy",     glow:"#b474ff" },
  { t:"Love",        c:"Grand%20Element%20-%20Love.jpg",        l:"https://grandelement.bandcamp.com/album/love",        glow:"#ff8ad1" },
  { t:"Soul",        c:"Grand%20Element%20-%20Soul.jpg",        l:"https://grandelement.bandcamp.com/album/soul",        glow:"#ffc18a" },
  { t:"Spirit",      c:"Grand%20Element%20-%20Spirit.jpg",      l:"https://grandelement.bandcamp.com/album/spirit",      glow:"#a6ffe1" },
  { t:"Fire",        c:"Grand%20Element%20-%20Fire.jpg",        l:"https://grandelement.bandcamp.com/album/fire",        glow:"#ff704d" }
];
const planetsEl=document.getElementById('planets');
function placeSpiral(){
  planetsEl.innerHTML="";
  const w=innerWidth,h=innerHeight, xCenter=w*0.56, yBottom=h*0.88, yTop=h*0.14, amp=Math.max(80,w*0.12), waves=1.2;
  ALBUMS.forEach((a,i)=>{
    const t=i/(ALBUMS.length-1), y=yBottom - t*(yBottom-yTop), x=xCenter + amp*Math.sin((t*Math.PI*2*waves)-Math.PI/2);
    const el=document.createElement('a');
    el.className='planet'; el.style.left=x+'px'; el.style.top=y+'px';
    el.href=a.l; el.target='_blank'; el.rel='noopener'; el.title=a.t;
    el.style.backgroundImage=`url('${IMG}${a.c}')`;
    el.style.boxShadow=`0 0 10px rgba(255,255,255,.25), 0 0 18px ${a.glow}77`;
    el.innerHTML=`<div class="labelAlways">${a.t}</div>`;
    planetsEl.appendChild(el);
  });
}
placeSpiral(); addEventListener('resize', placeSpiral, {passive:true});

/* click-vs-drag */
planetsEl.addEventListener('pointerdown', e=>{
  const a=e.target.closest('a.planet'); if(!a) return;
  const startX=e.clientX, startY=e.clientY; let moved=false;
  const rect=a.getBoundingClientRect(); const offX=startX-(rect.left+rect.width/2), offY=startY-(rect.top+rect.height/2);
  const move=ev=>{
    const dx=ev.clientX-startX, dy=ev.clientY-startY;
    if(!moved && Math.hypot(dx,dy)>6) moved=true;
    if(moved){ a.style.left=(rect.left+rect.width/2 + dx - offX)+'px'; a.style.top=(rect.top+rect.height/2 + dy - offY)+'px'; }
  };
  const up=ev=>{
    window.removeEventListener('pointermove', move);
    window.removeEventListener('pointerup', up);
    if(!moved){ window.open(a.href,'_blank','noopener'); }
  };
  window.addEventListener('pointermove',move);
  window.addEventListener('pointerup',up);
  e.preventDefault();
}, true);

/* ---------- hidden text ---------- */
const phrasesEl=document.getElementById('phrases');
let PHRASES=[];
fetch('https://grandelement.github.io/website/data/hidden.txt')
  .then(r=>r.ok?r.text():'')
  .then(t=>{
    PHRASES=t.split(/[,\r?\n]/).map(s=>s.trim().replace(/,+$/,'')).filter(Boolean);
    const n=Math.max(10,PHRASES.length||10);
    for(let i=0;i<n;i++){
      const el=document.createElement('div'); el.className='phrase';
      el.textContent=PHRASES[i%(PHRASES.length||1)]||'';
      el.style.left=(10+Math.random()*(innerWidth-220))+'px';
      el.style.top =(10+Math.random()*(innerHeight-120))+'px';
      el.addEventListener('click',()=>el.classList.toggle('pinned'));
      phrasesEl.appendChild(el);
    }
    startPhrasesTimer();
  });
let mouseX=-9999,mouseY=-9999; addEventListener('pointermove',e=>{mouseX=e.clientX; mouseY=e.clientY;},{passive:true});
let _phrasesTimer=null;
function startPhrasesTimer(){ if(_phrasesTimer) return; _phrasesTimer=setInterval(()=>{
  const r=Math.min(innerWidth,innerHeight)*.12;
  [...phrasesEl.children].forEach(el=>{
    if(el.classList.contains('pinned')){el.classList.add('show'); return;}
    const b=el.getBoundingClientRect(), cx=b.left+b.width/2, cy=b.top+b.height/2;
    (Math.hypot(mouseX-cx, mouseY-cy)<r) ? el.classList.add('show') : el.classList.remove('show');
  });
},120);}
function stopPhrasesTimer(){ if(_phrasesTimer){ clearInterval(_phrasesTimer); _phrasesTimer=null; }}

/* ---------- about ---------- */
const aboutBtn=document.getElementById('aboutBtn'), aboutEl=document.getElementById('about');
aboutBtn.addEventListener('click',()=>aboutEl.classList.add('show'));
aboutEl.addEventListener('click',e=>{ if(e.target.id==='about') aboutEl.classList.remove('show'); });
addEventListener('keydown',e=>{ if(e.key==='Escape') aboutEl.classList.remove('show'); });

/* ---------- sun drag ---------- */
const sunWrap=document.getElementById('sunWrap'), sun=document.getElementById('sun');
let sDrag=false,sx=0,sy=0,ox=0,oy=0;
sun.addEventListener('pointerdown',e=>{
  const r=sunWrap.getBoundingClientRect(); sDrag=true; sun.classList.add('dragging');
  sx=e.clientX; sy=e.clientY; ox=r.left+r.width/2; oy=r.top+r.height/2; sun.setPointerCapture(e.pointerId);
});
sun.addEventListener('pointermove',e=>{
  if(!sDrag) return; const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy);
  sunWrap.style.left=clamp(nx,100,innerWidth-100)+'px';
  sunWrap.style.top =clamp(ny,100,innerHeight-100)+'px';
});
sun.addEventListener('pointerup',()=>{ sDrag=false; sun.classList.remove('dragging'); });

/* ---------- moon orbit (60s, upright, behind far side) ---------- */
const orbit=document.getElementById('orbit'), moon=document.getElementById('moon');
const ORBIT_SEC=60, PHASE0=-Math.PI/2;
function tickOrbit(){
  const t=performance.now()/1000, angle=PHASE0 + (t%ORBIT_SEC)/ORBIT_SEC*Math.PI*2;
  orbit.style.transform=`rotate(${angle}rad)`;
  moon.style.transform=`translate(var(--orbit-radius), -50%) rotate(${-angle}rad)`;
  orbit.style.zIndex=(angle%(Math.PI*2))>Math.PI?2:6;
  requestAnimationFrame(tickOrbit);
}
requestAnimationFrame(tickOrbit);
moon.addEventListener('click',()=>window.open('https://grandelement.github.io/radio/','_blank','noopener'));

/* ---------- music (playlist.txt → fallback scan) + controls toggle (fixed) ---------- */
const PLAYER=document.getElementById('gePlayer');
const titleEl=document.getElementById('title');
const prevBtn=document.getElementById('prev'), playBtn=document.getElementById('play'), nextBtn=document.getElementById('next');
const tgShuffle=document.getElementById('tgShuffle'), tgAlbum=document.getElementById('tgAlbum');
const seek=document.getElementById('seek'), vol=document.getElementById('vol');
const togglePanel=document.getElementById('togglePanel'), mini=document.getElementById('mini');
togglePanel.addEventListener('click', ()=> mini.classList.toggle('show')); // <-- open/close works

let PLAYLIST=[], pIndex=0, SHUFFLE=true, USER_STARTED=false;

function setTitleFromURL(u){
  try{
    const parts=u.split('/'); const fn=decodeURIComponent(parts.pop());
    const album=decodeURIComponent(parts.pop()).replace(/^Grand Element\\s*-\\s*\\d{4}\\s*-\\s*/,'');
    const name=fn.replace(/\\.[^.]+$/,'').replace(/^\\s*\\d+\\s*[-_.]?\\s*/,'').replace(/[_-]/g,' ');
    titleEl.textContent=`${album} · ${name}`;
  }catch(e){ titleEl.textContent='—'; }
}
function loadAndPlay(i=pIndex){
  if(!PLAYLIST.length) return;
  pIndex=(i+PLAYLIST.length)%PLAYLIST.length;
  const src=PLAYLIST[pIndex];
  if(PLAYER.src!==src){ PLAYER.src=src; PLAYER.load(); }
  setTitleFromURL(src);
  if(USER_STARTED){ PLAYER.play().catch(()=>{}); playBtn.textContent='❚❚'; }
}
function next(){ if(!PLAYLIST.length) return; pIndex=(pIndex+1)%PLAYLIST.length; loadAndPlay(); }
function prev(){ if(!PLAYLIST.length) return; pIndex=(pIndex-1+PLAYLIST.length)%PLAYLIST.length; loadAndPlay(); }

playBtn.onclick=()=>{ USER_STARTED=true; if(PLAYER.paused){ PLAYER.play().catch(()=>{}); playBtn.textContent='❚❚'; } else { PLAYER.pause(); playBtn.textContent='▶'; } };
nextBtn.onclick=()=>{ USER_STARTED=true; next(); };
prevBtn.onclick=()=>{ USER_STARTED=true; prev(); };

tgShuffle.onclick=()=>{ SHUFFLE=true; tgShuffle.classList.add('active'); tgAlbum.classList.remove('active');
  if(PLAYLIST.length){ PLAYLIST=[...PLAYLIST].sort(); shuffle(PLAYLIST); pIndex=0; loadAndPlay(); } };
tgAlbum.onclick=()=>{ SHUFFLE=false; tgAlbum.classList.add('active'); tgShuffle.classList.remove('active'); pIndex=0; loadAndPlay(); };

vol.addEventListener('input', ()=>{ PLAYER.volume=parseFloat(vol.value||'0.9'); });
PLAYER.addEventListener('timeupdate', ()=>{ if(!isNaN(PLAYER.duration)&&PLAYER.duration>0) seek.value=Math.round((PLAYER.currentTime/PLAYER.duration)*100); });
seek.addEventListener('input', ()=>{ if(!isNaN(PLAYER.duration)&&PLAYER.duration>0) PLAYER.currentTime=(parseFloat(seek.value)/100)*PLAYER.duration; });
PLAYER.addEventListener('ended', next);
PLAYER.addEventListener('error', next);
function unmuteOnce(){ PLAYER.muted=false; USER_STARTED=true; if(PLAYER.paused) PLAYER.play().catch(()=>{}); window.removeEventListener('pointerdown', unmuteOnce, {capture:true}); }
window.addEventListener('pointerdown', unmuteOnce, {capture:true, once:true});

(async function loadPlaylist(){
  try{
    const r=await fetch('https://grandelement.github.io/radio/music/playlist.txt');
    if(r.ok){
      const t=await r.text();
      let items=t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
        .map(name=> name.startsWith('http')?name:`https://grandelement.github.io/radio/music/${encodeURIComponent(name)}`);
      if(items.length){ if(SHUFFLE) shuffle(items); PLAYLIST=items; pIndex=0; return loadAndPlay(); }
    }
  }catch(e){}
  try{
    const r=await fetch('https://api.github.com/repos/grandelement/radio/git/trees/main?recursive=1',{headers:{'Accept':'application/vnd.github+json'}});
    if(!r.ok) throw 0; const data=await r.json();
    let items=(data.tree||[]).filter(n=>n.type==='blob' && /\.mp3$/i.test(n.path)).map(n=>`https://grandelement.github.io/radio/${encodeURI(n.path)}`);
    if(items.length){ if(SHUFFLE) shuffle(items); PLAYLIST=items; pIndex=0; loadAndPlay(); }
    else titleEl.textContent='No music found';
  }catch(e){ titleEl.textContent='No music found'; }
})();

/* ---------- canvas FX (comets + ships) with centered beam, attraction + ricochet + obstacles ---------- */
const canvas=document.getElementById('fx'), ctx=canvas.getContext('2d');
let W=innerWidth,H=innerHeight; const DPR=Math.min(1.5, window.devicePixelRatio||1);
function resize(){ W=innerWidth; H=innerHeight; canvas.width=Math.round(W*DPR); canvas.height=Math.round(H*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); }
addEventListener('resize',resize,{passive:true}); resize();
const rand=(a,b)=>Math.random()*(b-a)+a, choice=a=>a[(Math.random()*a.length)|0];

const cometImg=new Image(); cometImg.src=IMG+'ge-logo%203.png';
const shipImg =new Image(); shipImg .src=IMG+'ge-logo-4-cutout.png';

const COMET={sizes:[8,10,12,16], max:parseInt(getComputedStyle(document.documentElement).getPropertyValue('--comet-max'))||3, spawn:[4,9], speed:[60,140], trail:100, fade:1200, touch:26, mass:1};

class Comet{
  constructor(){
    const edge=choice(['l','r','t','b']), pad=40;
    if(edge==='l'){this.x=-pad; this.y=rand(0,H);} if(edge==='r'){this.x=W+pad; this.y=rand(0,H);}
    if(edge==='t'){this.x=rand(0,W); this.y=-pad;} if(edge==='b'){this.x=rand(0,W); this.y=H+pad;}
    const tx=rand(W*.2,W*.8), ty=rand(H*.2,H*.8), a=Math.atan2(ty-this.y, tx-this.x), s=rand(...COMET.speed);
    this.vx=Math.cos(a)*s; this.vy=Math.sin(a)*s; this.r=choice(COMET.sizes); this.trail=[]; this.dead=false;
  }
  step(dt){ this.x+=this.vx*dt; this.y+=this.vy*dt; this.trail.push([this.x,this.y,performance.now()]); if(this.trail.length>COMET.trail) this.trail.shift();
            if(this.x<-120||this.x>W+120||this.y<-120||this.y>H+120) this.dead=true; }
  draw(){ for(const [tx,ty,ts] of this.trail){ const a=Math.max(0,1-(performance.now()-ts)/COMET.fade); if(a<=0) continue; ctx.globalAlpha=a*.6; ctx.drawImage(cometImg,tx-this.r,ty-this.r,this.r*2,this.r*2);} ctx.globalAlpha=1; ctx.drawImage(cometImg,this.x-this.r,this.y-this.r,this.r*2,this.r*2); }
}

const SHIP_ART_OFFSET=Math.PI;
class Ship{
  constructor(){
    const side=choice(['l','r','t','b']); this.s=choice(MOBILE?[0.08,0.12,0.16,0.20]:[0.10,0.14,0.19,0.22,0.26]);
    const pad=60;
    if(side==='l'){this.x=-pad; this.y=rand(0,H); this.vx=rand(80,220); this.vy=rand(-80,80);}
    if(side==='r'){this.x=W+pad; this.y=rand(0,H); this.vx=-rand(80,220); this.vy=rand(-80,80);}
    if(side==='t'){this.x=rand(0,W); this.y=-pad; this.vx=rand(-180,180); this.vy=rand(80,220);}
    if(side==='b'){this.x=rand(0,W); this.y=H+pad; this.vx=rand(-180,180); this.vy=-rand(80,220);}
    this.beam=0; this.dead=false; this.waveT=rand(220,320);
  }
  step(dt){
    this.x+=this.vx*dt; this.y+=this.vy*dt;
    if(this.x<-160||this.x>W+160||this.y<-160||this.y>H+160) this.dead=true;

    /* blue “audio” beam attraction toward closest pair */
    let bestA=null,bestB=null,bestDist=1e9;
    for(let i=0;i<comets.length;i++) for(let j=i+1;j<comets.length;j++){
      const a=comets[i], b=comets[j];
      const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
      const d=Math.hypot(mx-this.x,my-this.y);
      if(d<bestDist){bestDist=d; bestA=a; bestB=b;}
    }
    if(bestA && bestB && bestDist<240){
      this.beam = Math.min(1.6, this.beam+dt);
      const mx=(bestA.x+bestB.x)/2, my=(bestA.y+bestB.y)/2;
      const ax=(mx-bestA.x), ay=(my-bestA.y), bx=(mx-bestB.x), by=(my-bestB.y);
      const pull=60; bestA.vx+=ax*pull*dt; bestA.vy+=ay*pull*dt; bestB.vx+=bx*pull*dt; bestB.vy+=by*pull*dt;
    }else{
      this.beam = Math.max(0,this.beam-dt*0.8);
    }
  }
  draw(){
    if(!shipImg.complete) return;
    const ang=Math.atan2(this.vy,this.vx)+SHIP_ART_OFFSET;
    const w=shipImg.width*this.s, h=shipImg.height*this.s;
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(ang);
    ctx.drawImage(shipImg,-w*.3,-h*.5,w*.6,h*.6);
    /* centered wavy beam projecting forward */
    if(this.beam>0){
      const len=220;
      ctx.strokeStyle='rgba(126,203,255,.95)';
      ctx.lineWidth=2;
      ctx.beginPath();
      for(let i=0;i<=len;i+=6){
        const dy=Math.sin((i/len)*Math.PI*4 + performance.now()/this.waveT)*8;
        if(i===0) ctx.moveTo(w*.25+i, dy);
        else ctx.lineTo(w*.25+i, dy);
      }
      ctx.stroke();
    }
    ctx.restore();
  }
}

const comets=[], ships=[];
let last=performance.now()/1000, cTimer=0, cNext=rand(4,9), shipTimer=0, shipNext=rand(6,12);
let _spawnEnabled=true, _lastActive=Date.now();
['pointerdown','pointermove','keydown','touchstart'].forEach(evt=>addEventListener(evt,()=>{_lastActive=Date.now();},{passive:true}));
document.addEventListener('visibilitychange',()=>{ const h=document.hidden; _spawnEnabled=!h; if(h) stopPhrasesTimer(); else startPhrasesTimer(); });

/* obstacles (sun, moon, planets) for ricochet */
function getSunCircle(){ const r=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sun-size'))/2; const rect=sunWrap.getBoundingClientRect(); return {x:rect.left+rect.width/2, y:rect.top+rect.height/2, r:r}; }
function getMoonCircle(){ const rect=moon.getBoundingClientRect(); return {x:rect.left+rect.width/2, y:rect.top+rect.height/2, r:rect.width/2}; }
function getPlanetCircles(){ return [...document.querySelectorAll('.planet')].map(p=>{ const r=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--planet-size'))/2; const b=p.getBoundingClientRect(); return {x:b.left+r, y:b.top+r, r:r}; }); }

/* elastic collision between two comets */
function collide(a,b){
  const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy) || 1;
  const nx=dx/dist, ny=dy/dist; // normal
  const tx=-ny, ty=nx;          // tangent
  const dpTanA = a.vx*tx + a.vy*ty;
  const dpTanB = b.vx*tx + b.vy*ty;
  const dpNormA = a.vx*nx + a.vy*ny;
  const dpNormB = b.vx*nx + b.vy*ny;
  // equal mass 1D swap on normal
  const mA=dpNormB, mB=dpNormA;
  a.vx = tx*dpTanA + nx*mA; a.vy = ty*dpTanA + ny*mA;
  b.vx = tx*dpTanB + nx*mB; b.vy = ty*dpTanB + ny*mB;
  // separate to avoid overlap
  const overlap=(a.r+b.r - dist);
  if(overlap>0){ a.x -= nx*(overlap/2); a.y -= ny*(overlap/2); b.x += nx*(overlap/2); b.y += ny*(overlap/2); }
}

/* ricochet against a circle obstacle */
function bounceCircle(circ,c){
  const dx=c.x-circ.x, dy=c.y-circ.y, dist=Math.hypot(dx,dy);
  const minDist=circ.r + c.r;
  if(dist<minDist){
    const nx=dx/(dist||1), ny=dy/(dist||1);
    // push out
    const overlap=minDist-dist;
    c.x += nx*overlap;
    c.y += ny*overlap;
    // reflect velocity
    const vdot = c.vx*nx + c.vy*ny;
    c.vx -= 2*vdot*nx;
    c.vy -= 2*vdot*ny;
  }
}

/* orbit-around-ship if near (soft capture) */
function softOrbit(ship, c, dt){
  const dx=ship.x-c.x, dy=ship.y-c.y, d=Math.hypot(dx,dy);
  if(d<120){
    const ang=Math.atan2(c.y-ship.y, c.x-ship.x) + 1.2*dt;
    const R = Math.max(40, d);
    c.x = ship.x + Math.cos(ang)*R;
    c.y = ship.y + Math.sin(ang)*R;
  }
}

/* main loop */
function loop(){
  const now=performance.now()/1000, dt=Math.min(.05, now-last); last=now;
  const idleSec=(Date.now()-_lastActive)/1000, powerSave=idleSec>120;
  const maxComets=powerSave?1:(COMET.max||3), wantShips=powerSave?2:4;

  cTimer+=dt; if(_spawnEnabled && cTimer>cNext && comets.length<maxComets){ comets.push(new Comet()); cTimer=0; cNext=rand(4,9); }
  shipTimer+=dt; if(_spawnEnabled && shipTimer>shipNext){ shipTimer=0; shipNext=powerSave?rand(10,18):rand(6,14); if(ships.length<wantShips) ships.push(new Ship()); }

  comets.forEach(c=>c.step(dt)); ships.forEach(s=>s.step(dt));

  /* comet↔comet collisions (elastic) */
  for(let i=0;i<comets.length;i++)for(let j=i+1;j<comets.length;j++){
    const a=comets[i], b=comets[j];
    if(Math.hypot(a.x-b.x,a.y-b.y) < a.r+b.r) collide(a,b);
  }

  /* ricochet off sun, moon, planets */
  const sunC=getSunCircle(), moonC=getMoonCircle(), planetC=getPlanetCircles();
  comets.forEach(c=>{
    bounceCircle(sunC,c);
    bounceCircle(moonC,c);
    for(const pc of planetC) bounceCircle(pc,c);
  });

  /* ship soft orbit + beam handled in ship.step */
  ships.forEach(s=>comets.forEach(c=>softOrbit(s,c,dt)));

  /* cleanup */
  for(let i=comets.length-1;i>=0;i--) if(comets[i].dead) comets.splice(i,1);
  for(let i=ships.length-1;i>=0;i--) if(ships[i].dead) ships.splice(i,1);

  /* draw */
  ctx.clearRect(0,0,W,H);
  comets.forEach(c=>c.draw());
  ships.forEach(s=>s.draw());

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* grab & fling comets */
let grab=null,lastPts=[];
canvas.addEventListener('pointerdown',e=>{
  const x=e.clientX,y=e.clientY; let best=null,bd=1e9;
  for(const c of comets){ const d=Math.hypot(x-c.x,y-c.y); if(d<Math.max(26,c.r*1.6) && d<bd){bd=d; best=c;} }
  if(best){ grab=best; lastPts.length=0; }
});
canvas.addEventListener('pointermove',e=>{
  if(!grab) return; grab.x=e.clientX; grab.y=e.clientY; lastPts.push([e.clientX,e.clientY,performance.now()]); if(lastPts.length>5) lastPts.shift();
});
canvas.addEventListener('pointerup',()=>{
  if(!grab) return;
  if(lastPts.length>=2){
    const a=lastPts[0], b=lastPts[lastPts.length-1]; const dt=(b[2]-a[2])/1000||.016;
    grab.vx=(b[0]-a[0])/dt; grab.vy=(b[1]-a[1])/dt;
  }
  grab=null; lastPts.length=0;
});

/* keep sun from clipping left side */
function nudgeSun(){ const r=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--orbit-radius'))||260; const rect=sunWrap.getBoundingClientRect(); if(rect.left<r+90) sunWrap.style.left=(r+120)+'px'; }
addEventListener('resize', nudgeSun, {passive:true}); nudgeSun();

/* minimal debug */
window.addEventListener('error', e=>console.log('[GE DEBUG]', e.message));
</script>
</body>
</html>
